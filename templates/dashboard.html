{% extends "base.html" %}

{% block title %}Dezy - Gold Price Dashboard{% endblock %}

{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8 py-6">
    <!-- Header Stats -->
    <div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-6">
        <div class="stat-card">
            <h3 class="stat-card__label">Sistem Uptime</h3>
            <p class="stat-card__value" id="uptime">-</p>
        </div>
        <div class="stat-card">
            <h3 class="stat-card__label">Toplam Kayıt</h3>
            <p class="stat-card__value" id="total-records">-</p>
        </div>
        <div class="stat-card">
            <h3 class="stat-card__label">Bugünkü Sinyal</h3>
            <p class="stat-card__value" id="today-signals">-</p>
        </div>
        <div class="stat-card">
            <h3 class="stat-card__label">WebSocket</h3>
            <p class="d-flex items-center gap-sm">
                <span class="nav__status-dot bg-error" id="ws-status"></span>
                <span id="status-text">Bağlanıyor...</span>
            </p>
        </div>
    </div>

    <!-- Current Prices -->
    <div class="glass-card rounded-lg p-4 sm:p-6 mb-6">
        <div class="glass-card__header">
            <h2 class="glass-card__title text-lg sm:text-xl">
                <i class="fas fa-coins text-yellow-400"></i>
                Anlık Fiyatlar
            </h2>
        </div>
        <div class="glass-card__body">
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                <div class="price-card price-card--gold">
                    <span class="price-card__label">Gram Altın</span>
                    <div class="price-card__value" id="gram-altin">-</div>
                    <div class="price-card__change" id="gram-change">
                        <span>-</span>
                    </div>
                    <i class="fas fa-coins price-card__icon"></i>
                </div>
                <div class="price-card price-card--blue">
                    <span class="price-card__label">ONS/USD</span>
                    <div class="price-card__value" id="ons-usd">-</div>
                    <div class="price-card__change" id="ons-change">
                        <span>-</span>
                    </div>
                    <i class="fas fa-globe price-card__icon"></i>
                </div>
                <div class="price-card price-card--green">
                    <span class="price-card__label">USD/TRY</span>
                    <div class="price-card__value" id="usd-try">-</div>
                    <div class="price-card__change" id="usd-change">
                        <span>-</span>
                    </div>
                    <i class="fas fa-dollar-sign price-card__icon"></i>
                </div>
                <div class="price-card price-card--purple">
                    <span class="price-card__label">ONS/TRY</span>
                    <div class="price-card__value" id="ons-try">-</div>
                    <div class="price-card__change" id="ons-try-change">
                        <span>-</span>
                    </div>
                    <i class="fas fa-lira-sign price-card__icon"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Alerts - Kompakt ve Modern -->
    <div class="mb-6" id="active-alerts-container" style="display: none;">
        <div id="alerts-list" class="space-y-3">
            <!-- Dinamik olarak doldurulacak -->
        </div>
    </div>

    <!-- Market Overview Widget -->
    <div class="glass-card rounded-lg p-4 sm:p-6 mb-6">
        <div class="glass-card__header">
            <h2 class="glass-card__title text-lg sm:text-xl">
                <i class="fas fa-chart-line text-blue-400"></i>
                Piyasa Özeti
            </h2>
        </div>
        <div class="glass-card__body">
            <div class="grid grid-cols-3 gap-3 sm:gap-4" id="market-overview-widget">
                <div class="text-center">
                    <p class="text-xs text-gray-400 mb-1">Gram Altın</p>
                    <p class="text-xl font-bold" id="mo-gram-price">-</p>
                    <p class="text-sm" id="mo-gram-change">-</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-400 mb-1">ONS/USD</p>
                    <p class="text-xl font-bold" id="mo-ons-price">-</p>
                    <p class="text-sm" id="mo-ons-change">-</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-400 mb-1">USD/TRY</p>
                    <p class="text-xl font-bold" id="mo-usd-price">-</p>
                    <p class="text-sm" id="mo-usd-change">-</p>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-700">
                <div class="grid grid-cols-2 gap-3 sm:gap-4">
                    <div>
                        <span class="text-xs text-gray-400">Güncel Trend:</span>
                        <span class="ml-2 font-semibold" id="mo-trend">-</span>
                    </div>
                    <div>
                        <span class="text-xs text-gray-400">Kur Riski:</span>
                        <span class="ml-2 font-semibold" id="mo-risk">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Market Overview & Quick Indicators -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <!-- Market Overview -->
        <div class="glass-card rounded-lg p-4">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="fas fa-chart-pie text-purple-400"></i>
                Piyasa Durumu
            </h2>
            <div class="flex justify-between items-center py-2 border-b border-gray-700">
                <span class="text-sm text-gray-400">Genel Görünüm</span>
                <span class="font-semibold" id="market-overview">-</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-gray-700">
                <span class="text-sm text-gray-400">Volatilite</span>
                <span class="font-semibold" id="market-volatility">-</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-gray-700">
                <span class="text-sm text-gray-400">24s En Yüksek</span>
                <span class="font-semibold text-green-400" id="daily-high">-</span>
            </div>
            <div class="flex justify-between items-center py-2">
                <span class="text-sm text-gray-400">24s En Düşük</span>
                <span class="font-semibold text-red-400" id="daily-low">-</span>
            </div>
        </div>

        <!-- Technical Indicators - Gram Altın -->
        <div class="glass-card rounded-lg p-4">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="fas fa-tachometer-alt text-yellow-400"></i>
                Gram Altın Göstergeleri
            </h2>
            <div class="market-overview__item">
                <span class="market-overview__label">RSI (14)</span>
                <span class="market-overview__value" id="rsi-value">-</span>
            </div>
            <div class="market-overview__item">
                <span class="market-overview__label">MACD</span>
                <span class="market-overview__value" id="macd-signal">-</span>
            </div>
            <div class="market-overview__item">
                <span class="market-overview__label">Bollinger</span>
                <span class="market-overview__value" id="bb-position">-</span>
            </div>
            <div class="market-overview__item">
                <span class="market-overview__label">Stochastic</span>
                <span class="market-overview__value" id="stoch-value">-</span>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="glass-card">
            <div class="glass-card__body">
                <h2 class="glass-card__title mb-md">
                    <i class="fas fa-bolt text-yellow"></i>
                    Hızlı İşlemler
                </h2>
                <div class="quick-actions">
                    <button onclick="runQuickAnalysis('1h')" class="quick-actions__button quick-actions__button--analyze">
                        <i class="fas fa-sync-alt"></i> 1S Analiz Yenile
                    </button>
                    <button onclick="runQuickAnalysis('4h')" class="quick-actions__button quick-actions__button--analyze">
                        <i class="fas fa-sync-alt"></i> 4S Analiz Yenile
                    </button>
                    <button onclick="exportData()" class="quick-actions__button quick-actions__button--export">
                        <i class="fas fa-download"></i> Veri İndir
                    </button>
                    <a href="/analysis" class="quick-actions__button quick-actions__button--details">
                        <i class="fas fa-chart-bar"></i> Detaylı Analiz
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Advanced Indicators -->
        <div class="market-overview">
            <h2 class="market-overview__title">
                <i class="fas fa-chart-mixed text-info"></i>
                İleri Göstergeler
            </h2>
            <div class="market-overview__item">
                <span class="market-overview__label">CCI</span>
                <span class="market-overview__value" id="cci-value">-</span>
            </div>
            <div class="market-overview__item">
                <span class="market-overview__label">MFI</span>
                <span class="market-overview__value" id="mfi-value">-</span>
            </div>
            <div class="market-overview__item">
                <span class="market-overview__label">Pattern</span>
                <span class="market-overview__value" id="pattern-name">-</span>
            </div>
            <div class="market-overview__item">
                <span class="market-overview__label">Trend Gücü</span>
                <span class="market-overview__value" id="trend-strength">-</span>
            </div>
        </div>
    </div>
    
    <!-- ONS/USD Technical Indicators & Strategy Weights -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
        <!-- ONS/USD Indicators -->
        <div class="glass-card rounded-lg p-4">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="fas fa-globe text-blue-400"></i>
                ONS/USD Göstergeleri
            </h2>
            <div class="market-overview__item">
                <span class="market-overview__label">RSI (14)</span>
                <span class="market-overview__value" id="ons-rsi-value">-</span>
            </div>
            <div class="market-overview__item">
                <span class="market-overview__label">MACD</span>
                <span class="market-overview__value" id="ons-macd-signal">-</span>
            </div>
            <div class="market-overview__item">
                <span class="market-overview__label">Stochastic</span>
                <span class="market-overview__value" id="ons-stoch-value">-</span>
            </div>
            <div class="market-overview__item">
                <span class="market-overview__label">Trend</span>
                <span class="market-overview__value" id="ons-trend">-</span>
            </div>
        </div>
        
        <!-- Strategy Weights -->
        <div class="glass-card rounded-lg p-4">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="fas fa-balance-scale text-purple-400"></i>
                Strateji Ağırlıkları
            </h2>
            <div class="space-y-2">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-400">Global Trend</span>
                    <div class="flex items-center gap-2">
                        <div class="w-32 bg-gray-700 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full" style="width: 40%"></div>
                        </div>
                        <span class="text-xs text-blue-400 font-semibold">40%</span>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-400">Gram Analizi</span>
                    <div class="flex items-center gap-2">
                        <div class="w-32 bg-gray-700 rounded-full h-2">
                            <div class="bg-yellow-500 h-2 rounded-full" style="width: 30%"></div>
                        </div>
                        <span class="text-xs text-yellow-400 font-semibold">30%</span>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-400">İleri Göstergeler</span>
                    <div class="flex items-center gap-2">
                        <div class="w-32 bg-gray-700 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full" style="width: 15%"></div>
                        </div>
                        <span class="text-xs text-green-400 font-semibold">15%</span>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-400">Pattern Tanıma</span>
                    <div class="flex items-center gap-2">
                        <div class="w-32 bg-gray-700 rounded-full h-2">
                            <div class="bg-purple-500 h-2 rounded-full" style="width: 10%"></div>
                        </div>
                        <span class="text-xs text-purple-400 font-semibold">10%</span>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-400">Kur Riski</span>
                    <div class="flex items-center gap-2">
                        <div class="w-32 bg-gray-700 rounded-full h-2">
                            <div class="bg-red-500 h-2 rounded-full" style="width: 5%"></div>
                        </div>
                        <span class="text-xs text-red-400 font-semibold">5%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="chart-grid chart-grid--2cols mb-lg">
        <!-- Price Chart -->
        <div class="chart-container">
            <div class="chart-container__header">
                <h2 class="chart-container__title">
                    <i class="fas fa-chart-line text-info"></i>
                    Son 30 Dakika - Gram Altın
                </h2>
            </div>
            <div class="chart-wrapper chart-height-lg">
                <canvas id="priceChart" class="chart-canvas"></canvas>
            </div>
        </div>
        
        <!-- Candle Chart -->
        <div class="chart-container">
            <div class="chart-container__header">
                <h2 class="chart-container__title">
                    <i class="fas fa-chart-area text-success"></i>
                    Gram Altın OHLC
                </h2>
                <div class="chart-container__controls">
                    <button onclick="loadGramCandles('1h', this)" class="chart-container__button candle-btn">1S</button>
                    <button onclick="loadGramCandles('4h', this)" class="chart-container__button candle-btn">4S</button>
                    <button onclick="loadGramCandles('1d', this)" class="chart-container__button candle-btn">1G</button>
                </div>
            </div>
            <div id="candleChart" class="candle-chart chart-height-lg"></div>
        </div>
    </div>

    <!-- Compact Hybrid Analysis -->
    <div class="glass-card mb-lg">
        <div class="glass-card__header">
            <h2 class="glass-card__title text-lg">
                <i class="fas fa-bullseye text-yellow"></i>
                Son Hibrit Analiz (1h, 4h, Günlük)
            </h2>
        </div>
        <div class="glass-card__body py-md">
            <div id="hybrid-analysis-container" class="compact-analysis">
                <p class="text-muted text-sm">Yükleniyor...</p>
            </div>
        </div>
    </div>
    
    <!-- Hybrid Analysis History -->
    <div class="glass-card mb-lg">
        <div class="glass-card__header d-flex justify-between items-center">
            <h2 class="glass-card__title">
                <i class="fas fa-history text-purple"></i>
                Hibrit Analiz Geçmişi
            </h2>
            <div class="d-flex items-center gap-md">
                <!-- Timeframe Filter -->
                <select id="hybrid-timeframe-filter" class="bg-slate-700 text-white px-3 py-1 rounded text-sm">
                    <option value="">Tüm Timeframe</option>
                    <option value="1h">1 Saat</option>
                    <option value="4h">4 Saat</option>
                    <option value="1d">Günlük</option>
                </select>
                <a href="/analysis" class="text-xs text-muted hover:text-yellow transition-colors">
                    Detaylı Analiz →
                </a>
            </div>
        </div>
        <div class="glass-card__body">
            <style>
                /* Timeframe renkleri - Dashboard için */
                .hybrid-tf-15m {
                    background-color: rgba(59, 130, 246, 0.15);
                    border-left: 3px solid rgb(59, 130, 246);
                }
                .hybrid-tf-1h {
                    background-color: rgba(16, 185, 129, 0.15);
                    border-left: 3px solid rgb(16, 185, 129);
                }
                .hybrid-tf-4h {
                    background-color: rgba(217, 70, 239, 0.15);
                    border-left: 3px solid rgb(217, 70, 239);
                }
                .hybrid-tf-1d {
                    background-color: rgba(251, 146, 60, 0.15);
                    border-left: 3px solid rgb(251, 146, 60);
                }
                .hybrid-tf-badge {
                    padding: 2px 8px;
                    border-radius: 4px;
                    font-weight: 600;
                    font-size: 0.75rem;
                }
                .badge-15m { background-color: rgb(59, 130, 246); color: white; }
                .badge-1h { background-color: rgb(16, 185, 129); color: white; }
                .badge-4h { background-color: rgb(217, 70, 239); color: white; }
                .badge-1d { background-color: rgb(251, 146, 60); color: white; }
            </style>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-gray-700">
                            <th class="text-left py-2">Zaman</th>
                            <th class="text-left py-2">TF</th>
                            <th class="text-left py-2">Fiyat</th>
                            <th class="text-left py-2">Sinyal</th>
                            <th class="text-left py-2">Güven</th>
                            <th class="text-left py-2 hidden sm:table-cell">Trend</th>
                            <th class="text-left py-2 hidden md:table-cell">Risk</th>
                        </tr>
                    </thead>
                    <tbody id="hybrid-history-table">
                        <tr>
                            <td colspan="7" class="text-center py-4 text-gray-400">
                                <i class="fas fa-spinner fa-spin"></i> Yükleniyor...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Signals -->
    <div class="glass-card mb-lg">
        <div class="glass-card__header d-flex justify-between items-center">
            <h2 class="glass-card__title">
                <i class="fas fa-bell text-yellow"></i>
                Son Trading Sinyalleri
            </h2>
            <a href="/signals" class="text-xs text-muted hover:text-yellow transition-colors">
                Tümünü Gör →
            </a>
        </div>
        <div class="glass-card__body">
            <div id="signals-container" class="signals-container custom-scrollbar">
                <div class="text-center py-lg">
                    <i class="fas fa-spinner animate-rotate text-2xl text-muted"></i>
                    <p class="text-muted text-sm mt-sm">Yükleniyor...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="glass-card mb-lg">
        <div class="glass-card__header">
            <h2 class="glass-card__title">
                <i class="fas fa-tachometer-alt text-info"></i>
                Trading Performansı
            </h2>
        </div>
        <div class="glass-card__body">
            <div class="grid grid--cols-4">
                <div class="stat-card" id="daily-perf-card">
                    <h3 class="stat-card__label">24 Saat <i class="fas fa-info-circle text-xs text-gray-400 ml-1" title="Son 24 saatlik trading performansı"></i></h3>
                    <p class="stat-card__value" id="daily-winrate">-</p>
                    <p class="stat-card__change" id="daily-trades">-</p>
                    <p class="stat-card__detail" id="daily-pnl">-</p>
                </div>
                <div class="stat-card" id="weekly-perf-card">
                    <h3 class="stat-card__label">7 Gün <i class="fas fa-info-circle text-xs text-gray-400 ml-1" title="Son 7 günlük trading performansı"></i></h3>
                    <p class="stat-card__value" id="weekly-winrate">-</p>
                    <p class="stat-card__change" id="weekly-trades">-</p>
                    <p class="stat-card__detail" id="weekly-pnl">-</p>
                </div>
                <div class="stat-card" id="monthly-perf-card">
                    <h3 class="stat-card__label">30 Gün <i class="fas fa-info-circle text-xs text-gray-400 ml-1" title="Son 30 günlük trading performansı"></i></h3>
                    <p class="stat-card__value" id="monthly-winrate">-</p>
                    <p class="stat-card__change" id="monthly-trades">-</p>
                    <p class="stat-card__detail" id="monthly-pnl">-</p>
                </div>
                <div class="stat-card" id="best-tf-card">
                    <h3 class="stat-card__label">En İyi TF <i class="fas fa-info-circle text-xs text-gray-400 ml-1" title="En başarılı timeframe"></i></h3>
                    <p class="stat-card__value" id="best-tf-name">-</p>
                    <p class="stat-card__change" id="best-tf-winrate">-</p>
                    <p class="stat-card__detail" id="best-tf-trades">-</p>
                </div>
            </div>
            <!-- Timeframe Detayları -->
            <div class="mt-3 hidden" id="tf-details">
                <div class="grid grid--cols-4 gap-2" id="tf-performance-grid">
                    <!-- Dinamik olarak doldurulacak -->
                </div>
            </div>
        </div>
    </div>

    <!-- Support/Resistance Levels -->
    <div class="grid grid--cols-2 mb-lg">
        <div class="glass-card">
            <div class="glass-card__header">
                <h2 class="glass-card__title">
                    <i class="fas fa-shield-alt text-green"></i>
                    Destek Seviyeleri
                </h2>
            </div>
            <div class="glass-card__body">
                <div id="support-levels" class="levels-container">
                    <p class="text-muted">Yükleniyor...</p>
                </div>
            </div>
        </div>
        <div class="glass-card">
            <div class="glass-card__header">
                <h2 class="glass-card__title">
                    <i class="fas fa-ban text-red"></i>
                    Direnç Seviyeleri
                </h2>
            </div>
            <div class="glass-card__body">
                <div id="resistance-levels" class="levels-container">
                    <p class="text-muted">Yükleniyor...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs Section -->
    <div class="grid grid--cols-2">
        <!-- Log Stats -->
        <div class="glass-card">
            <div class="glass-card__header">
                <h2 class="glass-card__title">
                    <i class="fas fa-folder text-purple"></i>
                    Log Yönetimi
                </h2>
            </div>
            <div class="glass-card__body">
                <div class="grid grid--cols-2 gap-md">
                    <div class="stat-card">
                        <p class="stat-card__label">Toplam Boyut</p>
                        <p class="stat-card__value text-lg" id="log-total-size">-</p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-card__label">Dosya Sayısı</p>
                        <p class="stat-card__value text-lg" id="log-file-count">-</p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-card__label">Sıkıştırılmış</p>
                        <p class="stat-card__value text-lg" id="log-compressed">-</p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-card__label">En Eski</p>
                        <p class="text-sm" id="log-oldest">-</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Error Logs -->
        <div class="glass-card">
            <div class="glass-card__header">
                <h2 class="glass-card__title">
                    <i class="fas fa-exclamation-triangle text-error"></i>
                    Son Hatalar
                </h2>
            </div>
            <div class="glass-card__body">
                <div id="error-logs" class="custom-scrollbar" style="max-height: 200px; overflow-y: auto;">
                    <p class="text-muted text-sm">Yükleniyor...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script>
        // Summary text formatting function
        function formatSummaryText(text) {
            if (!text) return '';
            // Convert **text** to <strong>text</strong>
            return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }
        
        // WebSocket bağlantısı
        let ws = null;
        let priceChart = null;
        let candleChart = null;
        let priceData = [];

        // WebSocket bağlan
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
            
            ws.onopen = () => {
                document.getElementById('status-text').textContent = 'Bağlı';
                document.getElementById('ws-status').classList.add('bg-success');
                document.getElementById('ws-status').classList.remove('bg-error');
            };
            
            ws.onclose = () => {
                document.getElementById('status-text').textContent = 'Bağlantı koptu';
                document.getElementById('ws-status').classList.remove('bg-success');
                document.getElementById('ws-status').classList.add('bg-error');
                setTimeout(connectWebSocket, 5000);
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'price_update') {
                    updateCurrentPrice(data.data);
                    addPriceToChart(data.data);
                } else if (data.type === 'performance_update') {
                    handlePerformanceUpdate(data.data);
                } else if (data.type === 'new_signal') {
                    handleNewSignal(data.data);
                }
            };
        }

        // Günlük açılış fiyatları - gerçek API'den gelecek
        let dailyOpenPrices = {
            gram_altin: null,
            ons_usd: null,
            usd_try: null,
            ons_try: null
        };

        // Fiyat güncelle
        function updateCurrentPrice(price) {
            // Gram Altın
            if (price.gram_altin) {
                document.getElementById('gram-altin').textContent = `₺${price.gram_altin.toFixed(2)}`;
                
                // WebSocket'ten gelen günlük değişim yüzdesini kullan
                if (price.daily_change_pct !== undefined && price.daily_change_pct !== null) {
                    updatePriceChangeFromPercent('gram-change', price.daily_change_pct);
                } else if (dailyOpenPrices.gram_altin) {
                    updatePriceChange('gram-change', dailyOpenPrices.gram_altin, price.gram_altin);
                }
            }
            
            // ONS/USD
            document.getElementById('ons-usd').textContent = `$${price.ons_usd.toFixed(2)}`;
            if (dailyOpenPrices.ons_usd) {
                updatePriceChange('ons-change', dailyOpenPrices.ons_usd, price.ons_usd);
            }
            
            // USD/TRY
            document.getElementById('usd-try').textContent = price.usd_try.toFixed(4);
            if (dailyOpenPrices.usd_try) {
                updatePriceChange('usd-change', dailyOpenPrices.usd_try, price.usd_try);
            }
            
            // ONS/TRY
            document.getElementById('ons-try').textContent = `₺${price.ons_try.toFixed(2)}`;
            if (dailyOpenPrices.ons_try) {
                updatePriceChange('ons-try-change', dailyOpenPrices.ons_try, price.ons_try);
            }
        }

        // Fiyat değişimini göster
        function updatePriceChange(elementId, openPrice, currentPrice) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const change = ((currentPrice - openPrice) / openPrice) * 100;
            const changeText = change >= 0 ? `+${change.toFixed(2)}%` : `${change.toFixed(2)}%`;
            const colorClass = change >= 0 ? 'text-emerald-500' : 'text-rose-500';

            element.innerHTML = `
                <span class="${colorClass}">
                    <i class="fas fa-arrow-${change >= 0 ? 'up' : 'down'} mr-1 text-xs"></i>
                    ${changeText}
                </span>
            `;
        }
        
        // WebSocket'ten gelen yüzde değeri ile fiyat değişimini göster
        function updatePriceChangeFromPercent(elementId, changePercent) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const change = parseFloat(changePercent);
            if (isNaN(change)) {
                element.innerHTML = '<span class="text-gray-400">-</span>';
                return;
            }

            const changeText = change >= 0 ? `+${change.toFixed(2)}%` : `${change.toFixed(2)}%`;
            const colorClass = change >= 0 ? 'text-emerald-500' : 'text-rose-500';

            element.innerHTML = `
                <span class="${colorClass}">
                    <i class="fas fa-arrow-${change >= 0 ? 'up' : 'down'} mr-1 text-xs"></i>
                    ${changeText}
                </span>
            `;
        }

        // Günlük açılış fiyatlarını yükle
        async function loadDailyOpenPrices() {
            try {
                // Mock data - gerçek API endpoint eklenecek
                // API'den bugünün açılış fiyatları veya 24 saat önceki fiyatlar gelecek
                const response = await fetch('/api/prices/daily-open');
                const data = await response.json();
                
                if (data.prices) {
                    dailyOpenPrices = data.prices;
                }
            } catch (error) {
                console.error('Günlük açılış fiyatları yüklenemedi:', error);
                // Fallback olarak şu anki fiyatları kullan
                const currentPrices = await fetch('/api/prices/latest');
                const data = await currentPrices.json();
                if (data.prices && data.prices.length > 0) {
                    const latest = data.prices[0];
                    dailyOpenPrices = {
                        gram_altin: latest.gram_altin,
                        ons_usd: latest.ons_usd,
                        usd_try: latest.usd_try,
                        ons_try: latest.ons_try
                    };
                }
            }
        }

        // İstatistikleri yükle
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                document.getElementById('uptime').textContent = data.system.uptime || '-';
                document.getElementById('total-records').textContent = data.database.total_records?.toLocaleString() || '0';
                document.getElementById('today-signals').textContent = data.signals.today || '0';
            } catch (error) {
                console.error('Stats yüklenemedi:', error);
            }
        }

        // Fiyat grafiği oluştur
        function initPriceChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Gram Altın',
                        data: [],
                        borderColor: 'rgb(250, 204, 21)',
                        backgroundColor: 'rgba(250, 204, 21, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            ticks: { 
                                color: 'rgb(156, 163, 175)',
                                callback: function(value) {
                                    return '₺' + value.toFixed(2);
                                }
                            },
                            grid: {
                                color: 'rgba(75, 85, 99, 0.3)'
                            }
                        },
                        x: {
                            ticks: { 
                                color: 'rgb(156, 163, 175)',
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 10
                            },
                            grid: {
                                color: 'rgba(75, 85, 99, 0.3)'
                            }
                        }
                    }
                }
            });
        }
        
        // Mum grafiği oluştur
        function initCandleChart() {
            const options = {
                chart: {
                    type: 'candlestick',
                    height: 350,
                    background: 'transparent',
                    toolbar: { show: false },
                    offsetY: -10
                },
                series: [{
                    name: 'OHLC',
                    data: []
                }],
                xaxis: {
                    type: 'datetime',
                    labels: {
                        style: { colors: '#9CA3AF' }
                    }
                },
                yaxis: {
                    labels: {
                        style: { colors: '#9CA3AF' },
                        formatter: (val) => '₺' + val.toFixed(0),
                        offsetX: 0
                    },
                    tooltip: {
                        enabled: true
                    }
                },
                theme: { mode: 'dark' },
                plotOptions: {
                    candlestick: {
                        colors: {
                            upward: '#10b981',
                            downward: '#ef4444'
                        }
                    }
                },
                grid: {
                    borderColor: '#374151',
                    padding: {
                        top: 10,
                        right: 30,
                        bottom: 10,
                        left: 10
                    }
                }
            };
            
            candleChart = new ApexCharts(document.querySelector("#candleChart"), options);
            candleChart.render();
            loadGramCandles('1h');
        }
        
        // Gram altın mum verilerini yükle
        async function loadGramCandles(interval, btnElement) {
            try {
                const response = await fetch(`/api/gram-candles/${interval}`);
                const data = await response.json();
                
                if (data.candles && data.candles.length > 0) {
                    const candleData = data.candles.map(c => ({
                        x: new Date(c.timestamp),
                        y: [c.open, c.high, c.low, c.close]
                    }));
                    
                    candleChart.updateSeries([{
                        name: 'OHLC',
                        data: candleData
                    }]);
                }
                
                // Buton stillerini güncelle
                document.querySelectorAll('.candle-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-800');
                    btn.classList.add('bg-blue-600');
                });
                
                // Aktif butonu vurgula
                if (btnElement) {
                    btnElement.classList.remove('bg-blue-600');
                    btnElement.classList.add('bg-blue-800');
                }
            } catch (error) {
                console.error('Mum verileri yüklenemedi:', error);
            }
        }

        // Grafiğe fiyat ekle
        function addPriceToChart(price) {
            if (!priceChart) return;
            
            const time = new Date(price.timestamp);
            // Timestamp zaten Türkiye saatinde geliyor, ekleme yapma
            const timeStr = time.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
            
            priceChart.data.labels.push(timeStr);
            priceChart.data.datasets[0].data.push(price.gram_altin);
            
            if (priceChart.data.labels.length > 360) {
                priceChart.data.labels.shift();
                priceChart.data.datasets[0].data.shift();
            }
            
            priceChart.update();
        }

        // Compact hibrit analiz sonuçlarını yükle (sadece 1h, 4h, günlük)
        async function loadHybridAnalysis() {
            try {
                // Son 3 farklı timeframe'den analizleri al
                const responses = await Promise.allSettled([
                    fetch('/api/analysis/history?limit=1'),  // Son analiz (herhangi bir timeframe)
                    fetch('/api/analysis/indicators/1h'),
                    fetch('/api/analysis/indicators/4h'),
                    fetch('/api/analysis/indicators/1d')
                ]);
                
                const container = document.getElementById('hybrid-analysis-container');
                
                // Ana analizi göster
                if (responses[0].status === 'fulfilled') {
                    const data = await responses[0].value.json();
                    
                    if (data.analyses && data.analyses.length > 0) {
                        const analysis = data.analyses[0];
                        
                        // 15 dakikalık analizleri filtrele
                        if (analysis.timeframe === '15m') {
                            container.innerHTML = '<p class="text-gray-400 text-sm">15 dakikalık analizler gösterilmiyor. 1h, 4h veya günlük analiz bekleniyor...</p>';
                            return;
                        }
                        
                        const signalColor = analysis.signal === 'BUY' ? 'text-green-400' : 
                                          analysis.signal === 'SELL' ? 'text-red-400' : 
                                          'text-gray-400';
                        
                        // Teknik göstergeleri güncelle
                        updateTechnicalIndicators(analysis.details);
                        
                        // Piyasa durumunu güncelle
                        updateMarketOverview(analysis);
                        
                        const time = new Date(analysis.timestamp);
                        
                        container.innerHTML = `
                            <!-- Compact Ana Sinyal -->
                            <div class="flex items-center justify-between p-3 bg-slate-800/30 rounded-lg mb-3">
                                <div class="flex items-center space-x-3">
                                    <div class="${signalColor}">
                                        <i class="fas ${analysis.signal === 'BUY' ? 'fa-arrow-up' : 
                                                      analysis.signal === 'SELL' ? 'fa-arrow-down' : 
                                                      'fa-minus'} text-lg"></i>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-sm">
                                            ${analysis.signal === 'BUY' ? 'ALIŞ' : 
                                              analysis.signal === 'SELL' ? 'SATIŞ' : 
                                              'BEKLE'} • ${analysis.timeframe}
                                        </div>
                                        <div class="text-xs text-gray-400">
                                            ₺${analysis.price.toFixed(2)} • %${(analysis.confidence * 100).toFixed(0)} güven
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-gray-400">${time.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}</div>
                                    ${analysis.risk_reward_ratio ? `<div class="text-xs ${analysis.risk_reward_ratio > 1.5 ? 'text-green-400' : 'text-yellow-400'}">R/R: ${analysis.risk_reward_ratio.toFixed(1)}</div>` : ''}
                                </div>
                            </div>
                            
                            <!-- Compact Piyasa Durumu -->
                            <div class="grid grid-cols-3 gap-2">
                                <div class="bg-slate-800/20 rounded p-2 text-center">
                                    <div class="text-xs text-gray-400 mb-1">Global Trend</div>
                                    <div class="text-sm font-semibold ${
                                        analysis.global_trend === 'BULLISH' ? 'text-green-400' :
                                        analysis.global_trend === 'BEARISH' ? 'text-red-400' :
                                        'text-yellow-400'
                                    }">
                                        ${analysis.global_trend === 'BULLISH' ? '↗️ Yükseliş' :
                                          analysis.global_trend === 'BEARISH' ? '↘️ Düşüş' :
                                          '➡️ Yatay'}
                                    </div>
                                </div>
                                
                                <div class="bg-slate-800/20 rounded p-2 text-center">
                                    <div class="text-xs text-gray-400 mb-1">Kur Riski</div>
                                    <div class="text-sm font-semibold ${
                                        analysis.currency_risk === 'LOW' ? 'text-green-400' :
                                        analysis.currency_risk === 'MEDIUM' ? 'text-yellow-400' :
                                        'text-red-400'
                                    }">
                                        ${analysis.currency_risk === 'LOW' ? '🟢 Düşük' :
                                          analysis.currency_risk === 'MEDIUM' ? '🟡 Orta' :
                                          '🔴 Yüksek'}
                                    </div>
                                </div>
                                
                                <div class="bg-slate-800/20 rounded p-2 text-center">
                                    <div class="text-xs text-gray-400 mb-1">Pozisyon</div>
                                    <div class="text-sm font-semibold text-blue-400">
                                        %${(analysis.position_size * 100).toFixed(0)}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Compact Özet -->
                            ${analysis.summary ? `
                            <div class="mt-3 p-2 bg-slate-900/30 rounded text-xs text-gray-300 leading-relaxed">
                                ${formatSummaryText(analysis.summary).substring(0, 150)}${analysis.summary.length > 150 ? '...' : ''}
                            </div>
                            ` : ''}
                        `;
                    } else {
                        container.innerHTML = '<p class="text-gray-400 text-sm">Henüz hibrit analiz yok</p>';
                    }
                } else {
                    container.innerHTML = '<p class="text-red-400 text-sm">Analiz yüklenemedi</p>';
                }
            } catch (error) {
                console.error('Hibrit analiz yüklenemedi:', error);
                document.getElementById('hybrid-analysis-container').innerHTML = '<p class="text-red-400 text-sm">Analiz yüklenirken hata oluştu</p>';
            }
        }

        // Teknik göstergeleri güncelle
        function updateTechnicalIndicators(details) {
            if (!details || !details.gram) return;

            const gram = details.gram;
            
            // RSI
            if (gram.rsi) {
                const rsiValue = gram.rsi.toFixed(1);
                let rsiClass = '';
                if (gram.rsi < 30) rsiClass = 'text-green-400';
                else if (gram.rsi > 70) rsiClass = 'text-red-400';
                else rsiClass = 'text-yellow-400';
                
                document.getElementById('rsi-value').innerHTML = `<span class="${rsiClass}">${rsiValue}</span>`;
            }

            // MACD
            document.getElementById('macd-signal').innerHTML = 
                `<span class="${gram.signal === 'BUY' ? 'text-green-400' : gram.signal === 'SELL' ? 'text-red-400' : 'text-yellow-400'}">
                    ${gram.signal || 'NEUTRAL'}
                </span>`;

            // Bollinger Bands
            if (gram.indicators && gram.indicators.bollinger) {
                const bb = gram.indicators.bollinger;
                let bbPosition = 'MIDDLE';
                let bbClass = 'text-yellow-400';
                if (gram.price > bb.upper) {
                    bbPosition = 'ABOVE';
                    bbClass = 'text-red-400';
                } else if (gram.price < bb.lower) {
                    bbPosition = 'BELOW';
                    bbClass = 'text-green-400';
                }
                document.getElementById('bb-position').innerHTML = `<span class="${bbClass}">${bbPosition}</span>`;
            }
            
            // Stochastic
            if (gram.indicators && gram.indicators.stochastic) {
                const stoch = gram.indicators.stochastic;
                const stochValue = stoch.k.toFixed(1);
                let stochClass = '';
                if (stoch.k < 20) stochClass = 'text-green-400';
                else if (stoch.k > 80) stochClass = 'text-red-400';
                else stochClass = 'text-blue-400';
                document.getElementById('stoch-value').innerHTML = `<span class="${stochClass}">${stochValue}</span>`;
            }
            
            // İleri göstergeler
            if (details.advanced_indicators) {
                const adv = details.advanced_indicators;
                
                // CCI
                if (adv.cci !== undefined && adv.cci !== null) {
                    const cciValue = adv.cci.toFixed(1);
                    let cciClass = '';
                    if (adv.cci < -100) cciClass = 'text-green-400';
                    else if (adv.cci > 100) cciClass = 'text-red-400';
                    else cciClass = 'text-yellow-400';
                    document.getElementById('cci-value').innerHTML = `<span class="${cciClass}">${cciValue}</span>`;
                }
                
                // MFI
                if (adv.mfi !== undefined && adv.mfi !== null) {
                    const mfiValue = adv.mfi.toFixed(1);
                    let mfiClass = '';
                    if (adv.mfi < 20) mfiClass = 'text-green-400';
                    else if (adv.mfi > 80) mfiClass = 'text-red-400';
                    else mfiClass = 'text-yellow-400';
                    document.getElementById('mfi-value').innerHTML = `<span class="${mfiClass}">${mfiValue}</span>`;
                }
            }
            
            // Pattern
            if (details.pattern && details.pattern.name) {
                const patternName = details.pattern.name !== 'None' ? details.pattern.name : 'Yok';
                const patternClass = details.pattern.signal === 'BUY' ? 'text-green-400' : 
                                   details.pattern.signal === 'SELL' ? 'text-red-400' : 'text-gray-400';
                document.getElementById('pattern-name').innerHTML = `<span class="${patternClass}">${patternName}</span>`;
            }
            
            // Trend gücü
            if (details.global && details.global.trend_strength) {
                const strength = details.global.trend_strength;
                const strengthText = strength === 'STRONG' ? 'Güçlü' : 
                                   strength === 'MODERATE' ? 'Orta' : 'Zayıf';
                const strengthClass = strength === 'STRONG' ? 'text-green-400' : 
                                    strength === 'MODERATE' ? 'text-yellow-400' : 'text-gray-400';
                document.getElementById('trend-strength').innerHTML = `<span class="${strengthClass}">${strengthText}</span>`;
            }
            
            // ONS/USD göstergeleri
            if (details.global && details.global.technical_indicators) {
                const onsIndicators = details.global.technical_indicators;
                
                // ONS RSI
                if (onsIndicators.rsi) {
                    const onsRsiValue = onsIndicators.rsi.toFixed(1);
                    let onsRsiClass = '';
                    if (onsIndicators.rsi < 30) onsRsiClass = 'text-green-400';
                    else if (onsIndicators.rsi > 70) onsRsiClass = 'text-red-400';
                    else onsRsiClass = 'text-yellow-400';
                    document.getElementById('ons-rsi-value').innerHTML = `<span class="${onsRsiClass}">${onsRsiValue}</span>`;
                }
                
                // ONS MACD
                if (onsIndicators.macd && onsIndicators.macd.macd_line !== undefined && onsIndicators.macd.signal_line !== undefined) {
                    const onsSignal = onsIndicators.macd.macd_line > onsIndicators.macd.signal_line ? 'BUY' : 'SELL';
                    const onsSignalClass = onsSignal === 'BUY' ? 'text-green-400' : 'text-red-400';
                    document.getElementById('ons-macd-signal').innerHTML = `<span class="${onsSignalClass}">${onsSignal}</span>`;
                }
                
                // ONS Stochastic
                if (onsIndicators.stochastic) {
                    const onsStochValue = onsIndicators.stochastic.k.toFixed(1);
                    let onsStochClass = '';
                    if (onsIndicators.stochastic.k < 20) onsStochClass = 'text-green-400';
                    else if (onsIndicators.stochastic.k > 80) onsStochClass = 'text-red-400';
                    else onsStochClass = 'text-blue-400';
                    document.getElementById('ons-stoch-value').innerHTML = `<span class="${onsStochClass}">${onsStochValue}</span>`;
                }
                
                // ONS Trend
                if (details.global.trend_direction) {
                    const onsTrend = details.global.trend_direction;
                    const onsTrendClass = onsTrend === 'BULLISH' ? 'text-green-400' : 
                                         onsTrend === 'BEARISH' ? 'text-red-400' : 'text-yellow-400';
                    const onsTrendText = onsTrend === 'BULLISH' ? 'YÜKSELIŞ' : 
                                        onsTrend === 'BEARISH' ? 'DÜŞÜŞ' : 'YATAY';
                    document.getElementById('ons-trend').innerHTML = `<span class="${onsTrendClass}">${onsTrendText}</span>`;
                }
            }
        }

        // Piyasa durumunu güncelle
        function updateMarketOverview(analysis) {
            // Genel görünüm
            const trend = analysis.global_trend;
            let trendText = '';
            let trendClass = '';
            
            if (trend === 'BULLISH') {
                trendText = '📈 Yükseliş';
                trendClass = 'text-green-400';
            } else if (trend === 'BEARISH') {
                trendText = '📉 Düşüş';
                trendClass = 'text-red-400';
            } else {
                trendText = '➡️ Yatay';
                trendClass = 'text-yellow-400';
            }
            
            document.getElementById('market-overview').innerHTML = `<span class="${trendClass}">${trendText}</span>`;
            
            // Volatilite
            if (analysis.details && analysis.details.gram && analysis.details.gram.volatility) {
                const volatility = analysis.details.gram.volatility;
                let volText = 'Düşük';
                let volClass = 'text-green-400';
                
                if (volatility > 0.02) {
                    volText = 'Yüksek';
                    volClass = 'text-red-400';
                } else if (volatility > 0.01) {
                    volText = 'Orta';
                    volClass = 'text-orange-400';
                }
                
                document.getElementById('market-volatility').innerHTML = `<span class="${volClass}">${volText}</span>`;
            }
            
            // Market Overview Widget güncelleme
            if (analysis.details) {
                // Gram fiyat ve değişim
                const gramPrice = analysis.price || 0;
                const gramChange = analysis.details.gram?.change_1h || 0;
                const gramChangeClass = gramChange > 0 ? 'text-green-400' : gramChange < 0 ? 'text-red-400' : 'text-gray-400';
                document.getElementById('mo-gram-price').textContent = `₺${gramPrice.toFixed(2)}`;
                document.getElementById('mo-gram-change').innerHTML = `<span class="${gramChangeClass}">${gramChange > 0 ? '+' : ''}${(gramChange * 100).toFixed(2)}%</span>`;
                
                // ONS fiyat ve değişim
                if (analysis.details.global) {
                    const onsPrice = analysis.details.global.ons_price || 0;
                    const onsChange = analysis.details.global.change_1h || 0;
                    const onsChangeClass = onsChange > 0 ? 'text-green-400' : onsChange < 0 ? 'text-red-400' : 'text-gray-400';
                    document.getElementById('mo-ons-price').textContent = `$${onsPrice.toFixed(2)}`;
                    document.getElementById('mo-ons-change').innerHTML = `<span class="${onsChangeClass}">${onsChange > 0 ? '+' : ''}${(onsChange * 100).toFixed(2)}%</span>`;
                }
                
                // USD/TRY
                if (analysis.details.currency) {
                    const usdPrice = analysis.details.currency.usd_try || 0;
                    const usdChange = analysis.details.currency.change_1h || 0;
                    const usdChangeClass = usdChange > 0 ? 'text-red-400' : usdChange < 0 ? 'text-green-400' : 'text-gray-400';
                    document.getElementById('mo-usd-price').textContent = `₺${usdPrice.toFixed(2)}`;
                    document.getElementById('mo-usd-change').innerHTML = `<span class="${usdChangeClass}">${usdChange > 0 ? '+' : ''}${(usdChange * 100).toFixed(2)}%</span>`;
                }
                
                // Trend
                document.getElementById('mo-trend').innerHTML = `<span class="${trendClass}">${trend === 'BULLISH' ? 'Yükseliş' : trend === 'BEARISH' ? 'Düşüş' : 'Yatay'}</span>`;
                
                // Kur riski
                const risk = analysis.currency_risk || 'MEDIUM';
                const riskClass = risk === 'LOW' ? 'text-green-400' : risk === 'HIGH' ? 'text-red-400' : 'text-yellow-400';
                const riskText = risk === 'LOW' ? 'Düşük' : risk === 'HIGH' ? 'Yüksek' : 'Orta';
                document.getElementById('mo-risk').innerHTML = `<span class="${riskClass}">${riskText}</span>`;
            }
            
            // 24 saatlik en yüksek/düşük - API'den gelecek
            loadDailyPriceRange();
        }
        
        // Sinyalleri yükle
        async function loadSignals() {
            try {
                const response = await fetch('/api/signals/recent');
                const data = await response.json();
                
                const container = document.getElementById('signals-container');
                
                if (data.signals && data.signals.length > 0) {
                    // Son 10 sinyali göster
                    const recentSignals = data.signals.slice(0, 10);
                    
                    container.innerHTML = recentSignals.map(signal => {
                        const time = new Date(signal.timestamp);
                        const signalClass = signal.signal === 'BUY' ? 'bg-green-900/30 border-green-600/50' : 'bg-red-900/30 border-red-600/50';
                        const iconClass = signal.signal === 'BUY' ? 'text-green-400' : 'text-red-400';
                        const confidence = (signal.confidence * 100).toFixed(0);
                        
                        return `
                            <div class="${signalClass} border rounded-lg p-3 hover:bg-opacity-50 transition-all">
                                <div class="flex justify-between items-start">
                                    <div class="flex items-center space-x-3">
                                        <div class="${iconClass}">
                                            <i class="fas ${signal.signal === 'BUY' ? 'fa-arrow-circle-up' : 'fa-arrow-circle-down'} text-xl"></i>
                                        </div>
                                        <div>
                                            <div class="font-semibold text-sm">
                                                ${signal.signal === 'BUY' ? 'ALIŞ' : 'SATIŞ'} Sinyali
                                                <span class="ml-2 text-xs bg-slate-700 px-2 py-1 rounded">${signal.timeframe}</span>
                                            </div>
                                            <div class="text-xs text-gray-400 mt-1">
                                                Fiyat: ₺${parseFloat(signal.gram_price).toFixed(2)}
                                                ${signal.stop_loss ? `• SL: ₺${parseFloat(signal.stop_loss).toFixed(2)}` : ''}
                                                ${signal.take_profit ? `• TP: ₺${parseFloat(signal.take_profit).toFixed(2)}` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs text-gray-400">
                                            ${time.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
                                        </div>
                                        <div class="text-xs mt-1">
                                            <span class="bg-slate-700 px-2 py-1 rounded">
                                                %${confidence} güven
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                ${signal.risk_reward && signal.risk_reward > 0 ? `
                                <div class="mt-2 pt-2 border-t border-gray-700">
                                    <span class="text-xs text-gray-400">Risk/Ödül: ${signal.risk_reward.toFixed(2)}</span>
                                    ${signal.position_size ? `<span class="ml-3 text-xs text-gray-400">Pozisyon: %${(signal.position_size * 100).toFixed(0)}</span>` : ''}
                                </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-bell-slash text-4xl text-gray-600 mb-3"></i>
                            <p class="text-gray-400">Son 24 saatte sinyal üretilmedi</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Sinyaller yüklenemedi:', error);
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle text-yellow-400 mb-2"></i>
                        <p class="text-gray-400 text-sm">Sinyaller yüklenemedi</p>
                    </div>
                `;
            }
        }

        // Log istatistiklerini yükle
        async function loadLogStats() {
            try {
                const response = await fetch('/api/logs/stats');
                const stats = await response.json();
                
                if (!stats.error) {
                    document.getElementById('log-total-size').textContent = `${stats.total_size_mb.toFixed(1)} MB`;
                    document.getElementById('log-file-count').textContent = stats.total_files;
                    document.getElementById('log-compressed').textContent = stats.compressed_files;
                    document.getElementById('log-oldest').textContent = stats.oldest_file || '-';
                }
            } catch (error) {
                console.error('Log stats yüklenemedi:', error);
            }
        }
        
        // Son hataları yükle
        async function loadRecentErrors() {
            try {
                const response = await fetch('/api/logs/recent-errors?count=5');
                const data = await response.json();
                
                const errorLogs = document.getElementById('error-logs');
                if (data.errors && data.errors.length > 0) {
                    errorLogs.innerHTML = data.errors.map(error => 
                        `<div class="text-red-400 text-xs p-1 border-b border-gray-700 break-all">${error}</div>`
                    ).join('');
                } else {
                    errorLogs.innerHTML = '<p class="text-green-400">Son zamanlarda hata yok 🎉</p>';
                }
            } catch (error) {
                console.error('Error logs yüklenemedi:', error);
            }
        }
        
        // Destek/Direnç seviyelerini yükle
        async function loadSupportResistanceLevels() {
            try {
                const response = await fetch('/api/analysis/levels');
                const data = await response.json();
                
                const supportContainer = document.getElementById('support-levels');
                const resistanceContainer = document.getElementById('resistance-levels');
                
                // Destek seviyeleri
                if (data.support && data.support.length > 0) {
                    supportContainer.innerHTML = data.support.map(level => {
                        const strengthClass = level.strength === 'Güçlü' ? 'text-green-400' :
                                            level.strength === 'Orta' ? 'text-yellow-400' : 'text-gray-400';
                        return `
                            <div class="level-item">
                                <span class="level-price">₺${level.level.toFixed(2)}</span>
                                <span class="level-strength ${strengthClass}">${level.strength}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    supportContainer.innerHTML = '<p class="text-muted text-sm">Veri yok</p>';
                }
                
                // Direnç seviyeleri
                if (data.resistance && data.resistance.length > 0) {
                    resistanceContainer.innerHTML = data.resistance.map(level => {
                        const strengthClass = level.strength === 'Güçlü' ? 'text-red-400' :
                                            level.strength === 'Orta' ? 'text-orange-400' : 'text-gray-400';
                        return `
                            <div class="level-item">
                                <span class="level-price">₺${level.level.toFixed(2)}</span>
                                <span class="level-strength ${strengthClass}">${level.strength}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    resistanceContainer.innerHTML = '<p class="text-muted text-sm">Veri yok</p>';
                }
            } catch (error) {
                console.error('Destek/Direnç seviyeleri yüklenemedi:', error);
            }
        }
        
        // Performans metriklerini yükle
        async function loadPerformanceMetrics() {
            try {
                const response = await fetch('/api/performance/metrics');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Performans verisi hatası:', data.error);
                    showEmptyPerformance();
                    return;
                }
                
                // Trend ikonu belirleme
                const getTrendIcon = (trend) => {
                    if (trend === 'improving') return '<i class="fas fa-arrow-trend-up text-green-400"></i>';
                    if (trend === 'declining') return '<i class="fas fa-arrow-trend-down text-red-400"></i>';
                    return '<i class="fas fa-minus text-gray-400"></i>';
                };
                
                // 24 Saat Performans
                const daily = data.performance.daily;
                document.getElementById('daily-winrate').innerHTML = `${daily.win_rate.toFixed(1)}% ${getTrendIcon(data.overview.trend)}`;
                document.getElementById('daily-trades').innerHTML = `<span class="text-gray-400">${daily.trades} işlem (${daily.wins} kazanç)</span>`;
                const dailyPnlClass = daily.pnl >= 0 ? 'text-green-400' : 'text-red-400';
                document.getElementById('daily-pnl').innerHTML = `<span class="${dailyPnlClass}">${daily.pnl >= 0 ? '+' : ''}${daily.pnl.toFixed(2)} gram</span>`;
                
                // 7 Gün Performans
                const weekly = data.performance.weekly;
                document.getElementById('weekly-winrate').textContent = `${weekly.win_rate.toFixed(1)}%`;
                document.getElementById('weekly-trades').innerHTML = `<span class="text-gray-400">${weekly.trades} işlem (${weekly.wins} kazanç)</span>`;
                const weeklyPnlClass = weekly.pnl >= 0 ? 'text-green-400' : 'text-red-400';
                document.getElementById('weekly-pnl').innerHTML = `<span class="${weeklyPnlClass}">${weekly.pnl >= 0 ? '+' : ''}${weekly.pnl.toFixed(2)} gram</span>`;
                
                // 30 Gün Performans
                const monthly = data.performance.monthly;
                document.getElementById('monthly-winrate').textContent = `${monthly.win_rate.toFixed(1)}%`;
                document.getElementById('monthly-trades').innerHTML = `<span class="text-gray-400">${monthly.trades} işlem (${monthly.wins}/${monthly.losses})</span>`;
                const monthlyPnlClass = monthly.pnl >= 0 ? 'text-green-400' : 'text-red-400';
                document.getElementById('monthly-pnl').innerHTML = `<span class="${monthlyPnlClass}">${monthly.pnl >= 0 ? '+' : ''}${monthly.pnl.toFixed(2)} gram</span>`;
                
                // En İyi Timeframe
                const bestTf = data.best_timeframe;
                document.getElementById('best-tf-name').textContent = bestTf.name.toUpperCase();
                document.getElementById('best-tf-winrate').innerHTML = `<span class="text-green-400">${bestTf.stats.win_rate?.toFixed(1) || 0}% başarı</span>`;
                document.getElementById('best-tf-trades').innerHTML = `<span class="text-gray-400">${bestTf.stats.total_trades || 0} işlem</span>`;
                
                // Timeframe detayları
                if (data.timeframes && Object.keys(data.timeframes).length > 0) {
                    const tfGrid = document.getElementById('tf-performance-grid');
                    tfGrid.innerHTML = '';
                    
                    for (const [tf, stats] of Object.entries(data.timeframes)) {
                        const tfCard = document.createElement('div');
                        tfCard.className = 'bg-gray-800 rounded p-2 text-center';
                        tfCard.innerHTML = `
                            <div class="text-xs text-gray-400">${tf.toUpperCase()}</div>
                            <div class="text-sm font-bold ${stats.win_rate >= 50 ? 'text-green-400' : 'text-red-400'}">${stats.win_rate.toFixed(1)}%</div>
                            <div class="text-xs text-gray-500">${stats.total_trades} işlem</div>
                            <div class="text-xs ${stats.total_pnl >= 0 ? 'text-green-400' : 'text-red-400'}">${stats.total_pnl >= 0 ? '+' : ''}${stats.total_pnl.toFixed(1)}g</div>
                        `;
                        tfGrid.appendChild(tfCard);
                    }
                    
                    document.getElementById('tf-details').classList.remove('hidden');
                }
                
                // Kart hover efektleri
                document.querySelectorAll('.stat-card').forEach(card => {
                    card.style.cursor = 'pointer';
                    card.addEventListener('mouseenter', () => {
                        card.style.transform = 'translateY(-2px)';
                        card.style.boxShadow = '0 4px 12px rgba(79, 209, 197, 0.2)';
                    });
                    card.addEventListener('mouseleave', () => {
                        card.style.transform = 'translateY(0)';
                        card.style.boxShadow = 'none';
                    });
                });
                
            } catch (error) {
                console.error('Performans metrikleri yüklenemedi:', error);
                showEmptyPerformance();
            }
        }
        
        function showEmptyPerformance() {
            // Varsayılan değerler
            document.getElementById('daily-winrate').textContent = '-';
            document.getElementById('daily-trades').innerHTML = '<span class="text-gray-400">Veri yok</span>';
            document.getElementById('daily-pnl').innerHTML = '<span class="text-gray-400">-</span>';
            
            document.getElementById('weekly-winrate').textContent = '-';
            document.getElementById('weekly-trades').innerHTML = '<span class="text-gray-400">Veri yok</span>';
            document.getElementById('weekly-pnl').innerHTML = '<span class="text-gray-400">-</span>';
            
            document.getElementById('monthly-winrate').textContent = '-';
            document.getElementById('monthly-trades').innerHTML = '<span class="text-gray-400">Veri yok</span>';
            document.getElementById('monthly-pnl').innerHTML = '<span class="text-gray-400">-</span>';
            
            document.getElementById('best-tf-name').textContent = '-';
            document.getElementById('best-tf-winrate').innerHTML = '<span class="text-gray-400">-</span>';
            document.getElementById('best-tf-trades').innerHTML = '<span class="text-gray-400">-</span>';
        }

        // İlk fiyatları yükle
        async function loadInitialPrices() {
            try {
                const response = await fetch('/api/prices/latest');
                const data = await response.json();
                
                if (data.prices && data.prices.length > 0) {
                    const latest = data.prices[data.prices.length - 1];
                    updateCurrentPrice(latest);
                    data.prices.forEach(price => addPriceToChart(price));
                }
            } catch (error) {
                console.error('Fiyatlar yüklenemedi:', error);
            }
        }
        
        // Hızlı analiz çalıştır
        async function runQuickAnalysis(timeframe) {
            const btn = event.target;
            const originalText = btn.innerHTML;
            const originalClasses = btn.className;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Analiz yapılıyor...';
            
            try {
                // Gerçek API çağrısı
                const response = await fetch(`/api/analysis/trigger/${timeframe}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Başarı mesajı
                btn.className = originalClasses.replace(/from-\w+-600 to-\w+-600/, 'from-green-600 to-green-600');
                btn.innerHTML = '<i class="fas fa-check mr-1"></i> Tamamlandı!';
                
                // 1 saniye bekle ve verileri yenile
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Analiz sonrası verileri yenile - sadece mevcut fonksiyonları çağır
                await Promise.all([
                    loadHybridAnalysis(),
                    loadInitialPrices(),
                    loadStats()
                ]);
                
                // Butonu eski haline döndür
                setTimeout(() => {
                    btn.className = originalClasses;
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 1000);
                
            } catch (error) {
                console.error('Analiz hatası:', error);
                
                // Hata mesajı
                btn.className = originalClasses.replace(/from-\w+-600 to-\w+-600/, 'from-red-600 to-red-600');
                btn.innerHTML = `<i class="fas fa-times mr-1"></i> ${error.message || 'Hata!'}`;
                
                // 3 saniye sonra eski haline döndür
                setTimeout(() => {
                    btn.className = originalClasses;
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 3000);
            }
        }

        // loadPrices fonksiyonu - güvenlik için wrapper
        async function loadPrices() {
            // loadInitialPrices fonksiyonunu çağır
            return loadInitialPrices();
        }
        
        // Veri dışa aktarma
        async function exportData() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            const originalClasses = btn.className;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Hazırlanıyor...';
            
            try {
                // Son 24 saatlik veriyi al
                const response = await fetch('/api/prices/latest');
                const data = await response.json();
                
                if (!data.prices || data.prices.length === 0) {
                    throw new Error('Veri bulunamadı');
                }
                
                // CSV formatına çevir
                const csv = [
                    ['Zaman', 'Gram Altın (TRY)', 'ONS/USD', 'USD/TRY', 'ONS/TRY'].join(','),
                    ...data.prices.map(p => [
                        new Date(p.timestamp).toLocaleString('tr-TR'),
                        p.gram_altin.toFixed(2),
                        p.ons_usd.toFixed(2),
                        p.usd_try.toFixed(4),
                        p.ons_try.toFixed(2)
                    ].join(','))
                ].join('\n');
                
                // BOM ekle (Excel'de Türkçe karakterler için)
                const BOM = '\uFEFF';
                const csvWithBOM = BOM + csv;
                
                // Dosya olarak indir
                const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `dezy_gold_prices_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Başarı mesajı
                btn.className = originalClasses.replace(/from-\w+-600 to-\w+-600/, 'from-green-600 to-green-600');
                btn.innerHTML = '<i class="fas fa-check mr-1"></i> İndirildi!';
                
                setTimeout(() => {
                    btn.className = originalClasses;
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('Dışa aktarma hatası:', error);
                
                btn.className = originalClasses.replace(/from-\w+-600 to-\w+-600/, 'from-red-600 to-red-600');
                btn.innerHTML = '<i class="fas fa-times mr-1"></i> Hata!';
                
                setTimeout(() => {
                    btn.className = originalClasses;
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
            }
        }

        // Hızlı fiyat güncelleme fonksiyonu
        async function loadCurrentPriceOnly() {
            try {
                const response = await fetch('/api/prices/current');
                const data = await response.json();
                if (data && !data.error) {
                    updateCurrentPrice(data);
                }
            } catch (error) {
                console.error('Anlık fiyat yüklenemedi:', error);
            }
        }

        // Aktif uyarıları yükle
        async function loadActiveAlerts() {
            try {
                const response = await fetch('/api/alerts/active');
                const data = await response.json();
                
                const container = document.getElementById('active-alerts-container');
                const alertsList = document.getElementById('alerts-list');
                
                if (data.alerts && data.alerts.length > 0) {
                    container.style.display = 'block';
                    
                    alertsList.innerHTML = data.alerts.map(alert => {
                        let alertConfig = {};
                        
                        if (alert.type === 'SUPPORT_NEAR') {
                            alertConfig = {
                                bgColor: 'bg-gradient-to-r from-green-500/10 to-green-600/10',
                                borderColor: 'border-green-500/30',
                                icon: 'fa-shield-alt',
                                iconColor: 'text-green-400',
                                title: 'DESTEK SEVİYESİ',
                                subtitle: 'Alım fırsatı yaklaşıyor'
                            };
                        } else if (alert.type === 'RESISTANCE_NEAR') {
                            alertConfig = {
                                bgColor: 'bg-gradient-to-r from-red-500/10 to-red-600/10',
                                borderColor: 'border-red-500/30',
                                icon: 'fa-ban',
                                iconColor: 'text-red-400',
                                title: 'DİRENÇ SEVİYESİ',
                                subtitle: 'Satış fırsatı yaklaşıyor'
                            };
                        } else if (alert.type === 'RAPID_CHANGE') {
                            alertConfig = {
                                bgColor: 'bg-gradient-to-r from-yellow-500/10 to-orange-600/10',
                                borderColor: 'border-yellow-500/30',
                                icon: 'fa-bolt',
                                iconColor: 'text-yellow-400',
                                title: 'HIZLI DEĞİŞİM',
                                subtitle: 'Volatilite artışı'
                            };
                        }
                        
                        return `
                            <div class="alert-card ${alertConfig.bgColor} ${alertConfig.borderColor} border rounded-xl p-4 backdrop-blur-sm">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-4">
                                        <div class="alert-icon ${alertConfig.iconColor} bg-slate-800/50 rounded-full p-3">
                                            <i class="fas ${alertConfig.icon} text-xl"></i>
                                        </div>
                                        <div>
                                            <div class="font-bold text-sm ${alertConfig.iconColor}">${alertConfig.title}</div>
                                            <div class="text-xs text-gray-400 mb-1">${alertConfig.subtitle}</div>
                                            <div class="text-sm text-gray-200">${alert.message}</div>
                                            ${alert.level ? `<div class="text-xs text-gray-400 mt-1">Hedef: ₺${alert.level.toFixed(2)}</div>` : ''}
                                            ${alert.change_pct ? `<div class="text-xs text-gray-400 mt-1">Değişim: %${Math.abs(alert.change_pct).toFixed(1)}</div>` : ''}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs text-gray-400">
                                            ${new Date(alert.timestamp).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            ${alert.severity === 'HIGH' ? '🔴 Yüksek' : alert.severity === 'MEDIUM' ? '🟡 Orta' : '🟢 Düşük'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.style.display = 'none';
                }
            } catch (error) {
                console.error('Uyarılar yüklenemedi:', error);
                container.style.display = 'none';
            }
        }

        // Market overview widget'ı yükle
        async function loadMarketOverview() {
            try {
                const response = await fetch('/api/market/overview');
                const data = await response.json();
                
                if (data.prices) {
                    // Gram Altın
                    if (data.prices.gram_altin) {
                        document.getElementById('mo-gram-price').textContent = `₺${data.prices.gram_altin.value.toFixed(2)}`;
                        const changeClass = data.prices.gram_altin.change_pct >= 0 ? 'text-green-400' : 'text-red-400';
                        const changeIcon = data.prices.gram_altin.change_pct >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                        document.getElementById('mo-gram-change').innerHTML = 
                            `<span class="${changeClass}"><i class="fas ${changeIcon} mr-1"></i>${data.prices.gram_altin.change_pct >= 0 ? '+' : ''}${data.prices.gram_altin.change_pct.toFixed(2)}%</span>`;
                    }
                    
                    // ONS/USD
                    if (data.prices.ons_usd) {
                        document.getElementById('mo-ons-price').textContent = `$${data.prices.ons_usd.value.toFixed(2)}`;
                        const changeClass = data.prices.ons_usd.change_pct >= 0 ? 'text-green-400' : 'text-red-400';
                        const changeIcon = data.prices.ons_usd.change_pct >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                        document.getElementById('mo-ons-change').innerHTML = 
                            `<span class="${changeClass}"><i class="fas ${changeIcon} mr-1"></i>${data.prices.ons_usd.change_pct >= 0 ? '+' : ''}${data.prices.ons_usd.change_pct.toFixed(2)}%</span>`;
                    }
                    
                    // USD/TRY
                    if (data.prices.usd_try) {
                        document.getElementById('mo-usd-price').textContent = `${data.prices.usd_try.value.toFixed(4)}`;
                        const changeClass = data.prices.usd_try.change_pct >= 0 ? 'text-green-400' : 'text-red-400';
                        const changeIcon = data.prices.usd_try.change_pct >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                        document.getElementById('mo-usd-change').innerHTML = 
                            `<span class="${changeClass}"><i class="fas ${changeIcon} mr-1"></i>${data.prices.usd_try.change_pct >= 0 ? '+' : ''}${data.prices.usd_try.change_pct.toFixed(2)}%</span>`;
                    }
                }
                
                // Analiz bilgileri
                if (data.analysis) {
                    // Trend
                    const trendClass = data.analysis.signal === 'BUY' ? 'text-green-400' :
                                     data.analysis.signal === 'SELL' ? 'text-red-400' : 'text-yellow-400';
                    document.getElementById('mo-trend').innerHTML = 
                        `<span class="${trendClass}">${data.analysis.signal || 'Bilinmiyor'}</span>`;
                    
                    // Risk
                    const riskClass = data.analysis.currency_risk === 'LOW' ? 'text-green-400' :
                                    data.analysis.currency_risk === 'MEDIUM' ? 'text-yellow-400' :
                                    data.analysis.currency_risk === 'HIGH' ? 'text-red-400' : 'text-gray-400';
                    document.getElementById('mo-risk').innerHTML = 
                        `<span class="${riskClass}">${data.analysis.currency_risk || 'Bilinmiyor'}</span>`;
                }
            } catch (error) {
                console.error('Market overview yüklenemedi:', error);
            }
        }

        // Hibrit analiz geçmişini yükle
        async function loadHybridAnalysisHistory(timeframe = '') {
            try {
                const params = new URLSearchParams();
                params.append('limit', '10'); // Son 10 analiz
                if (timeframe) {
                    params.append('timeframe', timeframe);
                }
                
                const response = await fetch(`/api/analysis/history?${params.toString()}`);
                const data = await response.json();
                
                const tbody = document.getElementById('hybrid-history-table');
                
                if (data.analyses && data.analyses.length > 0) {
                    const historyHtml = data.analyses.map(analysis => {
                        const time = new Date(analysis.timestamp);
                        const tfClass = `hybrid-tf-${analysis.timeframe}`;
                        const badgeClass = `badge-${analysis.timeframe}`;
                        
                        const signalColor = analysis.signal === 'BUY' ? 'text-green-400' : 
                                          analysis.signal === 'SELL' ? 'text-red-400' : 
                                          'text-gray-400';
                        
                        const trendIcon = analysis.global_trend === 'BULLISH' ? '↗️' :
                                        analysis.global_trend === 'BEARISH' ? '↘️' : '➡️';
                        
                        const riskColor = analysis.currency_risk === 'LOW' ? 'text-green-400' :
                                        analysis.currency_risk === 'MEDIUM' ? 'text-yellow-400' :
                                        analysis.currency_risk === 'HIGH' ? 'text-red-400' : 'text-gray-400';
                        
                        return `
                            <tr class="${tfClass} border-b border-gray-700 hover:bg-slate-800/30 transition-all cursor-pointer" onclick="window.location.href='/analysis'">
                                <td class="py-2 text-xs">
                                    ${time.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
                                </td>
                                <td class="py-2">
                                    <span class="hybrid-tf-badge ${badgeClass}">${analysis.timeframe}</span>
                                </td>
                                <td class="py-2 text-xs">₺${analysis.price.toFixed(2)}</td>
                                <td class="py-2">
                                    <span class="${signalColor} font-semibold text-xs">
                                        ${analysis.signal === 'BUY' ? 'ALIŞ' : 
                                          analysis.signal === 'SELL' ? 'SATIŞ' : 
                                          'BEKLE'}
                                    </span>
                                </td>
                                <td class="py-2 text-xs">%${(analysis.confidence * 100).toFixed(0)}</td>
                                <td class="py-2 hidden sm:table-cell text-xs">${trendIcon}</td>
                                <td class="py-2 hidden md:table-cell">
                                    <span class="${riskColor} text-xs">${analysis.currency_risk}</span>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
                    tbody.innerHTML = historyHtml;
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-4 text-gray-400">
                                Henüz analiz geçmişi yok
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Hibrit analiz geçmişi yüklenemedi:', error);
                document.getElementById('hybrid-history-table').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4 text-red-400">
                            Yüklenirken hata oluştu
                        </td>
                    </tr>
                `;
            }
        }

        // Paralel veri yükleme fonksiyonu
        async function loadAllData() {
            try {
                // 1. EN KRİTİK: Anlık fiyatlar + Stats + Alerts anında yükle
                await Promise.allSettled([
                    loadCurrentPriceOnly(),
                    loadStats(),
                    loadActiveAlerts(),
                    loadMarketOverview()
                ]);
                console.log('✅ Anlık fiyatlar, istatistikler ve uyarılar yüklendi');
                
                // 2. Kısa gecikme sonrası kritik veriler (500ms bekle)
                setTimeout(async () => {
                    const criticalData = await Promise.allSettled([
                        loadHybridAnalysis(),
                        loadHybridAnalysisHistory() // Yeni eklendi
                    ]);
                    console.log('✅ Hibrit analiz yüklendi');
                }, 500);
                
                // 3. Grafik verilerini daha sonra yükle (1.75s bekle)
                setTimeout(async () => {
                    const chartData = await Promise.allSettled([
                        loadInitialPrices() // 30 dakikalık grafik verisi
                    ]);
                    console.log('✅ Grafik verileri yüklendi');
                }, 1750);
                
                // 4. En az kritik veriler en son (1.5s bekle)
                setTimeout(async () => {
                    const secondaryData = await Promise.allSettled([
                        loadSignals(),
                        loadDailyOpenPrices(),
                        loadLogStats(),
                        loadRecentErrors(),
                        loadSupportResistanceLevels(),
                        loadPerformanceMetrics()
                    ]);
                    console.log('✅ İkincil veriler yüklendi');
                }, 1500);
                
            } catch (error) {
                console.error('Veri yükleme hatası:', error);
            }
        }

        // Sayfa yüklendiğinde
        // Performans güncellemelerini işle
        function handlePerformanceUpdate(data) {
            // Son kapatılan pozisyon bildirimi
            if (data.last_closed_position) {
                const pos = data.last_closed_position;
                const pnlClass = pos.pnl >= 0 ? 'text-green-400' : 'text-red-400';
                const pnlSign = pos.pnl >= 0 ? '+' : '';
                
                // Toast bildirim göster (opsiyonel)
                showNotification(`Pozisyon kapatıldı: ${pos.timeframe} ${pos.signal} ${pnlSign}${pos.pnl.toFixed(2)}g (${pnlSign}${pos.pnl_pct.toFixed(1)}%)`, pos.pnl >= 0 ? 'success' : 'error');
            }
            
            // Açık pozisyon sayısını güncelle
            if (data.open_positions) {
                const openPosElement = document.getElementById('open-positions-count');
                if (openPosElement) {
                    openPosElement.textContent = data.open_positions.count;
                }
            }
            
            // Günlük performansı güncelle
            if (data.daily_performance) {
                const winRate = data.daily_performance.win_rate;
                const dailyWinrateElement = document.getElementById('daily-winrate');
                if (dailyWinrateElement) {
                    dailyWinrateElement.innerHTML = `${winRate.toFixed(1)}% <i class="fas fa-sync text-xs text-gray-400 ml-1" title="Otomatik güncellendi"></i>`;
                }
            }
        }
        
        // 24 saatlik fiyat aralığını yükle
        async function loadDailyPriceRange() {
            try {
                const response = await fetch('/api/market/daily-range');
                const data = await response.json();
                
                if (data.gram_altin) {
                    document.getElementById('daily-high').textContent = `₺${data.gram_altin.high.toFixed(2)}`;
                    document.getElementById('daily-low').textContent = `₺${data.gram_altin.low.toFixed(2)}`;
                } else {
                    // Fallback değerler
                    document.getElementById('daily-high').textContent = '-';
                    document.getElementById('daily-low').textContent = '-';
                }
            } catch (error) {
                console.error('Günlük fiyat aralığı yüklenemedi:', error);
                document.getElementById('daily-high').textContent = '-';
                document.getElementById('daily-low').textContent = '-';
            }
        }
        
        // Yeni sinyal bildirimi
        function handleNewSignal(signal) {
            showNotification(`Yeni ${signal.signal} sinyali: ${signal.timeframe} - ₺${signal.price.toFixed(2)}`, 'info');
            
            // Sinyal sayacını güncelle
            const signalCountElement = document.getElementById('today-signals');
            if (signalCountElement) {
                const currentCount = parseInt(signalCountElement.textContent) || 0;
                signalCountElement.textContent = currentCount + 1;
            }
            
            // Performans metriklerini yenile
            loadPerformanceMetrics();
        }
        
        // Bildirim göster
        function showNotification(message, type = 'info') {
            // Basit bir bildirim sistemi (toast notification)
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'} text-white`;
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 5 saniye sonra kaldır
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => notification.remove(), 500);
            }, 5000);
        }
        
        window.onload = () => {
            // Chart'ları hemen başlat
            initPriceChart();
            initCandleChart();
            
            // WebSocket bağlantısını başlat
            connectWebSocket();
            
            // Tüm verileri paralel yükle
            loadAllData();
            
            // Timeframe filter event listener
            document.getElementById('hybrid-timeframe-filter').addEventListener('change', function() {
                const selectedTimeframe = this.value;
                loadHybridAnalysisHistory(selectedTimeframe);
            });
            
            // Periyodik güncellemeler - daha uzun intervaller
            setInterval(loadStats, 45000);  // 45 saniye
            setInterval(loadActiveAlerts, 30000);  // 30 saniye - uyarılar daha sık kontrol edilmeli
            setInterval(loadMarketOverview, 30000);  // 30 saniye
            setInterval(() => {
                // Aktif butonu bul ve interval'ı al
                const activeBtn = document.querySelector('.candle-btn.bg-blue-800');
                if (activeBtn) {
                    const interval = activeBtn.textContent.replace('S', 'h').replace('G', 'd');
                    // 15 dakikalık değilse yenile
                    if (interval !== '15m') {
                        loadGramCandles(interval.toLowerCase(), activeBtn);
                    }
                }
            }, 90000);  // 90 saniye
            setInterval(loadHybridAnalysis, 90000);  // 90 saniye
            setInterval(loadHybridAnalysisHistory, 90000);  // 90 saniye - Yeni eklendi
            setInterval(loadSignals, 90000);  // 90 saniye
            setInterval(loadLogStats, 120000);  // 2 dakika
            setInterval(loadRecentErrors, 60000);  // 1 dakika
            setInterval(loadPerformanceMetrics, 60000);  // 1 dakika
        };
    </script>
{% endblock %}