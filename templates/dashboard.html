{% extends "base.html" %}

{% block title %}Dezy - Gold Price Dashboard{% endblock %}

{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 md:px-6 lg:px-8 xl:px-12 2xl:px-16 py-6">
    <!-- Header Stats -->
    <div class="dashboard-grid dashboard-grid--stats">
        <div class="stat-card">
            <h3 class="stat-card__label">Sistem Uptime</h3>
            <p class="stat-card__value" id="uptime">-</p>
        </div>
        <div class="stat-card">
            <h3 class="stat-card__label">Toplam Kayƒ±t</h3>
            <p class="stat-card__value" id="total-records">-</p>
        </div>
        <div class="stat-card">
            <h3 class="stat-card__label">Bug√ºnk√º Sinyal</h3>
            <p class="stat-card__value" id="today-signals">-</p>
        </div>
        <div class="stat-card">
            <h3 class="stat-card__label">WebSocket</h3>
            <p class="d-flex items-center gap-sm">
                <span class="nav__status-dot bg-error" id="ws-status"></span>
                <span id="status-text">Baƒülanƒ±yor...</span>
            </p>
        </div>
    </div>

    <!-- Current Prices -->
    <div class="glass-card mb-lg">
        <div class="glass-card__header">
            <h2 class="glass-card__title">
                <i class="fas fa-coins text-yellow"></i>
                Anlƒ±k Fiyatlar
            </h2>
        </div>
        <div class="glass-card__body">
            <div class="price-cards">
                <div class="price-card price-card--gold">
                    <span class="price-card__label">Gram Altƒ±n</span>
                    <div class="price-card__value" id="gram-altin">-</div>
                    <div class="price-card__change" id="gram-change">
                        <span>-</span>
                    </div>
                    <i class="fas fa-coins price-card__icon"></i>
                </div>
                <div class="price-card price-card--blue">
                    <span class="price-card__label">ONS/USD</span>
                    <div class="price-card__value" id="ons-usd">-</div>
                    <div class="price-card__change" id="ons-change">
                        <span>-</span>
                    </div>
                    <i class="fas fa-globe price-card__icon"></i>
                </div>
                <div class="price-card price-card--green">
                    <span class="price-card__label">USD/TRY</span>
                    <div class="price-card__value" id="usd-try">-</div>
                    <div class="price-card__change" id="usd-change">
                        <span>-</span>
                    </div>
                    <i class="fas fa-dollar-sign price-card__icon"></i>
                </div>
                <div class="price-card price-card--purple">
                    <span class="price-card__label">ONS/TRY</span>
                    <div class="price-card__value" id="ons-try">-</div>
                    <div class="price-card__change" id="ons-try-change">
                        <span>-</span>
                    </div>
                    <i class="fas fa-lira-sign price-card__icon"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Alerts - Kompakt ve Modern -->
    <div class="mb-lg" id="active-alerts-container" style="display: none;">
        <div id="alerts-list" class="space-y-3">
            <!-- Dinamik olarak doldurulacak -->
        </div>
    </div>

    <!-- Market Overview Widget -->
    <div class="glass-card mb-lg">
        <div class="glass-card__header">
            <h2 class="glass-card__title">
                <i class="fas fa-chart-line text-info"></i>
                Piyasa √ñzeti
            </h2>
        </div>
        <div class="glass-card__body">
            <div class="grid grid--cols-3 gap-4" id="market-overview-widget">
                <div class="text-center">
                    <p class="text-xs text-gray-400 mb-1">Gram Altƒ±n</p>
                    <p class="text-xl font-bold" id="mo-gram-price">-</p>
                    <p class="text-sm" id="mo-gram-change">-</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-400 mb-1">ONS/USD</p>
                    <p class="text-xl font-bold" id="mo-ons-price">-</p>
                    <p class="text-sm" id="mo-ons-change">-</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-400 mb-1">USD/TRY</p>
                    <p class="text-xl font-bold" id="mo-usd-price">-</p>
                    <p class="text-sm" id="mo-usd-change">-</p>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-700">
                <div class="grid grid--cols-2 gap-4">
                    <div>
                        <span class="text-xs text-gray-400">G√ºncel Trend:</span>
                        <span class="ml-2 font-semibold" id="mo-trend">-</span>
                    </div>
                    <div>
                        <span class="text-xs text-gray-400">Kur Riski:</span>
                        <span class="ml-2 font-semibold" id="mo-risk">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Market Overview & Quick Indicators -->
    <div class="grid grid--cols-4 mb-lg">
        <!-- Market Overview -->
        <div class="market-overview">
            <h2 class="market-overview__title">
                <i class="fas fa-chart-pie text-purple"></i>
                Piyasa Durumu
            </h2>
            <div class="market-overview__item">
                <span class="market-overview__label">Genel G√∂r√ºn√ºm</span>
                <span class="market-overview__value" id="market-overview">-</span>
            </div>
            <div class="market-overview__item">
                <span class="market-overview__label">Volatilite</span>
                <span class="market-overview__value" id="market-volatility">-</span>
            </div>
            <div class="market-overview__item">
                <span class="market-overview__label">24s En Y√ºksek</span>
                <span class="market-overview__value text-success" id="daily-high">-</span>
            </div>
            <div class="market-overview__item">
                <span class="market-overview__label">24s En D√º≈ü√ºk</span>
                <span class="market-overview__value text-error" id="daily-low">-</span>
            </div>
        </div>

        <!-- Technical Indicators -->
        <div class="market-overview">
            <h2 class="market-overview__title">
                <i class="fas fa-tachometer-alt text-warning"></i>
                Teknik G√∂stergeler
            </h2>
            <div class="market-overview__item">
                <span class="market-overview__label">RSI (14)</span>
                <span class="market-overview__value" id="rsi-value">-</span>
            </div>
            <div class="market-overview__item">
                <span class="market-overview__label">MACD</span>
                <span class="market-overview__value" id="macd-signal">-</span>
            </div>
            <div class="market-overview__item">
                <span class="market-overview__label">Bollinger</span>
                <span class="market-overview__value" id="bb-position">-</span>
            </div>
            <div class="market-overview__item">
                <span class="market-overview__label">Stochastic</span>
                <span class="market-overview__value" id="stoch-value">-</span>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="glass-card">
            <div class="glass-card__body">
                <h2 class="glass-card__title mb-md">
                    <i class="fas fa-bolt text-yellow"></i>
                    Hƒ±zlƒ± ƒ∞≈ülemler
                </h2>
                <div class="quick-actions">
                    <button onclick="runQuickAnalysis('1h')" class="quick-actions__button quick-actions__button--analyze">
                        <i class="fas fa-sync-alt"></i> 1S Analiz Yenile
                    </button>
                    <button onclick="runQuickAnalysis('4h')" class="quick-actions__button quick-actions__button--analyze">
                        <i class="fas fa-sync-alt"></i> 4S Analiz Yenile
                    </button>
                    <button onclick="exportData()" class="quick-actions__button quick-actions__button--export">
                        <i class="fas fa-download"></i> Veri ƒ∞ndir
                    </button>
                    <a href="/analysis" class="quick-actions__button quick-actions__button--details">
                        <i class="fas fa-chart-bar"></i> Detaylƒ± Analiz
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Advanced Indicators -->
        <div class="market-overview">
            <h2 class="market-overview__title">
                <i class="fas fa-chart-mixed text-info"></i>
                ƒ∞leri G√∂stergeler
            </h2>
            <div class="market-overview__item">
                <span class="market-overview__label">CCI</span>
                <span class="market-overview__value" id="cci-value">-</span>
            </div>
            <div class="market-overview__item">
                <span class="market-overview__label">MFI</span>
                <span class="market-overview__value" id="mfi-value">-</span>
            </div>
            <div class="market-overview__item">
                <span class="market-overview__label">Pattern</span>
                <span class="market-overview__value" id="pattern-name">-</span>
            </div>
            <div class="market-overview__item">
                <span class="market-overview__label">Trend G√ºc√º</span>
                <span class="market-overview__value" id="trend-strength">-</span>
            </div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="chart-grid chart-grid--2cols mb-lg">
        <!-- Price Chart -->
        <div class="chart-container">
            <div class="chart-container__header">
                <h2 class="chart-container__title">
                    <i class="fas fa-chart-line text-info"></i>
                    Son 30 Dakika - Gram Altƒ±n
                </h2>
            </div>
            <div class="chart-wrapper chart-height-lg">
                <canvas id="priceChart" class="chart-canvas"></canvas>
            </div>
        </div>
        
        <!-- Candle Chart -->
        <div class="chart-container">
            <div class="chart-container__header">
                <h2 class="chart-container__title">
                    <i class="fas fa-chart-area text-success"></i>
                    Gram Altƒ±n OHLC
                </h2>
                <div class="chart-container__controls">
                    <button onclick="loadGramCandles('1h', this)" class="chart-container__button candle-btn">1S</button>
                    <button onclick="loadGramCandles('4h', this)" class="chart-container__button candle-btn">4S</button>
                    <button onclick="loadGramCandles('1d', this)" class="chart-container__button candle-btn">1G</button>
                </div>
            </div>
            <div id="candleChart" class="candle-chart chart-height-lg"></div>
        </div>
    </div>

    <!-- Compact Hybrid Analysis -->
    <div class="glass-card mb-lg">
        <div class="glass-card__header">
            <h2 class="glass-card__title text-lg">
                <i class="fas fa-bullseye text-yellow"></i>
                Son Hibrit Analiz (1h, 4h, G√ºnl√ºk)
            </h2>
        </div>
        <div class="glass-card__body py-md">
            <div id="hybrid-analysis-container" class="compact-analysis">
                <p class="text-muted text-sm">Y√ºkleniyor...</p>
            </div>
        </div>
    </div>
    
    <!-- Signals -->
    <div class="glass-card mb-lg">
        <div class="glass-card__header d-flex justify-between items-center">
            <h2 class="glass-card__title">
                <i class="fas fa-bell text-yellow"></i>
                Son Trading Sinyalleri
            </h2>
            <a href="/signals" class="text-xs text-muted hover:text-yellow transition-colors">
                T√ºm√ºn√º G√∂r ‚Üí
            </a>
        </div>
        <div class="glass-card__body">
            <div id="signals-container" class="signals-container custom-scrollbar">
                <div class="text-center py-lg">
                    <i class="fas fa-spinner animate-rotate text-2xl text-muted"></i>
                    <p class="text-muted text-sm mt-sm">Y√ºkleniyor...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="glass-card mb-lg">
        <div class="glass-card__header">
            <h2 class="glass-card__title">
                <i class="fas fa-tachometer-alt text-info"></i>
                Performans Metrikleri
            </h2>
        </div>
        <div class="glass-card__body">
            <div class="grid grid--cols-4">
                <div class="stat-card">
                    <h3 class="stat-card__label">24s Deƒüi≈üim</h3>
                    <p class="stat-card__value" id="daily-change">-</p>
                    <p class="stat-card__change" id="daily-change-pct">-</p>
                </div>
                <div class="stat-card">
                    <h3 class="stat-card__label">Haftalƒ±k Ortalama</h3>
                    <p class="stat-card__value" id="weekly-avg">-</p>
                    <p class="stat-card__change" id="weekly-trend">-</p>
                </div>
                <div class="stat-card">
                    <h3 class="stat-card__label">Volatilite</h3>
                    <p class="stat-card__value" id="volatility-value">-</p>
                    <p class="stat-card__change" id="volatility-level">-</p>
                </div>
                <div class="stat-card">
                    <h3 class="stat-card__label">Sinyal Ba≈üarƒ±sƒ±</h3>
                    <p class="stat-card__value" id="signal-success">-</p>
                    <p class="stat-card__change" id="signal-count">-</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Support/Resistance Levels -->
    <div class="grid grid--cols-2 mb-lg">
        <div class="glass-card">
            <div class="glass-card__header">
                <h2 class="glass-card__title">
                    <i class="fas fa-shield-alt text-green"></i>
                    Destek Seviyeleri
                </h2>
            </div>
            <div class="glass-card__body">
                <div id="support-levels" class="levels-container">
                    <p class="text-muted">Y√ºkleniyor...</p>
                </div>
            </div>
        </div>
        <div class="glass-card">
            <div class="glass-card__header">
                <h2 class="glass-card__title">
                    <i class="fas fa-ban text-red"></i>
                    Diren√ß Seviyeleri
                </h2>
            </div>
            <div class="glass-card__body">
                <div id="resistance-levels" class="levels-container">
                    <p class="text-muted">Y√ºkleniyor...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs Section -->
    <div class="grid grid--cols-2">
        <!-- Log Stats -->
        <div class="glass-card">
            <div class="glass-card__header">
                <h2 class="glass-card__title">
                    <i class="fas fa-folder text-purple"></i>
                    Log Y√∂netimi
                </h2>
            </div>
            <div class="glass-card__body">
                <div class="grid grid--cols-2 gap-md">
                    <div class="stat-card">
                        <p class="stat-card__label">Toplam Boyut</p>
                        <p class="stat-card__value text-lg" id="log-total-size">-</p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-card__label">Dosya Sayƒ±sƒ±</p>
                        <p class="stat-card__value text-lg" id="log-file-count">-</p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-card__label">Sƒ±kƒ±≈ütƒ±rƒ±lmƒ±≈ü</p>
                        <p class="stat-card__value text-lg" id="log-compressed">-</p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-card__label">En Eski</p>
                        <p class="text-sm" id="log-oldest">-</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Error Logs -->
        <div class="glass-card">
            <div class="glass-card__header">
                <h2 class="glass-card__title">
                    <i class="fas fa-exclamation-triangle text-error"></i>
                    Son Hatalar
                </h2>
            </div>
            <div class="glass-card__body">
                <div id="error-logs" class="custom-scrollbar" style="max-height: 200px; overflow-y: auto;">
                    <p class="text-muted text-sm">Y√ºkleniyor...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script>
        // Summary text formatting function
        function formatSummaryText(text) {
            if (!text) return '';
            // Convert **text** to <strong>text</strong>
            return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }
        
        // WebSocket baƒülantƒ±sƒ±
        let ws = null;
        let priceChart = null;
        let candleChart = null;
        let priceData = [];

        // WebSocket baƒülan
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
            
            ws.onopen = () => {
                document.getElementById('status-text').textContent = 'Baƒülƒ±';
                document.getElementById('ws-status').classList.add('bg-success');
                document.getElementById('ws-status').classList.remove('bg-error');
            };
            
            ws.onclose = () => {
                document.getElementById('status-text').textContent = 'Baƒülantƒ± koptu';
                document.getElementById('ws-status').classList.remove('bg-success');
                document.getElementById('ws-status').classList.add('bg-error');
                setTimeout(connectWebSocket, 5000);
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'price_update') {
                    updateCurrentPrice(data.data);
                    addPriceToChart(data.data);
                }
            };
        }

        // G√ºnl√ºk a√ßƒ±lƒ±≈ü fiyatlarƒ± - ger√ßek API'den gelecek
        let dailyOpenPrices = {
            gram_altin: null,
            ons_usd: null,
            usd_try: null,
            ons_try: null
        };

        // Fiyat g√ºncelle
        function updateCurrentPrice(price) {
            // Gram Altƒ±n
            if (price.gram_altin) {
                document.getElementById('gram-altin').textContent = `‚Ç∫${price.gram_altin.toFixed(2)}`;
                
                // WebSocket'ten gelen g√ºnl√ºk deƒüi≈üim y√ºzdesini kullan
                if (price.daily_change_pct !== undefined && price.daily_change_pct !== null) {
                    updatePriceChangeFromPercent('gram-change', price.daily_change_pct);
                } else if (dailyOpenPrices.gram_altin) {
                    updatePriceChange('gram-change', dailyOpenPrices.gram_altin, price.gram_altin);
                }
            }
            
            // ONS/USD
            document.getElementById('ons-usd').textContent = `$${price.ons_usd.toFixed(2)}`;
            if (dailyOpenPrices.ons_usd) {
                updatePriceChange('ons-change', dailyOpenPrices.ons_usd, price.ons_usd);
            }
            
            // USD/TRY
            document.getElementById('usd-try').textContent = price.usd_try.toFixed(4);
            if (dailyOpenPrices.usd_try) {
                updatePriceChange('usd-change', dailyOpenPrices.usd_try, price.usd_try);
            }
            
            // ONS/TRY
            document.getElementById('ons-try').textContent = `‚Ç∫${price.ons_try.toFixed(2)}`;
            if (dailyOpenPrices.ons_try) {
                updatePriceChange('ons-try-change', dailyOpenPrices.ons_try, price.ons_try);
            }
        }

        // Fiyat deƒüi≈üimini g√∂ster
        function updatePriceChange(elementId, openPrice, currentPrice) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const change = ((currentPrice - openPrice) / openPrice) * 100;
            const changeText = change >= 0 ? `+${change.toFixed(2)}%` : `${change.toFixed(2)}%`;
            const colorClass = change >= 0 ? 'text-emerald-500' : 'text-rose-500';

            element.innerHTML = `
                <span class="${colorClass}">
                    <i class="fas fa-arrow-${change >= 0 ? 'up' : 'down'} mr-1 text-xs"></i>
                    ${changeText}
                </span>
            `;
        }
        
        // WebSocket'ten gelen y√ºzde deƒüeri ile fiyat deƒüi≈üimini g√∂ster
        function updatePriceChangeFromPercent(elementId, changePercent) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const change = parseFloat(changePercent);
            if (isNaN(change)) {
                element.innerHTML = '<span class="text-gray-400">-</span>';
                return;
            }

            const changeText = change >= 0 ? `+${change.toFixed(2)}%` : `${change.toFixed(2)}%`;
            const colorClass = change >= 0 ? 'text-emerald-500' : 'text-rose-500';

            element.innerHTML = `
                <span class="${colorClass}">
                    <i class="fas fa-arrow-${change >= 0 ? 'up' : 'down'} mr-1 text-xs"></i>
                    ${changeText}
                </span>
            `;
        }

        // G√ºnl√ºk a√ßƒ±lƒ±≈ü fiyatlarƒ±nƒ± y√ºkle
        async function loadDailyOpenPrices() {
            try {
                // Mock data - ger√ßek API endpoint eklenecek
                // API'den bug√ºn√ºn a√ßƒ±lƒ±≈ü fiyatlarƒ± veya 24 saat √∂nceki fiyatlar gelecek
                const response = await fetch('/api/prices/daily-open');
                const data = await response.json();
                
                if (data.prices) {
                    dailyOpenPrices = data.prices;
                }
            } catch (error) {
                console.error('G√ºnl√ºk a√ßƒ±lƒ±≈ü fiyatlarƒ± y√ºklenemedi:', error);
                // Fallback olarak ≈üu anki fiyatlarƒ± kullan
                const currentPrices = await fetch('/api/prices/latest');
                const data = await currentPrices.json();
                if (data.prices && data.prices.length > 0) {
                    const latest = data.prices[0];
                    dailyOpenPrices = {
                        gram_altin: latest.gram_altin,
                        ons_usd: latest.ons_usd,
                        usd_try: latest.usd_try,
                        ons_try: latest.ons_try
                    };
                }
            }
        }

        // ƒ∞statistikleri y√ºkle
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                document.getElementById('uptime').textContent = data.system.uptime || '-';
                document.getElementById('total-records').textContent = data.database.total_records?.toLocaleString() || '0';
                document.getElementById('today-signals').textContent = data.signals.today || '0';
            } catch (error) {
                console.error('Stats y√ºklenemedi:', error);
            }
        }

        // Fiyat grafiƒüi olu≈ütur
        function initPriceChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Gram Altƒ±n',
                        data: [],
                        borderColor: 'rgb(250, 204, 21)',
                        backgroundColor: 'rgba(250, 204, 21, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            ticks: { 
                                color: 'rgb(156, 163, 175)',
                                callback: function(value) {
                                    return '‚Ç∫' + value.toFixed(2);
                                }
                            },
                            grid: {
                                color: 'rgba(75, 85, 99, 0.3)'
                            }
                        },
                        x: {
                            ticks: { 
                                color: 'rgb(156, 163, 175)',
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 10
                            },
                            grid: {
                                color: 'rgba(75, 85, 99, 0.3)'
                            }
                        }
                    }
                }
            });
        }
        
        // Mum grafiƒüi olu≈ütur
        function initCandleChart() {
            const options = {
                chart: {
                    type: 'candlestick',
                    height: 350,
                    background: 'transparent',
                    toolbar: { show: false },
                    offsetY: -10
                },
                series: [{
                    name: 'OHLC',
                    data: []
                }],
                xaxis: {
                    type: 'datetime',
                    labels: {
                        style: { colors: '#9CA3AF' }
                    }
                },
                yaxis: {
                    labels: {
                        style: { colors: '#9CA3AF' },
                        formatter: (val) => '‚Ç∫' + val.toFixed(0),
                        offsetX: 0
                    },
                    tooltip: {
                        enabled: true
                    }
                },
                theme: { mode: 'dark' },
                plotOptions: {
                    candlestick: {
                        colors: {
                            upward: '#10b981',
                            downward: '#ef4444'
                        }
                    }
                },
                grid: {
                    borderColor: '#374151',
                    padding: {
                        top: 10,
                        right: 30,
                        bottom: 10,
                        left: 10
                    }
                }
            };
            
            candleChart = new ApexCharts(document.querySelector("#candleChart"), options);
            candleChart.render();
            loadGramCandles('1h');
        }
        
        // Gram altƒ±n mum verilerini y√ºkle
        async function loadGramCandles(interval, btnElement) {
            try {
                const response = await fetch(`/api/gram-candles/${interval}`);
                const data = await response.json();
                
                if (data.candles && data.candles.length > 0) {
                    const candleData = data.candles.map(c => ({
                        x: new Date(c.timestamp),
                        y: [c.open, c.high, c.low, c.close]
                    }));
                    
                    candleChart.updateSeries([{
                        name: 'OHLC',
                        data: candleData
                    }]);
                }
                
                // Buton stillerini g√ºncelle
                document.querySelectorAll('.candle-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-800');
                    btn.classList.add('bg-blue-600');
                });
                
                // Aktif butonu vurgula
                if (btnElement) {
                    btnElement.classList.remove('bg-blue-600');
                    btnElement.classList.add('bg-blue-800');
                }
            } catch (error) {
                console.error('Mum verileri y√ºklenemedi:', error);
            }
        }

        // Grafiƒüe fiyat ekle
        function addPriceToChart(price) {
            if (!priceChart) return;
            
            const time = new Date(price.timestamp);
            // Timestamp zaten T√ºrkiye saatinde geliyor, ekleme yapma
            const timeStr = time.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
            
            priceChart.data.labels.push(timeStr);
            priceChart.data.datasets[0].data.push(price.gram_altin);
            
            if (priceChart.data.labels.length > 360) {
                priceChart.data.labels.shift();
                priceChart.data.datasets[0].data.shift();
            }
            
            priceChart.update();
        }

        // Compact hibrit analiz sonu√ßlarƒ±nƒ± y√ºkle (sadece 1h, 4h, g√ºnl√ºk)
        async function loadHybridAnalysis() {
            try {
                // Son 3 farklƒ± timeframe'den analizleri al
                const responses = await Promise.allSettled([
                    fetch('/api/analysis/history?limit=1'),  // Son analiz (herhangi bir timeframe)
                    fetch('/api/analysis/indicators/1h'),
                    fetch('/api/analysis/indicators/4h'),
                    fetch('/api/analysis/indicators/1d')
                ]);
                
                const container = document.getElementById('hybrid-analysis-container');
                
                // Ana analizi g√∂ster
                if (responses[0].status === 'fulfilled') {
                    const data = await responses[0].value.json();
                    
                    if (data.analyses && data.analyses.length > 0) {
                        const analysis = data.analyses[0];
                        
                        // 15 dakikalƒ±k analizleri filtrele
                        if (analysis.timeframe === '15m') {
                            container.innerHTML = '<p class="text-gray-400 text-sm">15 dakikalƒ±k analizler g√∂sterilmiyor. 1h, 4h veya g√ºnl√ºk analiz bekleniyor...</p>';
                            return;
                        }
                        
                        const signalColor = analysis.signal === 'BUY' ? 'text-green-400' : 
                                          analysis.signal === 'SELL' ? 'text-red-400' : 
                                          'text-gray-400';
                        
                        // Teknik g√∂stergeleri g√ºncelle
                        updateTechnicalIndicators(analysis.details);
                        
                        // Piyasa durumunu g√ºncelle
                        updateMarketOverview(analysis);
                        
                        const time = new Date(analysis.timestamp);
                        
                        container.innerHTML = `
                            <!-- Compact Ana Sinyal -->
                            <div class="flex items-center justify-between p-3 bg-slate-800/30 rounded-lg mb-3">
                                <div class="flex items-center space-x-3">
                                    <div class="${signalColor}">
                                        <i class="fas ${analysis.signal === 'BUY' ? 'fa-arrow-up' : 
                                                      analysis.signal === 'SELL' ? 'fa-arrow-down' : 
                                                      'fa-minus'} text-lg"></i>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-sm">
                                            ${analysis.signal === 'BUY' ? 'ALI≈û' : 
                                              analysis.signal === 'SELL' ? 'SATI≈û' : 
                                              'BEKLE'} ‚Ä¢ ${analysis.timeframe}
                                        </div>
                                        <div class="text-xs text-gray-400">
                                            ‚Ç∫${analysis.price.toFixed(2)} ‚Ä¢ %${(analysis.confidence * 100).toFixed(0)} g√ºven
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-gray-400">${time.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}</div>
                                    ${analysis.risk_reward_ratio ? `<div class="text-xs ${analysis.risk_reward_ratio > 1.5 ? 'text-green-400' : 'text-yellow-400'}">R/R: ${analysis.risk_reward_ratio.toFixed(1)}</div>` : ''}
                                </div>
                            </div>
                            
                            <!-- Compact Piyasa Durumu -->
                            <div class="grid grid-cols-3 gap-2">
                                <div class="bg-slate-800/20 rounded p-2 text-center">
                                    <div class="text-xs text-gray-400 mb-1">Global Trend</div>
                                    <div class="text-sm font-semibold ${
                                        analysis.global_trend === 'BULLISH' ? 'text-green-400' :
                                        analysis.global_trend === 'BEARISH' ? 'text-red-400' :
                                        'text-yellow-400'
                                    }">
                                        ${analysis.global_trend === 'BULLISH' ? '‚ÜóÔ∏è Y√ºkseli≈ü' :
                                          analysis.global_trend === 'BEARISH' ? '‚ÜòÔ∏è D√º≈ü√º≈ü' :
                                          '‚û°Ô∏è Yatay'}
                                    </div>
                                </div>
                                
                                <div class="bg-slate-800/20 rounded p-2 text-center">
                                    <div class="text-xs text-gray-400 mb-1">Kur Riski</div>
                                    <div class="text-sm font-semibold ${
                                        analysis.currency_risk === 'LOW' ? 'text-green-400' :
                                        analysis.currency_risk === 'MEDIUM' ? 'text-yellow-400' :
                                        'text-red-400'
                                    }">
                                        ${analysis.currency_risk === 'LOW' ? 'üü¢ D√º≈ü√ºk' :
                                          analysis.currency_risk === 'MEDIUM' ? 'üü° Orta' :
                                          'üî¥ Y√ºksek'}
                                    </div>
                                </div>
                                
                                <div class="bg-slate-800/20 rounded p-2 text-center">
                                    <div class="text-xs text-gray-400 mb-1">Pozisyon</div>
                                    <div class="text-sm font-semibold text-blue-400">
                                        %${(analysis.position_size * 100).toFixed(0)}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Compact √ñzet -->
                            ${analysis.summary ? `
                            <div class="mt-3 p-2 bg-slate-900/30 rounded text-xs text-gray-300 leading-relaxed">
                                ${formatSummaryText(analysis.summary).substring(0, 150)}${analysis.summary.length > 150 ? '...' : ''}
                            </div>
                            ` : ''}
                        `;
                    } else {
                        container.innerHTML = '<p class="text-gray-400 text-sm">Hen√ºz hibrit analiz yok</p>';
                    }
                } else {
                    container.innerHTML = '<p class="text-red-400 text-sm">Analiz y√ºklenemedi</p>';
                }
            } catch (error) {
                console.error('Hibrit analiz y√ºklenemedi:', error);
                document.getElementById('hybrid-analysis-container').innerHTML = '<p class="text-red-400 text-sm">Analiz y√ºklenirken hata olu≈ütu</p>';
            }
        }

        // Teknik g√∂stergeleri g√ºncelle
        function updateTechnicalIndicators(details) {
            if (!details || !details.gram) return;

            const gram = details.gram;
            
            // RSI
            if (gram.rsi) {
                const rsiValue = gram.rsi.toFixed(1);
                let rsiClass = '';
                if (gram.rsi < 30) rsiClass = 'text-green-400';
                else if (gram.rsi > 70) rsiClass = 'text-red-400';
                else rsiClass = 'text-yellow-400';
                
                document.getElementById('rsi-value').innerHTML = `<span class="${rsiClass}">${rsiValue}</span>`;
            }

            // MACD
            document.getElementById('macd-signal').innerHTML = 
                `<span class="${gram.signal === 'BUY' ? 'text-green-400' : gram.signal === 'SELL' ? 'text-red-400' : 'text-yellow-400'}">
                    ${gram.signal || 'NEUTRAL'}
                </span>`;

            // Mock data i√ßin - ger√ßek API'den gelecek
            document.getElementById('bb-position').innerHTML = '<span class="text-yellow-400">MIDDLE</span>';
            document.getElementById('stoch-value').innerHTML = '<span class="text-blue-400">55.3</span>';
            
            // ƒ∞leri g√∂stergeler
            if (details.advanced_indicators) {
                const adv = details.advanced_indicators;
                
                // CCI
                if (adv.cci !== undefined && adv.cci !== null) {
                    const cciValue = adv.cci.toFixed(1);
                    let cciClass = '';
                    if (adv.cci < -100) cciClass = 'text-green-400';
                    else if (adv.cci > 100) cciClass = 'text-red-400';
                    else cciClass = 'text-yellow-400';
                    document.getElementById('cci-value').innerHTML = `<span class="${cciClass}">${cciValue}</span>`;
                }
                
                // MFI
                if (adv.mfi !== undefined && adv.mfi !== null) {
                    const mfiValue = adv.mfi.toFixed(1);
                    let mfiClass = '';
                    if (adv.mfi < 20) mfiClass = 'text-green-400';
                    else if (adv.mfi > 80) mfiClass = 'text-red-400';
                    else mfiClass = 'text-yellow-400';
                    document.getElementById('mfi-value').innerHTML = `<span class="${mfiClass}">${mfiValue}</span>`;
                }
            }
            
            // Pattern
            if (details.pattern && details.pattern.name) {
                const patternName = details.pattern.name !== 'None' ? details.pattern.name : 'Yok';
                const patternClass = details.pattern.signal === 'BUY' ? 'text-green-400' : 
                                   details.pattern.signal === 'SELL' ? 'text-red-400' : 'text-gray-400';
                document.getElementById('pattern-name').innerHTML = `<span class="${patternClass}">${patternName}</span>`;
            }
            
            // Trend g√ºc√º
            if (details.global && details.global.trend_strength) {
                const strength = details.global.trend_strength;
                const strengthText = strength === 'STRONG' ? 'G√º√ßl√º' : 
                                   strength === 'MODERATE' ? 'Orta' : 'Zayƒ±f';
                const strengthClass = strength === 'STRONG' ? 'text-green-400' : 
                                    strength === 'MODERATE' ? 'text-yellow-400' : 'text-gray-400';
                document.getElementById('trend-strength').innerHTML = `<span class="${strengthClass}">${strengthText}</span>`;
            }
        }

        // Piyasa durumunu g√ºncelle
        function updateMarketOverview(analysis) {
            // Genel g√∂r√ºn√ºm
            const trend = analysis.global_trend;
            let trendText = '';
            let trendClass = '';
            
            if (trend === 'BULLISH') {
                trendText = 'üìà Y√ºkseli≈ü';
                trendClass = 'text-green-400';
            } else if (trend === 'BEARISH') {
                trendText = 'üìâ D√º≈ü√º≈ü';
                trendClass = 'text-red-400';
            } else {
                trendText = '‚û°Ô∏è Yatay';
                trendClass = 'text-yellow-400';
            }
            
            document.getElementById('market-overview').innerHTML = `<span class="${trendClass}">${trendText}</span>`;
            
            // Mock data - ger√ßek API'den gelecek
            document.getElementById('market-volatility').innerHTML = '<span class="text-orange-400">Orta</span>';
            document.getElementById('daily-high').textContent = '‚Ç∫4,425.50';
            document.getElementById('daily-low').textContent = '‚Ç∫4,385.20';
        }
        
        // Sinyalleri y√ºkle
        async function loadSignals() {
            try {
                const response = await fetch('/api/signals/recent');
                const data = await response.json();
                
                const container = document.getElementById('signals-container');
                
                if (data.signals && data.signals.length > 0) {
                    // Son 10 sinyali g√∂ster
                    const recentSignals = data.signals.slice(0, 10);
                    
                    container.innerHTML = recentSignals.map(signal => {
                        const time = new Date(signal.timestamp);
                        const signalClass = signal.signal === 'BUY' ? 'bg-green-900/30 border-green-600/50' : 'bg-red-900/30 border-red-600/50';
                        const iconClass = signal.signal === 'BUY' ? 'text-green-400' : 'text-red-400';
                        const confidence = (signal.confidence * 100).toFixed(0);
                        
                        return `
                            <div class="${signalClass} border rounded-lg p-3 hover:bg-opacity-50 transition-all">
                                <div class="flex justify-between items-start">
                                    <div class="flex items-center space-x-3">
                                        <div class="${iconClass}">
                                            <i class="fas ${signal.signal === 'BUY' ? 'fa-arrow-circle-up' : 'fa-arrow-circle-down'} text-xl"></i>
                                        </div>
                                        <div>
                                            <div class="font-semibold text-sm">
                                                ${signal.signal === 'BUY' ? 'ALI≈û' : 'SATI≈û'} Sinyali
                                                <span class="ml-2 text-xs bg-slate-700 px-2 py-1 rounded">${signal.timeframe}</span>
                                            </div>
                                            <div class="text-xs text-gray-400 mt-1">
                                                Fiyat: ‚Ç∫${parseFloat(signal.gram_price).toFixed(2)}
                                                ${signal.stop_loss ? `‚Ä¢ SL: ‚Ç∫${parseFloat(signal.stop_loss).toFixed(2)}` : ''}
                                                ${signal.take_profit ? `‚Ä¢ TP: ‚Ç∫${parseFloat(signal.take_profit).toFixed(2)}` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs text-gray-400">
                                            ${time.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
                                        </div>
                                        <div class="text-xs mt-1">
                                            <span class="bg-slate-700 px-2 py-1 rounded">
                                                %${confidence} g√ºven
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                ${signal.risk_reward && signal.risk_reward > 0 ? `
                                <div class="mt-2 pt-2 border-t border-gray-700">
                                    <span class="text-xs text-gray-400">Risk/√ñd√ºl: ${signal.risk_reward.toFixed(2)}</span>
                                    ${signal.position_size ? `<span class="ml-3 text-xs text-gray-400">Pozisyon: %${(signal.position_size * 100).toFixed(0)}</span>` : ''}
                                </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-bell-slash text-4xl text-gray-600 mb-3"></i>
                            <p class="text-gray-400">Son 24 saatte sinyal √ºretilmedi</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Sinyaller y√ºklenemedi:', error);
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle text-yellow-400 mb-2"></i>
                        <p class="text-gray-400 text-sm">Sinyaller y√ºklenemedi</p>
                    </div>
                `;
            }
        }

        // Log istatistiklerini y√ºkle
        async function loadLogStats() {
            try {
                const response = await fetch('/api/logs/stats');
                const stats = await response.json();
                
                if (!stats.error) {
                    document.getElementById('log-total-size').textContent = `${stats.total_size_mb.toFixed(1)} MB`;
                    document.getElementById('log-file-count').textContent = stats.total_files;
                    document.getElementById('log-compressed').textContent = stats.compressed_files;
                    document.getElementById('log-oldest').textContent = stats.oldest_file || '-';
                }
            } catch (error) {
                console.error('Log stats y√ºklenemedi:', error);
            }
        }
        
        // Son hatalarƒ± y√ºkle
        async function loadRecentErrors() {
            try {
                const response = await fetch('/api/logs/recent-errors?count=5');
                const data = await response.json();
                
                const errorLogs = document.getElementById('error-logs');
                if (data.errors && data.errors.length > 0) {
                    errorLogs.innerHTML = data.errors.map(error => 
                        `<div class="text-red-400 text-xs p-1 border-b border-gray-700 break-all">${error}</div>`
                    ).join('');
                } else {
                    errorLogs.innerHTML = '<p class="text-green-400">Son zamanlarda hata yok üéâ</p>';
                }
            } catch (error) {
                console.error('Error logs y√ºklenemedi:', error);
            }
        }
        
        // Destek/Diren√ß seviyelerini y√ºkle
        async function loadSupportResistanceLevels() {
            try {
                const response = await fetch('/api/analysis/levels');
                const data = await response.json();
                
                const supportContainer = document.getElementById('support-levels');
                const resistanceContainer = document.getElementById('resistance-levels');
                
                // Destek seviyeleri
                if (data.support && data.support.length > 0) {
                    supportContainer.innerHTML = data.support.map(level => {
                        const strengthClass = level.strength === 'G√º√ßl√º' ? 'text-green-400' :
                                            level.strength === 'Orta' ? 'text-yellow-400' : 'text-gray-400';
                        return `
                            <div class="level-item">
                                <span class="level-price">‚Ç∫${level.level.toFixed(2)}</span>
                                <span class="level-strength ${strengthClass}">${level.strength}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    supportContainer.innerHTML = '<p class="text-muted text-sm">Veri yok</p>';
                }
                
                // Diren√ß seviyeleri
                if (data.resistance && data.resistance.length > 0) {
                    resistanceContainer.innerHTML = data.resistance.map(level => {
                        const strengthClass = level.strength === 'G√º√ßl√º' ? 'text-red-400' :
                                            level.strength === 'Orta' ? 'text-orange-400' : 'text-gray-400';
                        return `
                            <div class="level-item">
                                <span class="level-price">‚Ç∫${level.level.toFixed(2)}</span>
                                <span class="level-strength ${strengthClass}">${level.strength}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    resistanceContainer.innerHTML = '<p class="text-muted text-sm">Veri yok</p>';
                }
            } catch (error) {
                console.error('Destek/Diren√ß seviyeleri y√ºklenemedi:', error);
            }
        }
        
        // Performans metriklerini y√ºkle
        async function loadPerformanceMetrics() {
            try {
                const response = await fetch('/api/performance/metrics');
                const data = await response.json();
                
                // G√ºnl√ºk deƒüi≈üim
                document.getElementById('daily-change').textContent = `‚Ç∫${Math.abs(data.daily.change).toFixed(2)}`;
                const changeClass = data.daily.change_pct >= 0 ? 'text-green-400' : 'text-red-400';
                const changeIcon = data.daily.change_pct >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                document.getElementById('daily-change-pct').innerHTML = 
                    `<span class="${changeClass}"><i class="fas ${changeIcon} mr-1"></i>${data.daily.change_pct >= 0 ? '+' : ''}${data.daily.change_pct.toFixed(2)}%</span>`;
                
                // Haftalƒ±k ortalama
                document.getElementById('weekly-avg').textContent = `‚Ç∫${data.weekly.average.toFixed(2)}`;
                const trendClass = data.weekly.trend === 'Y√ºkseli≈ü' ? 'text-green-400' : 
                                  data.weekly.trend === 'D√º≈ü√º≈ü' ? 'text-red-400' : 'text-yellow-400';
                document.getElementById('weekly-trend').innerHTML = `<span class="${trendClass}">${data.weekly.trend}</span>`;
                
                // Volatilite
                document.getElementById('volatility-value').textContent = `${data.volatility.value.toFixed(2)}%`;
                const volClass = data.volatility.level === 'Y√ºksek' ? 'text-red-400' : 
                                data.volatility.level === 'Orta' ? 'text-orange-400' : 'text-green-400';
                document.getElementById('volatility-level').innerHTML = `<span class="${volClass}">${data.volatility.level}</span>`;
                
                // Sinyal ba≈üarƒ±sƒ±
                document.getElementById('signal-success').textContent = `${data.signals.success_rate.toFixed(1)}%`;
                document.getElementById('signal-count').innerHTML = 
                    `<span class="text-gray-400">${data.signals.actionable}/${data.signals.total} sinyal</span>`;
            } catch (error) {
                console.error('Performans metrikleri y√ºklenemedi:', error);
                // Hata durumunda varsayƒ±lan deƒüerler
                document.getElementById('daily-change').textContent = '‚Ç∫0.00';
                document.getElementById('daily-change-pct').innerHTML = '<span class="text-gray-400">-</span>';
                document.getElementById('weekly-avg').textContent = '‚Ç∫0.00';
                document.getElementById('weekly-trend').innerHTML = '<span class="text-gray-400">-</span>';
                document.getElementById('volatility-value').textContent = '-';
                document.getElementById('volatility-level').innerHTML = '<span class="text-gray-400">-</span>';
                document.getElementById('signal-success').textContent = '-';
                document.getElementById('signal-count').innerHTML = '<span class="text-gray-400">-</span>';
            }
        }

        // ƒ∞lk fiyatlarƒ± y√ºkle
        async function loadInitialPrices() {
            try {
                const response = await fetch('/api/prices/latest');
                const data = await response.json();
                
                if (data.prices && data.prices.length > 0) {
                    const latest = data.prices[data.prices.length - 1];
                    updateCurrentPrice(latest);
                    data.prices.forEach(price => addPriceToChart(price));
                }
            } catch (error) {
                console.error('Fiyatlar y√ºklenemedi:', error);
            }
        }
        
        // Hƒ±zlƒ± analiz √ßalƒ±≈ütƒ±r
        async function runQuickAnalysis(timeframe) {
            const btn = event.target;
            const originalText = btn.innerHTML;
            const originalClasses = btn.className;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Analiz yapƒ±lƒ±yor...';
            
            try {
                // Ger√ßek API √ßaƒürƒ±sƒ±
                const response = await fetch(`/api/analysis/trigger/${timeframe}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Ba≈üarƒ± mesajƒ±
                btn.className = originalClasses.replace(/from-\w+-600 to-\w+-600/, 'from-green-600 to-green-600');
                btn.innerHTML = '<i class="fas fa-check mr-1"></i> Tamamlandƒ±!';
                
                // 1 saniye bekle ve verileri yenile
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Analiz sonrasƒ± verileri yenile - sadece mevcut fonksiyonlarƒ± √ßaƒüƒ±r
                await Promise.all([
                    loadHybridAnalysis(),
                    loadInitialPrices(),
                    loadStats()
                ]);
                
                // Butonu eski haline d√∂nd√ºr
                setTimeout(() => {
                    btn.className = originalClasses;
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 1000);
                
            } catch (error) {
                console.error('Analiz hatasƒ±:', error);
                
                // Hata mesajƒ±
                btn.className = originalClasses.replace(/from-\w+-600 to-\w+-600/, 'from-red-600 to-red-600');
                btn.innerHTML = `<i class="fas fa-times mr-1"></i> ${error.message || 'Hata!'}`;
                
                // 3 saniye sonra eski haline d√∂nd√ºr
                setTimeout(() => {
                    btn.className = originalClasses;
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 3000);
            }
        }

        // loadPrices fonksiyonu - g√ºvenlik i√ßin wrapper
        async function loadPrices() {
            // loadInitialPrices fonksiyonunu √ßaƒüƒ±r
            return loadInitialPrices();
        }
        
        // Veri dƒ±≈üa aktarma
        async function exportData() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            const originalClasses = btn.className;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Hazƒ±rlanƒ±yor...';
            
            try {
                // Son 24 saatlik veriyi al
                const response = await fetch('/api/prices/latest');
                const data = await response.json();
                
                if (!data.prices || data.prices.length === 0) {
                    throw new Error('Veri bulunamadƒ±');
                }
                
                // CSV formatƒ±na √ßevir
                const csv = [
                    ['Zaman', 'Gram Altƒ±n (TRY)', 'ONS/USD', 'USD/TRY', 'ONS/TRY'].join(','),
                    ...data.prices.map(p => [
                        new Date(p.timestamp).toLocaleString('tr-TR'),
                        p.gram_altin.toFixed(2),
                        p.ons_usd.toFixed(2),
                        p.usd_try.toFixed(4),
                        p.ons_try.toFixed(2)
                    ].join(','))
                ].join('\n');
                
                // BOM ekle (Excel'de T√ºrk√ße karakterler i√ßin)
                const BOM = '\uFEFF';
                const csvWithBOM = BOM + csv;
                
                // Dosya olarak indir
                const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `dezy_gold_prices_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Ba≈üarƒ± mesajƒ±
                btn.className = originalClasses.replace(/from-\w+-600 to-\w+-600/, 'from-green-600 to-green-600');
                btn.innerHTML = '<i class="fas fa-check mr-1"></i> ƒ∞ndirildi!';
                
                setTimeout(() => {
                    btn.className = originalClasses;
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('Dƒ±≈üa aktarma hatasƒ±:', error);
                
                btn.className = originalClasses.replace(/from-\w+-600 to-\w+-600/, 'from-red-600 to-red-600');
                btn.innerHTML = '<i class="fas fa-times mr-1"></i> Hata!';
                
                setTimeout(() => {
                    btn.className = originalClasses;
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
            }
        }

        // Hƒ±zlƒ± fiyat g√ºncelleme fonksiyonu
        async function loadCurrentPriceOnly() {
            try {
                const response = await fetch('/api/prices/current');
                const data = await response.json();
                if (data && !data.error) {
                    updateCurrentPrice(data);
                }
            } catch (error) {
                console.error('Anlƒ±k fiyat y√ºklenemedi:', error);
            }
        }

        // Aktif uyarƒ±larƒ± y√ºkle
        async function loadActiveAlerts() {
            try {
                const response = await fetch('/api/alerts/active');
                const data = await response.json();
                
                const container = document.getElementById('active-alerts-container');
                const alertsList = document.getElementById('alerts-list');
                
                if (data.alerts && data.alerts.length > 0) {
                    container.style.display = 'block';
                    
                    alertsList.innerHTML = data.alerts.map(alert => {
                        let alertConfig = {};
                        
                        if (alert.type === 'SUPPORT_NEAR') {
                            alertConfig = {
                                bgColor: 'bg-gradient-to-r from-green-500/10 to-green-600/10',
                                borderColor: 'border-green-500/30',
                                icon: 'fa-shield-alt',
                                iconColor: 'text-green-400',
                                title: 'DESTEK SEVƒ∞YESƒ∞',
                                subtitle: 'Alƒ±m fƒ±rsatƒ± yakla≈üƒ±yor'
                            };
                        } else if (alert.type === 'RESISTANCE_NEAR') {
                            alertConfig = {
                                bgColor: 'bg-gradient-to-r from-red-500/10 to-red-600/10',
                                borderColor: 'border-red-500/30',
                                icon: 'fa-ban',
                                iconColor: 'text-red-400',
                                title: 'Dƒ∞REN√á SEVƒ∞YESƒ∞',
                                subtitle: 'Satƒ±≈ü fƒ±rsatƒ± yakla≈üƒ±yor'
                            };
                        } else if (alert.type === 'RAPID_CHANGE') {
                            alertConfig = {
                                bgColor: 'bg-gradient-to-r from-yellow-500/10 to-orange-600/10',
                                borderColor: 'border-yellow-500/30',
                                icon: 'fa-bolt',
                                iconColor: 'text-yellow-400',
                                title: 'HIZLI DEƒûƒ∞≈ûƒ∞M',
                                subtitle: 'Volatilite artƒ±≈üƒ±'
                            };
                        }
                        
                        return `
                            <div class="alert-card ${alertConfig.bgColor} ${alertConfig.borderColor} border rounded-xl p-4 backdrop-blur-sm">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-4">
                                        <div class="alert-icon ${alertConfig.iconColor} bg-slate-800/50 rounded-full p-3">
                                            <i class="fas ${alertConfig.icon} text-xl"></i>
                                        </div>
                                        <div>
                                            <div class="font-bold text-sm ${alertConfig.iconColor}">${alertConfig.title}</div>
                                            <div class="text-xs text-gray-400 mb-1">${alertConfig.subtitle}</div>
                                            <div class="text-sm text-gray-200">${alert.message}</div>
                                            ${alert.level ? `<div class="text-xs text-gray-400 mt-1">Hedef: ‚Ç∫${alert.level.toFixed(2)}</div>` : ''}
                                            ${alert.change_pct ? `<div class="text-xs text-gray-400 mt-1">Deƒüi≈üim: %${Math.abs(alert.change_pct).toFixed(1)}</div>` : ''}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs text-gray-400">
                                            ${new Date(alert.timestamp).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            ${alert.severity === 'HIGH' ? 'üî¥ Y√ºksek' : alert.severity === 'MEDIUM' ? 'üü° Orta' : 'üü¢ D√º≈ü√ºk'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.style.display = 'none';
                }
            } catch (error) {
                console.error('Uyarƒ±lar y√ºklenemedi:', error);
                container.style.display = 'none';
            }
        }

        // Market overview widget'ƒ± y√ºkle
        async function loadMarketOverview() {
            try {
                const response = await fetch('/api/market/overview');
                const data = await response.json();
                
                if (data.prices) {
                    // Gram Altƒ±n
                    if (data.prices.gram_altin) {
                        document.getElementById('mo-gram-price').textContent = `‚Ç∫${data.prices.gram_altin.value.toFixed(2)}`;
                        const changeClass = data.prices.gram_altin.change_pct >= 0 ? 'text-green-400' : 'text-red-400';
                        const changeIcon = data.prices.gram_altin.change_pct >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                        document.getElementById('mo-gram-change').innerHTML = 
                            `<span class="${changeClass}"><i class="fas ${changeIcon} mr-1"></i>${data.prices.gram_altin.change_pct >= 0 ? '+' : ''}${data.prices.gram_altin.change_pct.toFixed(2)}%</span>`;
                    }
                    
                    // ONS/USD
                    if (data.prices.ons_usd) {
                        document.getElementById('mo-ons-price').textContent = `$${data.prices.ons_usd.value.toFixed(2)}`;
                        const changeClass = data.prices.ons_usd.change_pct >= 0 ? 'text-green-400' : 'text-red-400';
                        const changeIcon = data.prices.ons_usd.change_pct >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                        document.getElementById('mo-ons-change').innerHTML = 
                            `<span class="${changeClass}"><i class="fas ${changeIcon} mr-1"></i>${data.prices.ons_usd.change_pct >= 0 ? '+' : ''}${data.prices.ons_usd.change_pct.toFixed(2)}%</span>`;
                    }
                    
                    // USD/TRY
                    if (data.prices.usd_try) {
                        document.getElementById('mo-usd-price').textContent = `${data.prices.usd_try.value.toFixed(4)}`;
                        const changeClass = data.prices.usd_try.change_pct >= 0 ? 'text-green-400' : 'text-red-400';
                        const changeIcon = data.prices.usd_try.change_pct >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                        document.getElementById('mo-usd-change').innerHTML = 
                            `<span class="${changeClass}"><i class="fas ${changeIcon} mr-1"></i>${data.prices.usd_try.change_pct >= 0 ? '+' : ''}${data.prices.usd_try.change_pct.toFixed(2)}%</span>`;
                    }
                }
                
                // Analiz bilgileri
                if (data.analysis) {
                    // Trend
                    const trendClass = data.analysis.signal === 'BUY' ? 'text-green-400' :
                                     data.analysis.signal === 'SELL' ? 'text-red-400' : 'text-yellow-400';
                    document.getElementById('mo-trend').innerHTML = 
                        `<span class="${trendClass}">${data.analysis.signal || 'Bilinmiyor'}</span>`;
                    
                    // Risk
                    const riskClass = data.analysis.currency_risk === 'LOW' ? 'text-green-400' :
                                    data.analysis.currency_risk === 'MEDIUM' ? 'text-yellow-400' :
                                    data.analysis.currency_risk === 'HIGH' ? 'text-red-400' : 'text-gray-400';
                    document.getElementById('mo-risk').innerHTML = 
                        `<span class="${riskClass}">${data.analysis.currency_risk || 'Bilinmiyor'}</span>`;
                }
            } catch (error) {
                console.error('Market overview y√ºklenemedi:', error);
            }
        }

        // Paralel veri y√ºkleme fonksiyonu
        async function loadAllData() {
            try {
                // 1. EN KRƒ∞Tƒ∞K: Anlƒ±k fiyatlar + Stats + Alerts anƒ±nda y√ºkle
                await Promise.allSettled([
                    loadCurrentPriceOnly(),
                    loadStats(),
                    loadActiveAlerts(),
                    loadMarketOverview()
                ]);
                console.log('‚úÖ Anlƒ±k fiyatlar, istatistikler ve uyarƒ±lar y√ºklendi');
                
                // 2. Kƒ±sa gecikme sonrasƒ± kritik veriler (500ms bekle)
                setTimeout(async () => {
                    const criticalData = await Promise.allSettled([
                        loadHybridAnalysis()
                    ]);
                    console.log('‚úÖ Hibrit analiz y√ºklendi');
                }, 500);
                
                // 3. Grafik verilerini daha sonra y√ºkle (1.75s bekle)
                setTimeout(async () => {
                    const chartData = await Promise.allSettled([
                        loadInitialPrices() // 30 dakikalƒ±k grafik verisi
                    ]);
                    console.log('‚úÖ Grafik verileri y√ºklendi');
                }, 1750);
                
                // 4. En az kritik veriler en son (1.5s bekle)
                setTimeout(async () => {
                    const secondaryData = await Promise.allSettled([
                        loadSignals(),
                        loadDailyOpenPrices(),
                        loadLogStats(),
                        loadRecentErrors(),
                        loadSupportResistanceLevels(),
                        loadPerformanceMetrics()
                    ]);
                    console.log('‚úÖ ƒ∞kincil veriler y√ºklendi');
                }, 1500);
                
            } catch (error) {
                console.error('Veri y√ºkleme hatasƒ±:', error);
            }
        }

        // Sayfa y√ºklendiƒüinde
        window.onload = () => {
            // Chart'larƒ± hemen ba≈ülat
            initPriceChart();
            initCandleChart();
            
            // WebSocket baƒülantƒ±sƒ±nƒ± ba≈ülat
            connectWebSocket();
            
            // T√ºm verileri paralel y√ºkle
            loadAllData();
            
            // Periyodik g√ºncellemeler - daha uzun intervaller
            setInterval(loadStats, 45000);  // 45 saniye
            setInterval(loadActiveAlerts, 30000);  // 30 saniye - uyarƒ±lar daha sƒ±k kontrol edilmeli
            setInterval(loadMarketOverview, 30000);  // 30 saniye
            setInterval(() => {
                // Aktif butonu bul ve interval'ƒ± al
                const activeBtn = document.querySelector('.candle-btn.bg-blue-800');
                if (activeBtn) {
                    const interval = activeBtn.textContent.replace('S', 'h').replace('G', 'd');
                    // 15 dakikalƒ±k deƒüilse yenile
                    if (interval !== '15m') {
                        loadGramCandles(interval.toLowerCase(), activeBtn);
                    }
                }
            }, 90000);  // 90 saniye
            setInterval(loadHybridAnalysis, 90000);  // 90 saniye
            setInterval(loadSignals, 90000);  // 90 saniye
            setInterval(loadLogStats, 120000);  // 2 dakika
            setInterval(loadRecentErrors, 60000);  // 1 dakika
            setInterval(loadPerformanceMetrics, 60000);  // 1 dakika
        };
    </script>
{% endblock %}