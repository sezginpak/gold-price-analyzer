{% extends "base.html" %}

{% block title %}Dezy - Gold Price Dashboard{% endblock %}

{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        .positive { color: #10b981; }
        .negative { color: #ef4444; }
        .log-line { font-family: monospace; font-size: 12px; }
        .error-log { color: #ef4444; }
        
        .analysis-summary {
            white-space: pre-line;
        }
        
        .analysis-summary strong,
        .analysis-summary b {
            font-weight: 600;
            color: #f8fafc;
        }
    </style>
{% endblock %}

{% block content %}
    <!-- Header Stats -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="glass-card rounded-lg p-4">
            <h3 class="text-xs lg:text-sm text-gray-400 mb-1">Sistem Uptime</h3>
            <p class="text-xl lg:text-2xl font-bold" id="uptime">-</p>
        </div>
        <div class="glass-card rounded-lg p-4">
            <h3 class="text-xs lg:text-sm text-gray-400 mb-1">Toplam Kayƒ±t</h3>
            <p class="text-xl lg:text-2xl font-bold" id="total-records">-</p>
        </div>
        <div class="glass-card rounded-lg p-4">
            <h3 class="text-xs lg:text-sm text-gray-400 mb-1">Bug√ºnk√º Sinyal</h3>
            <p class="text-xl lg:text-2xl font-bold" id="today-signals">-</p>
        </div>
        <div class="glass-card rounded-lg p-4">
            <h3 class="text-xs lg:text-sm text-gray-400 mb-1">WebSocket</h3>
            <p class="text-sm lg:text-base flex items-center">
                <span class="inline-block w-2 h-2 bg-red-500 rounded-full mr-2" id="ws-status"></span>
                <span id="status-text">Baƒülanƒ±yor...</span>
            </p>
        </div>
    </div>

    <!-- Current Prices -->
    <div class="glass-card rounded-lg p-4 lg:p-6 mb-6">
        <h2 class="text-lg lg:text-xl font-bold mb-4 flex items-center">
            <i class="fas fa-coins mr-2 text-yellow-400"></i>
            Anlƒ±k Fiyatlar
        </h2>
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-gradient-to-br from-amber-500/10 to-yellow-500/10 rounded-lg p-3 relative overflow-hidden border border-amber-500/20">
                <span class="text-gray-400 text-xs lg:text-sm">Gram Altƒ±n</span>
                <div class="text-xl lg:text-2xl font-bold text-amber-400" id="gram-altin">-</div>
                <div class="text-xs mt-1 flex items-center" id="gram-change">
                    <span class="mr-1">-</span>
                </div>
                <div class="absolute top-0 right-0 opacity-20">
                    <i class="fas fa-coins text-4xl text-amber-400"></i>
                </div>
            </div>
            <div class="bg-gradient-to-br from-blue-500/10 to-indigo-500/10 rounded-lg p-3 relative overflow-hidden border border-blue-500/20">
                <span class="text-gray-400 text-xs lg:text-sm">ONS/USD</span>
                <div class="text-xl lg:text-2xl font-bold text-blue-400" id="ons-usd">-</div>
                <div class="text-xs mt-1 flex items-center" id="ons-change">
                    <span class="mr-1">-</span>
                </div>
                <div class="absolute top-0 right-0 opacity-20">
                    <i class="fas fa-globe text-4xl text-blue-400"></i>
                </div>
            </div>
            <div class="bg-gradient-to-br from-emerald-500/10 to-green-500/10 rounded-lg p-3 relative overflow-hidden border border-emerald-500/20">
                <span class="text-gray-400 text-xs lg:text-sm">USD/TRY</span>
                <div class="text-xl lg:text-2xl font-bold text-emerald-400" id="usd-try">-</div>
                <div class="text-xs mt-1 flex items-center" id="usd-change">
                    <span class="mr-1">-</span>
                </div>
                <div class="absolute top-0 right-0 opacity-20">
                    <i class="fas fa-dollar-sign text-4xl text-emerald-400"></i>
                </div>
            </div>
            <div class="bg-gradient-to-br from-purple-500/10 to-pink-500/10 rounded-lg p-3 relative overflow-hidden border border-purple-500/20">
                <span class="text-gray-400 text-xs lg:text-sm">ONS/TRY</span>
                <div class="text-xl lg:text-2xl font-bold text-purple-400" id="ons-try">-</div>
                <div class="text-xs mt-1 flex items-center" id="ons-try-change">
                    <span class="mr-1">-</span>
                </div>
                <div class="absolute top-0 right-0 opacity-20">
                    <i class="fas fa-lira-sign text-4xl text-purple-400"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Market Overview & Quick Indicators -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- Market Overview -->
        <div class="glass-card rounded-lg p-4 lg:p-6">
            <h2 class="text-lg lg:text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-chart-pie mr-2 text-purple-400"></i>
                Piyasa Durumu
            </h2>
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-gray-400 text-sm">Genel G√∂r√ºn√ºm</span>
                    <span class="font-bold" id="market-overview">-</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-400 text-sm">Volatilite</span>
                    <span class="font-bold" id="market-volatility">-</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-400 text-sm">24s En Y√ºksek</span>
                    <span class="font-bold text-green-400" id="daily-high">-</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-400 text-sm">24s En D√º≈ü√ºk</span>
                    <span class="font-bold text-red-400" id="daily-low">-</span>
                </div>
            </div>
        </div>

        <!-- Technical Indicators -->
        <div class="glass-card rounded-lg p-4 lg:p-6">
            <h2 class="text-lg lg:text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-tachometer-alt mr-2 text-orange-400"></i>
                Teknik G√∂stergeler
            </h2>
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-gray-400 text-sm">RSI (14)</span>
                    <span class="font-bold" id="rsi-value">-</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-400 text-sm">MACD</span>
                    <span class="font-bold" id="macd-signal">-</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-400 text-sm">Bollinger</span>
                    <span class="font-bold" id="bb-position">-</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-400 text-sm">Stochastic</span>
                    <span class="font-bold" id="stoch-value">-</span>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="glass-card rounded-lg p-4 lg:p-6">
            <h2 class="text-lg lg:text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-bolt mr-2 text-yellow-400"></i>
                Hƒ±zlƒ± ƒ∞≈ülemler
            </h2>
            <div class="space-y-2">
                <button onclick="runQuickAnalysis('15m')" class="w-full px-3 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 rounded-lg text-sm transition-all duration-200 hover:scale-105 shadow-lg">
                    <i class="fas fa-sync-alt mr-1"></i> 15D Analiz Yenile
                </button>
                <button onclick="runQuickAnalysis('1h')" class="w-full px-3 py-2 bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-700 hover:to-green-700 rounded-lg text-sm transition-all duration-200 hover:scale-105 shadow-lg">
                    <i class="fas fa-sync-alt mr-1"></i> 1S Analiz Yenile
                </button>
                <button onclick="exportData()" class="w-full px-3 py-2 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 rounded-lg text-sm transition-all duration-200 hover:scale-105 shadow-lg">
                    <i class="fas fa-download mr-1"></i> Veri ƒ∞ndir
                </button>
                <a href="/analysis" class="block w-full px-3 py-2 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 rounded-lg text-sm transition-all duration-200 hover:scale-105 shadow-lg text-center">
                    <i class="fas fa-chart-bar mr-1"></i> Detaylƒ± Analiz
                </a>
            </div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Price Chart -->
        <div class="glass-card rounded-lg p-4 lg:p-6">
            <h2 class="text-lg lg:text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-chart-line mr-2 text-blue-400"></i>
                Son 30 Dakika - Gram Altƒ±n
            </h2>
            <div class="relative h-64 lg:h-80">
                <canvas id="priceChart"></canvas>
            </div>
        </div>
        
        <!-- Candle Chart -->
        <div class="glass-card rounded-lg p-4 lg:p-6">
            <h2 class="text-lg lg:text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-chart-area mr-2 text-green-400"></i>
                Gram Altƒ±n OHLC
            </h2>
            <div class="mb-2 flex flex-wrap gap-2">
                <button onclick="loadGramCandles('15m', this)" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm transition-colors candle-btn">15D</button>
                <button onclick="loadGramCandles('1h', this)" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm transition-colors candle-btn">1S</button>
                <button onclick="loadGramCandles('4h', this)" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm transition-colors candle-btn">4S</button>
                <button onclick="loadGramCandles('1d', this)" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm transition-colors candle-btn">1G</button>
            </div>
            <div id="candleChart" class="h-80 lg:h-96"></div>
        </div>
    </div>

    <!-- Hybrid Analysis -->
    <div class="glass-card rounded-lg p-4 lg:p-6 mb-6">
        <h2 class="text-lg lg:text-xl font-bold mb-4 flex items-center">
            <i class="fas fa-bullseye mr-2 text-yellow-400"></i>
            Son Hibrit Analiz
        </h2>
        <div id="hybrid-analysis-container" class="space-y-2">
            <p class="text-gray-400">Y√ºkleniyor...</p>
        </div>
    </div>
    
    <!-- Signals -->
    <div class="glass-card rounded-lg p-4 lg:p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg lg:text-xl font-bold flex items-center">
                <i class="fas fa-bell mr-2 text-yellow-400"></i>
                Son Trading Sinyalleri
            </h2>
            <a href="/signals" class="text-xs text-gray-400 hover:text-yellow-400 transition-colors">
                T√ºm√ºn√º G√∂r ‚Üí
            </a>
        </div>
        <div id="signals-container" class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar">
            <div class="text-center py-4">
                <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
                <p class="text-gray-400 text-sm mt-2">Y√ºkleniyor...</p>
            </div>
        </div>
    </div>

    <!-- Logs Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Log Stats -->
        <div class="glass-card rounded-lg p-4 lg:p-6">
            <h2 class="text-lg lg:text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-folder mr-2 text-purple-400"></i>
                Log Y√∂netimi
            </h2>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-800/50 rounded-lg p-3">
                    <p class="text-gray-400 text-xs">Toplam Boyut</p>
                    <p class="text-lg font-bold" id="log-total-size">-</p>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3">
                    <p class="text-gray-400 text-xs">Dosya Sayƒ±sƒ±</p>
                    <p class="text-lg font-bold" id="log-file-count">-</p>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3">
                    <p class="text-gray-400 text-xs">Sƒ±kƒ±≈ütƒ±rƒ±lmƒ±≈ü</p>
                    <p class="text-lg font-bold" id="log-compressed">-</p>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3">
                    <p class="text-gray-400 text-xs">En Eski</p>
                    <p class="text-sm" id="log-oldest">-</p>
                </div>
            </div>
        </div>
        
        <!-- Error Logs -->
        <div class="glass-card rounded-lg p-4 lg:p-6">
            <h2 class="text-lg lg:text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-exclamation-triangle mr-2 text-red-400"></i>
                Son Hatalar
            </h2>
            <div id="error-logs" class="space-y-1 max-h-48 overflow-y-auto">
                <p class="text-gray-400 text-sm">Y√ºkleniyor...</p>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // Summary text formatting function
        function formatSummaryText(text) {
            if (!text) return '';
            // Convert **text** to <strong>text</strong>
            return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }
        
        // WebSocket baƒülantƒ±sƒ±
        let ws = null;
        let priceChart = null;
        let candleChart = null;
        let priceData = [];

        // WebSocket baƒülan
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
            
            ws.onopen = () => {
                document.getElementById('status-text').textContent = 'Baƒülƒ±';
                document.getElementById('ws-status').classList.add('bg-green-500');
                document.getElementById('ws-status').classList.remove('bg-red-500');
            };
            
            ws.onclose = () => {
                document.getElementById('status-text').textContent = 'Baƒülantƒ± koptu';
                document.getElementById('ws-status').classList.remove('bg-green-500');
                document.getElementById('ws-status').classList.add('bg-red-500');
                setTimeout(connectWebSocket, 5000);
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'price_update') {
                    updateCurrentPrice(data.data);
                    addPriceToChart(data.data);
                }
            };
        }

        // G√ºnl√ºk a√ßƒ±lƒ±≈ü fiyatlarƒ± - ger√ßek API'den gelecek
        let dailyOpenPrices = {
            gram_altin: null,
            ons_usd: null,
            usd_try: null,
            ons_try: null
        };

        // Fiyat g√ºncelle
        function updateCurrentPrice(price) {
            // Gram Altƒ±n
            if (price.gram_altin) {
                document.getElementById('gram-altin').textContent = `‚Ç∫${price.gram_altin.toFixed(2)}`;
                if (dailyOpenPrices.gram_altin) {
                    updatePriceChange('gram-change', dailyOpenPrices.gram_altin, price.gram_altin);
                }
            }
            
            // ONS/USD
            document.getElementById('ons-usd').textContent = `$${price.ons_usd.toFixed(2)}`;
            if (dailyOpenPrices.ons_usd) {
                updatePriceChange('ons-change', dailyOpenPrices.ons_usd, price.ons_usd);
            }
            
            // USD/TRY
            document.getElementById('usd-try').textContent = price.usd_try.toFixed(4);
            if (dailyOpenPrices.usd_try) {
                updatePriceChange('usd-change', dailyOpenPrices.usd_try, price.usd_try);
            }
            
            // ONS/TRY
            document.getElementById('ons-try').textContent = `‚Ç∫${price.ons_try.toFixed(2)}`;
            if (dailyOpenPrices.ons_try) {
                updatePriceChange('ons-try-change', dailyOpenPrices.ons_try, price.ons_try);
            }
        }

        // Fiyat deƒüi≈üimini g√∂ster
        function updatePriceChange(elementId, openPrice, currentPrice) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const change = ((currentPrice - openPrice) / openPrice) * 100;
            const changeText = change >= 0 ? `+${change.toFixed(2)}%` : `${change.toFixed(2)}%`;
            const colorClass = change >= 0 ? 'text-emerald-500' : 'text-rose-500';

            element.innerHTML = `
                <span class="${colorClass}">
                    <i class="fas fa-arrow-${change >= 0 ? 'up' : 'down'} mr-1 text-xs"></i>
                    ${changeText}
                </span>
            `;
        }

        // G√ºnl√ºk a√ßƒ±lƒ±≈ü fiyatlarƒ±nƒ± y√ºkle
        async function loadDailyOpenPrices() {
            try {
                // Mock data - ger√ßek API endpoint eklenecek
                // API'den bug√ºn√ºn a√ßƒ±lƒ±≈ü fiyatlarƒ± veya 24 saat √∂nceki fiyatlar gelecek
                const response = await fetch('/api/prices/daily-open');
                const data = await response.json();
                
                if (data.prices) {
                    dailyOpenPrices = data.prices;
                }
            } catch (error) {
                console.error('G√ºnl√ºk a√ßƒ±lƒ±≈ü fiyatlarƒ± y√ºklenemedi:', error);
                // Fallback olarak ≈üu anki fiyatlarƒ± kullan
                const currentPrices = await fetch('/api/prices/latest');
                const data = await currentPrices.json();
                if (data.prices && data.prices.length > 0) {
                    const latest = data.prices[0];
                    dailyOpenPrices = {
                        gram_altin: latest.gram_altin,
                        ons_usd: latest.ons_usd,
                        usd_try: latest.usd_try,
                        ons_try: latest.ons_try
                    };
                }
            }
        }

        // ƒ∞statistikleri y√ºkle
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                document.getElementById('uptime').textContent = data.system.uptime || '-';
                document.getElementById('total-records').textContent = data.database.total_records?.toLocaleString() || '0';
                document.getElementById('today-signals').textContent = data.signals.today || '0';
            } catch (error) {
                console.error('Stats y√ºklenemedi:', error);
            }
        }

        // Fiyat grafiƒüi olu≈ütur
        function initPriceChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Gram Altƒ±n',
                        data: [],
                        borderColor: 'rgb(250, 204, 21)',
                        backgroundColor: 'rgba(250, 204, 21, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            ticks: { 
                                color: 'rgb(156, 163, 175)',
                                callback: function(value) {
                                    return '‚Ç∫' + value.toFixed(2);
                                }
                            },
                            grid: {
                                color: 'rgba(75, 85, 99, 0.3)'
                            }
                        },
                        x: {
                            ticks: { 
                                color: 'rgb(156, 163, 175)',
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 10
                            },
                            grid: {
                                color: 'rgba(75, 85, 99, 0.3)'
                            }
                        }
                    }
                }
            });
        }
        
        // Mum grafiƒüi olu≈ütur
        function initCandleChart() {
            const options = {
                chart: {
                    type: 'candlestick',
                    height: 350,
                    background: 'transparent',
                    toolbar: { show: false },
                    offsetY: -10
                },
                series: [{
                    name: 'OHLC',
                    data: []
                }],
                xaxis: {
                    type: 'datetime',
                    labels: {
                        style: { colors: '#9CA3AF' }
                    }
                },
                yaxis: {
                    labels: {
                        style: { colors: '#9CA3AF' },
                        formatter: (val) => '‚Ç∫' + val.toFixed(0),
                        offsetX: 0
                    },
                    tooltip: {
                        enabled: true
                    }
                },
                theme: { mode: 'dark' },
                plotOptions: {
                    candlestick: {
                        colors: {
                            upward: '#10b981',
                            downward: '#ef4444'
                        }
                    }
                },
                grid: {
                    borderColor: '#374151',
                    padding: {
                        top: 10,
                        right: 30,
                        bottom: 10,
                        left: 10
                    }
                }
            };
            
            candleChart = new ApexCharts(document.querySelector("#candleChart"), options);
            candleChart.render();
            loadGramCandles('15m');
        }
        
        // Gram altƒ±n mum verilerini y√ºkle
        async function loadGramCandles(interval, btnElement) {
            try {
                const response = await fetch(`/api/gram-candles/${interval}`);
                const data = await response.json();
                
                if (data.candles && data.candles.length > 0) {
                    const candleData = data.candles.map(c => ({
                        x: new Date(c.timestamp),
                        y: [c.open, c.high, c.low, c.close]
                    }));
                    
                    candleChart.updateSeries([{
                        name: 'OHLC',
                        data: candleData
                    }]);
                }
                
                // Buton stillerini g√ºncelle
                document.querySelectorAll('.candle-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-800');
                    btn.classList.add('bg-blue-600');
                });
                
                // Aktif butonu vurgula
                if (btnElement) {
                    btnElement.classList.remove('bg-blue-600');
                    btnElement.classList.add('bg-blue-800');
                }
            } catch (error) {
                console.error('Mum verileri y√ºklenemedi:', error);
            }
        }

        // Grafiƒüe fiyat ekle
        function addPriceToChart(price) {
            if (!priceChart) return;
            
            const time = new Date(price.timestamp);
            const trTime = new Date(time.getTime() + (3 * 60 * 60 * 1000));
            const timeStr = trTime.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
            
            priceChart.data.labels.push(timeStr);
            priceChart.data.datasets[0].data.push(price.gram_altin);
            
            if (priceChart.data.labels.length > 360) {
                priceChart.data.labels.shift();
                priceChart.data.datasets[0].data.shift();
            }
            
            priceChart.update();
        }

        // Hibrit analiz sonu√ßlarƒ±nƒ± y√ºkle
        async function loadHybridAnalysis() {
            try {
                const response = await fetch('/api/analysis/history?limit=1');
                const data = await response.json();
                
                const container = document.getElementById('hybrid-analysis-container');
                
                if (data.analyses && data.analyses.length > 0) {
                    const analysis = data.analyses[0];
                    const signalColor = analysis.signal === 'BUY' ? 'text-green-400' : 
                                      analysis.signal === 'SELL' ? 'text-red-400' : 
                                      'text-gray-400';
                    
                    // Teknik g√∂stergeleri g√ºncelle
                    updateTechnicalIndicators(analysis.details);
                    
                    // Piyasa durumunu g√ºncelle
                    updateMarketOverview(analysis);
                    
                    const time = new Date(analysis.timestamp);
                    const signalBg = analysis.signal === 'BUY' ? 'bg-green-900/20 border-green-600/30' : 
                                   analysis.signal === 'SELL' ? 'bg-red-900/20 border-red-600/30' : 
                                   'bg-gray-900/20 border-gray-600/30';
                    
                    container.innerHTML = `
                        <div class="space-y-4">
                            <!-- Ana Sinyal Kartƒ± -->
                            <div class="${signalBg} border rounded-lg p-4">
                                <div class="flex justify-between items-center mb-3">
                                    <div class="flex items-center space-x-3">
                                        <div class="${signalColor}">
                                            <i class="fas ${analysis.signal === 'BUY' ? 'fa-arrow-trend-up' : 
                                                          analysis.signal === 'SELL' ? 'fa-arrow-trend-down' : 
                                                          'fa-minus'} text-2xl"></i>
                                        </div>
                                        <div>
                                            <div class="font-bold text-lg">
                                                ${analysis.signal === 'BUY' ? 'ALI≈û' : 
                                                  analysis.signal === 'SELL' ? 'SATI≈û' : 
                                                  'BEKLE'} Sinyali
                                            </div>
                                            <div class="text-xs text-gray-400">
                                                ${time.toLocaleString('tr-TR')} ‚Ä¢ ${analysis.timeframe}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-2xl font-bold ${signalColor}">
                                            %${(analysis.confidence * 100).toFixed(0)}
                                        </div>
                                        <div class="text-xs text-gray-400">G√ºven Oranƒ±</div>
                                    </div>
                                </div>
                                
                                <!-- Detay Bilgiler -->
                                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-3">
                                    <div class="bg-slate-800/50 rounded p-2">
                                        <div class="text-xs text-gray-400">Fiyat</div>
                                        <div class="font-semibold">‚Ç∫${analysis.price.toFixed(2)}</div>
                                    </div>
                                    <div class="bg-slate-800/50 rounded p-2">
                                        <div class="text-xs text-gray-400">Pozisyon</div>
                                        <div class="font-semibold">%${(analysis.position_size * 100).toFixed(0)}</div>
                                    </div>
                                    ${analysis.stop_loss ? `
                                    <div class="bg-slate-800/50 rounded p-2">
                                        <div class="text-xs text-gray-400">Stop Loss</div>
                                        <div class="font-semibold text-red-400">‚Ç∫${analysis.stop_loss.toFixed(2)}</div>
                                    </div>
                                    ` : ''}
                                    ${analysis.take_profit ? `
                                    <div class="bg-slate-800/50 rounded p-2">
                                        <div class="text-xs text-gray-400">Take Profit</div>
                                        <div class="font-semibold text-green-400">‚Ç∫${analysis.take_profit.toFixed(2)}</div>
                                    </div>
                                    ` : ''}
                                </div>
                                
                                <!-- √ñzet -->
                                <div class="bg-slate-900/50 rounded p-3">
                                    <div class="text-sm text-gray-300 leading-relaxed analysis-summary">${formatSummaryText(analysis.summary)}</div>
                                </div>
                            </div>
                            
                            <!-- Piyasa Durumu -->
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
                                <div class="bg-slate-800/50 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-xs text-gray-400">Global Trend</span>
                                        <i class="fas fa-globe text-blue-400"></i>
                                    </div>
                                    <div class="font-semibold ${
                                        analysis.global_trend === 'BULLISH' ? 'text-green-400' :
                                        analysis.global_trend === 'BEARISH' ? 'text-red-400' :
                                        'text-yellow-400'
                                    }">
                                        ${analysis.global_trend === 'BULLISH' ? '‚Üë Y√ºkseli≈ü' :
                                          analysis.global_trend === 'BEARISH' ? '‚Üì D√º≈ü√º≈ü' :
                                          '‚Üí Yatay'} 
                                    </div>
                                    <div class="text-xs text-gray-400 mt-1">
                                        G√º√ß: ${analysis.global_trend_strength || 'Orta'}
                                    </div>
                                </div>
                                
                                <div class="bg-slate-800/50 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-xs text-gray-400">Para Birimi Riski</span>
                                        <i class="fas fa-dollar-sign text-yellow-400"></i>
                                    </div>
                                    <div class="font-semibold ${
                                        analysis.currency_risk === 'LOW' ? 'text-green-400' :
                                        analysis.currency_risk === 'MEDIUM' ? 'text-yellow-400' :
                                        'text-red-400'
                                    }">
                                        ${analysis.currency_risk === 'LOW' ? 'D√º≈ü√ºk' :
                                          analysis.currency_risk === 'MEDIUM' ? 'Orta' :
                                          'Y√ºksek'} Risk
                                    </div>
                                    <div class="text-xs text-gray-400 mt-1">
                                        USD/TRY Volatilitesi
                                    </div>
                                </div>
                                
                                <div class="bg-slate-800/50 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-xs text-gray-400">Risk/√ñd√ºl</span>
                                        <i class="fas fa-balance-scale text-purple-400"></i>
                                    </div>
                                    <div class="font-semibold ${
                                        analysis.risk_reward_ratio > 2 ? 'text-green-400' :
                                        analysis.risk_reward_ratio > 1 ? 'text-yellow-400' :
                                        'text-red-400'
                                    }">
                                        ${analysis.risk_reward_ratio ? analysis.risk_reward_ratio.toFixed(2) : '-'}
                                    </div>
                                    <div class="text-xs text-gray-400 mt-1">
                                        ${analysis.risk_reward_ratio > 2 ? '√áok ƒ∞yi' :
                                          analysis.risk_reward_ratio > 1 ? 'ƒ∞yi' :
                                          'Riskli'}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- √ñneriler -->
                            ${analysis.recommendations && analysis.recommendations.length > 0 ? `
                            <div class="bg-slate-800/30 rounded-lg p-3">
                                <div class="text-xs text-gray-400 mb-2 flex items-center">
                                    <i class="fas fa-lightbulb mr-1 text-yellow-400"></i>
                                    √ñneriler
                                </div>
                                <ul class="space-y-1">
                                    ${analysis.recommendations.slice(0, 3).map(rec => `
                                        <li class="text-sm text-gray-300 flex items-start">
                                            <span class="text-yellow-400 mr-2">‚Ä¢</span>
                                            <span>${rec}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                            ` : ''}
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p class="text-gray-400">Hen√ºz hibrit analiz yok</p>';
                }
            } catch (error) {
                console.error('Hibrit analiz y√ºklenemedi:', error);
            }
        }

        // Teknik g√∂stergeleri g√ºncelle
        function updateTechnicalIndicators(details) {
            if (!details || !details.gram) return;

            const gram = details.gram;
            
            // RSI
            if (gram.rsi) {
                const rsiValue = gram.rsi.toFixed(1);
                let rsiClass = '';
                if (gram.rsi < 30) rsiClass = 'text-green-400';
                else if (gram.rsi > 70) rsiClass = 'text-red-400';
                else rsiClass = 'text-yellow-400';
                
                document.getElementById('rsi-value').innerHTML = `<span class="${rsiClass}">${rsiValue}</span>`;
            }

            // MACD
            document.getElementById('macd-signal').innerHTML = 
                `<span class="${gram.signal === 'BUY' ? 'text-green-400' : gram.signal === 'SELL' ? 'text-red-400' : 'text-yellow-400'}">
                    ${gram.signal || 'NEUTRAL'}
                </span>`;

            // Mock data i√ßin - ger√ßek API'den gelecek
            document.getElementById('bb-position').innerHTML = '<span class="text-yellow-400">MIDDLE</span>';
            document.getElementById('stoch-value').innerHTML = '<span class="text-blue-400">55.3</span>';
        }

        // Piyasa durumunu g√ºncelle
        function updateMarketOverview(analysis) {
            // Genel g√∂r√ºn√ºm
            const trend = analysis.global_trend;
            let trendText = '';
            let trendClass = '';
            
            if (trend === 'BULLISH') {
                trendText = 'üìà Y√ºkseli≈ü';
                trendClass = 'text-green-400';
            } else if (trend === 'BEARISH') {
                trendText = 'üìâ D√º≈ü√º≈ü';
                trendClass = 'text-red-400';
            } else {
                trendText = '‚û°Ô∏è Yatay';
                trendClass = 'text-yellow-400';
            }
            
            document.getElementById('market-overview').innerHTML = `<span class="${trendClass}">${trendText}</span>`;
            
            // Mock data - ger√ßek API'den gelecek
            document.getElementById('market-volatility').innerHTML = '<span class="text-orange-400">Orta</span>';
            document.getElementById('daily-high').textContent = '‚Ç∫4,425.50';
            document.getElementById('daily-low').textContent = '‚Ç∫4,385.20';
        }
        
        // Sinyalleri y√ºkle
        async function loadSignals() {
            try {
                const response = await fetch('/api/signals/recent');
                const data = await response.json();
                
                const container = document.getElementById('signals-container');
                
                if (data.signals && data.signals.length > 0) {
                    // Son 10 sinyali g√∂ster
                    const recentSignals = data.signals.slice(0, 10);
                    
                    container.innerHTML = recentSignals.map(signal => {
                        const time = new Date(signal.timestamp);
                        const signalClass = signal.signal === 'BUY' ? 'bg-green-900/30 border-green-600/50' : 'bg-red-900/30 border-red-600/50';
                        const iconClass = signal.signal === 'BUY' ? 'text-green-400' : 'text-red-400';
                        const confidence = (signal.confidence * 100).toFixed(0);
                        
                        return `
                            <div class="${signalClass} border rounded-lg p-3 hover:bg-opacity-50 transition-all">
                                <div class="flex justify-between items-start">
                                    <div class="flex items-center space-x-3">
                                        <div class="${iconClass}">
                                            <i class="fas ${signal.signal === 'BUY' ? 'fa-arrow-circle-up' : 'fa-arrow-circle-down'} text-xl"></i>
                                        </div>
                                        <div>
                                            <div class="font-semibold text-sm">
                                                ${signal.signal === 'BUY' ? 'ALI≈û' : 'SATI≈û'} Sinyali
                                                <span class="ml-2 text-xs bg-slate-700 px-2 py-1 rounded">${signal.timeframe}</span>
                                            </div>
                                            <div class="text-xs text-gray-400 mt-1">
                                                Fiyat: ‚Ç∫${parseFloat(signal.gram_price).toFixed(2)}
                                                ${signal.stop_loss ? `‚Ä¢ SL: ‚Ç∫${parseFloat(signal.stop_loss).toFixed(2)}` : ''}
                                                ${signal.take_profit ? `‚Ä¢ TP: ‚Ç∫${parseFloat(signal.take_profit).toFixed(2)}` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs text-gray-400">
                                            ${time.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
                                        </div>
                                        <div class="text-xs mt-1">
                                            <span class="bg-slate-700 px-2 py-1 rounded">
                                                %${confidence} g√ºven
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                ${signal.risk_reward && signal.risk_reward > 0 ? `
                                <div class="mt-2 pt-2 border-t border-gray-700">
                                    <span class="text-xs text-gray-400">Risk/√ñd√ºl: ${signal.risk_reward.toFixed(2)}</span>
                                    ${signal.position_size ? `<span class="ml-3 text-xs text-gray-400">Pozisyon: %${(signal.position_size * 100).toFixed(0)}</span>` : ''}
                                </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-bell-slash text-4xl text-gray-600 mb-3"></i>
                            <p class="text-gray-400">Son 24 saatte sinyal √ºretilmedi</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Sinyaller y√ºklenemedi:', error);
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle text-yellow-400 mb-2"></i>
                        <p class="text-gray-400 text-sm">Sinyaller y√ºklenemedi</p>
                    </div>
                `;
            }
        }

        // Log istatistiklerini y√ºkle
        async function loadLogStats() {
            try {
                const response = await fetch('/api/logs/stats');
                const stats = await response.json();
                
                if (!stats.error) {
                    document.getElementById('log-total-size').textContent = `${stats.total_size_mb.toFixed(1)} MB`;
                    document.getElementById('log-file-count').textContent = stats.total_files;
                    document.getElementById('log-compressed').textContent = stats.compressed_files;
                    document.getElementById('log-oldest').textContent = stats.oldest_file || '-';
                }
            } catch (error) {
                console.error('Log stats y√ºklenemedi:', error);
            }
        }
        
        // Son hatalarƒ± y√ºkle
        async function loadRecentErrors() {
            try {
                const response = await fetch('/api/logs/recent-errors?count=5');
                const data = await response.json();
                
                const errorLogs = document.getElementById('error-logs');
                if (data.errors && data.errors.length > 0) {
                    errorLogs.innerHTML = data.errors.map(error => 
                        `<div class="text-red-400 text-xs p-1 border-b border-gray-700 break-all">${error}</div>`
                    ).join('');
                } else {
                    errorLogs.innerHTML = '<p class="text-green-400">Son zamanlarda hata yok üéâ</p>';
                }
            } catch (error) {
                console.error('Error logs y√ºklenemedi:', error);
            }
        }

        // ƒ∞lk fiyatlarƒ± y√ºkle
        async function loadInitialPrices() {
            try {
                const response = await fetch('/api/prices/latest');
                const data = await response.json();
                
                if (data.prices && data.prices.length > 0) {
                    const latest = data.prices[data.prices.length - 1];
                    updateCurrentPrice(latest);
                    data.prices.forEach(price => addPriceToChart(price));
                }
            } catch (error) {
                console.error('Fiyatlar y√ºklenemedi:', error);
            }
        }
        
        // Hƒ±zlƒ± analiz √ßalƒ±≈ütƒ±r
        async function runQuickAnalysis(timeframe) {
            const btn = event.target;
            const originalText = btn.innerHTML;
            const originalClasses = btn.className;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Analiz yapƒ±lƒ±yor...';
            
            try {
                // Ger√ßek API √ßaƒürƒ±sƒ±
                const response = await fetch(`/api/analysis/trigger/${timeframe}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Ba≈üarƒ± mesajƒ±
                btn.className = originalClasses.replace(/from-\w+-600 to-\w+-600/, 'from-green-600 to-green-600');
                btn.innerHTML = '<i class="fas fa-check mr-1"></i> Tamamlandƒ±!';
                
                // 1 saniye bekle ve verileri yenile
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Analiz sonrasƒ± verileri yenile - sadece mevcut fonksiyonlarƒ± √ßaƒüƒ±r
                await Promise.all([
                    loadHybridAnalysis(),
                    loadInitialPrices(),
                    loadStats()
                ]);
                
                // Butonu eski haline d√∂nd√ºr
                setTimeout(() => {
                    btn.className = originalClasses;
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 1000);
                
            } catch (error) {
                console.error('Analiz hatasƒ±:', error);
                
                // Hata mesajƒ±
                btn.className = originalClasses.replace(/from-\w+-600 to-\w+-600/, 'from-red-600 to-red-600');
                btn.innerHTML = `<i class="fas fa-times mr-1"></i> ${error.message || 'Hata!'}`;
                
                // 3 saniye sonra eski haline d√∂nd√ºr
                setTimeout(() => {
                    btn.className = originalClasses;
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 3000);
            }
        }

        // loadPrices fonksiyonu - g√ºvenlik i√ßin wrapper
        async function loadPrices() {
            // loadInitialPrices fonksiyonunu √ßaƒüƒ±r
            return loadInitialPrices();
        }
        
        // Veri dƒ±≈üa aktarma
        async function exportData() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            const originalClasses = btn.className;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Hazƒ±rlanƒ±yor...';
            
            try {
                // Son 24 saatlik veriyi al
                const response = await fetch('/api/prices/latest');
                const data = await response.json();
                
                if (!data.prices || data.prices.length === 0) {
                    throw new Error('Veri bulunamadƒ±');
                }
                
                // CSV formatƒ±na √ßevir
                const csv = [
                    ['Zaman', 'Gram Altƒ±n (TRY)', 'ONS/USD', 'USD/TRY', 'ONS/TRY'].join(','),
                    ...data.prices.map(p => [
                        new Date(p.timestamp).toLocaleString('tr-TR'),
                        p.gram_altin.toFixed(2),
                        p.ons_usd.toFixed(2),
                        p.usd_try.toFixed(4),
                        p.ons_try.toFixed(2)
                    ].join(','))
                ].join('\n');
                
                // BOM ekle (Excel'de T√ºrk√ße karakterler i√ßin)
                const BOM = '\uFEFF';
                const csvWithBOM = BOM + csv;
                
                // Dosya olarak indir
                const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `dezy_gold_prices_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Ba≈üarƒ± mesajƒ±
                btn.className = originalClasses.replace(/from-\w+-600 to-\w+-600/, 'from-green-600 to-green-600');
                btn.innerHTML = '<i class="fas fa-check mr-1"></i> ƒ∞ndirildi!';
                
                setTimeout(() => {
                    btn.className = originalClasses;
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('Dƒ±≈üa aktarma hatasƒ±:', error);
                
                btn.className = originalClasses.replace(/from-\w+-600 to-\w+-600/, 'from-red-600 to-red-600');
                btn.innerHTML = '<i class="fas fa-times mr-1"></i> Hata!';
                
                setTimeout(() => {
                    btn.className = originalClasses;
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
            }
        }

        // Hƒ±zlƒ± fiyat g√ºncelleme fonksiyonu
        async function loadCurrentPriceOnly() {
            try {
                const response = await fetch('/api/prices/current');
                const data = await response.json();
                if (data && !data.error) {
                    updateCurrentPrice(data);
                }
            } catch (error) {
                console.error('Anlƒ±k fiyat y√ºklenemedi:', error);
            }
        }

        // Paralel veri y√ºkleme fonksiyonu
        async function loadAllData() {
            try {
                // 1. EN KRƒ∞Tƒ∞K: Anlƒ±k fiyatlar + Stats anƒ±nda y√ºkle
                await Promise.allSettled([
                    loadCurrentPriceOnly(),
                    loadStats()  // ƒ∞statistikleri de hemen y√ºkle
                ]);
                console.log('‚úÖ Anlƒ±k fiyatlar ve istatistikler y√ºklendi');
                
                // 2. Kƒ±sa gecikme sonrasƒ± kritik veriler (500ms bekle)
                setTimeout(async () => {
                    const criticalData = await Promise.allSettled([
                        loadHybridAnalysis()
                    ]);
                    console.log('‚úÖ Hibrit analiz y√ºklendi');
                }, 500);
                
                // 3. Grafik verilerini daha sonra y√ºkle (1.75s bekle)
                setTimeout(async () => {
                    const chartData = await Promise.allSettled([
                        loadInitialPrices() // 30 dakikalƒ±k grafik verisi
                    ]);
                    console.log('‚úÖ Grafik verileri y√ºklendi');
                }, 1750);
                
                // 4. En az kritik veriler en son (1.5s bekle)
                setTimeout(async () => {
                    const secondaryData = await Promise.allSettled([
                        loadSignals(),
                        loadDailyOpenPrices(),
                        loadLogStats(),
                        loadRecentErrors()
                    ]);
                    console.log('‚úÖ ƒ∞kincil veriler y√ºklendi');
                }, 1500);
                
            } catch (error) {
                console.error('Veri y√ºkleme hatasƒ±:', error);
            }
        }

        // Sayfa y√ºklendiƒüinde
        window.onload = () => {
            // Chart'larƒ± hemen ba≈ülat
            initPriceChart();
            initCandleChart();
            
            // WebSocket baƒülantƒ±sƒ±nƒ± ba≈ülat
            connectWebSocket();
            
            // T√ºm verileri paralel y√ºkle
            loadAllData();
            
            // Periyodik g√ºncellemeler - daha uzun intervaller
            setInterval(loadStats, 45000);  // 45 saniye
            setInterval(() => {
                // Aktif butonu bul ve interval'ƒ± al
                const activeBtn = document.querySelector('.candle-btn.bg-blue-800');
                if (activeBtn) {
                    const interval = activeBtn.textContent.replace('D', 'm').replace('S', 'h').replace('G', 'd');
                    loadGramCandles(interval.toLowerCase(), activeBtn);
                }
            }, 90000);  // 90 saniye
            setInterval(loadHybridAnalysis, 90000);  // 90 saniye
            setInterval(loadSignals, 90000);  // 90 saniye
            setInterval(loadLogStats, 120000);  // 2 dakika
            setInterval(loadRecentErrors, 60000);  // 1 dakika
        };
    </script>
{% endblock %}