{% extends "base.html" %}

{% block title %}Hibrit Analiz Detayları - Dezy - Gold Price Analyzer{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="/static/css/modules/market-regime.css">
    <link rel="stylesheet" href="/static/css/modules/divergence.css">
    <link rel="stylesheet" href="/static/css/modules/fibonacci-smc.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/market-regime.js"></script>
    <script src="/static/js/divergence.js"></script>
    <script src="/static/js/fibonacci-smc.js"></script>
    <style>
        .indicator-box {
            background: rgba(55, 65, 81, 0.5);
            border: 1px solid rgba(75, 85, 99, 0.5);
        }
        .indicator-box:hover {
            background: rgba(64, 73, 82, 0.7);
        }
        .strength-strong { color: #10b981; }
        .strength-moderate { color: #f59e0b; }
        .strength-weak { color: #6b7280; }
        
        /* Timeframe renkleri - Daha ayırt edici */
        .timeframe-15m {
            background-color: rgba(59, 130, 246, 0.2); /* Parlak Mavi */
            border-left: 3px solid rgb(59, 130, 246);
        }
        .timeframe-1h {
            background-color: rgba(16, 185, 129, 0.2); /* Zümrüt Yeşili */
            border-left: 3px solid rgb(16, 185, 129);
        }
        .timeframe-4h {
            background-color: rgba(217, 70, 239, 0.2); /* Mor/Fuşya */
            border-left: 3px solid rgb(217, 70, 239);
        }
        .timeframe-1d {
            background-color: rgba(251, 146, 60, 0.2); /* Turuncu */
            border-left: 3px solid rgb(251, 146, 60);
        }
        .timeframe-15m:hover {
            background-color: rgba(59, 130, 246, 0.3);
        }
        .timeframe-1h:hover {
            background-color: rgba(16, 185, 129, 0.3);
        }
        .timeframe-4h:hover {
            background-color: rgba(217, 70, 239, 0.3);
        }
        .timeframe-1d:hover {
            background-color: rgba(251, 146, 60, 0.3);
        }
        
        /* Timeframe badge renkleri */
        .tf-badge-15m {
            background-color: rgb(59, 130, 246);
            color: white;
        }
        .tf-badge-1h {
            background-color: rgb(16, 185, 129);
            color: white;
        }
        .tf-badge-4h {
            background-color: rgb(217, 70, 239);
            color: white;
        }
        .tf-badge-1d {
            background-color: rgb(251, 146, 60);
            color: white;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="space-y-6">
        <!-- Page Title -->
        <h1 class="text-xl lg:text-2xl font-bold gradient-text flex items-center">
            <i class="fas fa-bullseye mr-3 text-yellow-400"></i>
            Hibrit Analiz Detayları
        </h1>

        <!-- Zaman Dilimi Seçici -->
        <div class="glass-card rounded-lg p-4">
            <label class="text-xs lg:text-sm text-gray-400 mr-2 lg:mr-4">Zaman Dilimi:</label>
            <select id="timeframe-selector" class="bg-slate-700 text-white px-3 py-1 lg:px-4 lg:py-2 rounded text-sm lg:text-base">
                <option value="" selected>Tümü</option>
                <option value="15m">15 Dakika</option>
                <option value="1h">1 Saat</option>
                <option value="4h">4 Saat</option>
                <option value="1d">Günlük</option>
            </select>
        </div>
        
        <!-- Sistem Durumu -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-4">
            <div class="glass-card rounded-lg p-3 lg:p-4">
                <p class="text-gray-400 text-xs lg:text-sm">Ana Fiyat</p>
                <p class="text-base lg:text-xl font-bold text-yellow-400">GRAM ALTIN</p>
            </div>
            <div class="glass-card rounded-lg p-3 lg:p-4">
                <p class="text-gray-400 text-xs lg:text-sm">Trend Kaynağı</p>
                <p class="text-base lg:text-xl font-bold text-blue-400">ONS/USD</p>
            </div>
            <div class="glass-card rounded-lg p-3 lg:p-4">
                <p class="text-gray-400 text-xs lg:text-sm">Risk Değerlendirme</p>
                <p class="text-base lg:text-xl font-bold text-red-400">USD/TRY</p>
            </div>
            <div class="glass-card rounded-lg p-3 lg:p-4">
                <p class="text-gray-400 text-xs lg:text-sm">Son Analiz</p>
                <p class="text-base lg:text-xl font-bold" id="last-analysis-time">-</p>
            </div>
        </div>

        <!-- Mevcut Hibrit Analiz -->
        <div class="glass-card rounded-lg p-4 lg:p-6">
            <h3 class="text-lg lg:text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-bolt mr-2 text-yellow-400"></i>
                Mevcut Hibrit Analiz
            </h3>
            <div id="current-hybrid-analysis" class="grid grid-cols-2 lg:grid-cols-3 gap-3 lg:gap-4">
                <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                    <p class="text-gray-400 text-xs lg:text-sm">Sinyal</p>
                    <p class="text-xl lg:text-3xl font-bold" id="current-signal">-</p>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                    <p class="text-gray-400 text-xs lg:text-sm">Güven</p>
                    <p class="text-xl lg:text-3xl font-bold" id="current-confidence">-</p>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                    <p class="text-gray-400 text-xs lg:text-sm">Pozisyon</p>
                    <p class="text-xl lg:text-3xl font-bold" id="current-position">-</p>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                    <p class="text-gray-400 text-xs lg:text-sm">Global Trend</p>
                    <p class="text-base lg:text-xl font-bold" id="current-global-trend">-</p>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                    <p class="text-gray-400 text-xs lg:text-sm">Kur Riski</p>
                    <p class="text-base lg:text-xl font-bold" id="current-currency-risk">-</p>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                    <p class="text-gray-400 text-xs lg:text-sm">Risk/Ödül</p>
                    <p class="text-base lg:text-xl font-bold" id="current-risk-reward">-</p>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-600">
                <h4 class="font-semibold mb-2 text-sm lg:text-base flex items-center">
                    <i class="fas fa-clipboard mr-2 text-blue-400"></i>
                    Analiz Özeti
                </h4>
                <p class="text-gray-300 text-xs lg:text-sm" id="current-summary">Yükleniyor...</p>
            </div>
            <div class="mt-4">
                <h4 class="font-semibold mb-2 text-sm lg:text-base flex items-center">
                    <i class="fas fa-lightbulb mr-2 text-yellow-400"></i>
                    Öneriler
                </h4>
                <ul class="text-gray-300 text-xs lg:text-sm space-y-1" id="current-recommendations">
                    <li>Yükleniyor...</li>
                </ul>
            </div>
        </div>

        <!-- Analiz Bileşenleri -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6">
            <!-- Gram Altın Analizi -->
            <div class="glass-card rounded-lg p-4 lg:p-6">
                <h3 class="text-base lg:text-lg font-bold mb-4 text-yellow-400 flex items-center">
                    <i class="fas fa-coins mr-2"></i>
                    Gram Altın Analizi
                </h3>
                <div class="space-y-2 lg:space-y-3">
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">Fiyat:</span>
                        <span class="font-bold text-yellow-400" id="gram-price">-</span>
                    </div>
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">Trend:</span>
                        <span class="font-bold" id="gram-trend">-</span>
                    </div>
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">RSI:</span>
                        <span class="font-bold" id="gram-rsi">-</span>
                    </div>
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">Sinyal:</span>
                        <span class="font-bold" id="gram-signal">-</span>
                    </div>
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">Stop Loss:</span>
                        <span class="font-bold text-red-400" id="gram-stop-loss">-</span>
                    </div>
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">Take Profit:</span>
                        <span class="font-bold text-green-400" id="gram-take-profit">-</span>
                    </div>
                </div>
            </div>

            <!-- Global Trend Analizi -->
            <div class="glass-card rounded-lg p-4 lg:p-6">
                <h3 class="text-base lg:text-lg font-bold mb-4 text-blue-400 flex items-center">
                    <i class="fas fa-globe mr-2"></i>
                    Global Trend Analizi
                </h3>
                <div class="space-y-2 lg:space-y-3">
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">Yön:</span>
                        <span class="font-bold" id="global-direction">-</span>
                    </div>
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">Güç:</span>
                        <span class="font-bold" id="global-strength">-</span>
                    </div>
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">Momentum:</span>
                        <span class="font-bold" id="global-momentum">-</span>
                    </div>
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">Volatilite:</span>
                        <span class="font-bold" id="global-volatility">-</span>
                    </div>
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">Destekleyici:</span>
                        <span class="font-bold" id="global-supportive">-</span>
                    </div>
                </div>
            </div>

            <!-- Kur Riski Analizi -->
            <div class="glass-card rounded-lg p-4 lg:p-6">
                <h3 class="text-base lg:text-lg font-bold mb-4 text-red-400 flex items-center">
                    <i class="fas fa-exchange-alt mr-2"></i>
                    Kur Riski Analizi
                </h3>
                <div class="space-y-2 lg:space-y-3">
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">Risk Seviyesi:</span>
                        <span class="font-bold" id="currency-risk-level">-</span>
                    </div>
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">Volatilite:</span>
                        <span class="font-bold" id="currency-volatility">-</span>
                    </div>
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">Pozisyon Çarpan:</span>
                        <span class="font-bold" id="currency-multiplier">-</span>
                    </div>
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">Müdahale Riski:</span>
                        <span class="font-bold" id="intervention-risk">-</span>
                    </div>
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">Trend Uyumu:</span>
                        <span class="font-bold" id="currency-trend-align">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gelişmiş Göstergeler -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6 mb-6">
            <!-- CCI & MFI Göstergeleri -->
            <div class="glass-card rounded-lg p-4 lg:p-6">
                <h3 class="text-base lg:text-lg font-bold mb-4 text-indigo-400 flex items-center">
                    <i class="fas fa-chart-line mr-2"></i>
                    Gelişmiş Göstergeler
                </h3>
                <div class="space-y-2 lg:space-y-3">
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">CCI:</span>
                        <span class="font-bold" id="cci-value">-</span>
                    </div>
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">CCI Sinyal:</span>
                        <span class="font-bold" id="cci-signal">-</span>
                    </div>
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">MFI:</span>
                        <span class="font-bold" id="mfi-value">-</span>
                    </div>
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">MFI Sinyal:</span>
                        <span class="font-bold" id="mfi-signal">-</span>
                    </div>
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">Birleşik Sinyal:</span>
                        <span class="font-bold" id="advanced-signal">-</span>
                    </div>
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">Diverjans:</span>
                        <span class="font-bold" id="divergence">-</span>
                    </div>
                </div>
            </div>

            <!-- Pattern Analizi -->
            <div class="glass-card rounded-lg p-4 lg:p-6">
                <h3 class="text-base lg:text-lg font-bold mb-4 text-purple-400 flex items-center">
                    <i class="fas fa-shapes mr-2"></i>
                    Pattern Tanıma
                </h3>
                <div class="space-y-2 lg:space-y-3">
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">Pattern Bulundu:</span>
                        <span class="font-bold" id="pattern-found">-</span>
                    </div>
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">Pattern Adı:</span>
                        <span class="font-bold" id="pattern-name">-</span>
                    </div>
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">Pattern Sinyal:</span>
                        <span class="font-bold" id="pattern-signal">-</span>
                    </div>
                    <div class="flex justify-between text-sm lg:text-base">
                        <span class="text-gray-400">Pattern Güven:</span>
                        <span class="font-bold" id="pattern-confidence">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Yönetimi -->
        <div class="glass-card rounded-lg p-4 lg:p-6 mb-6">
            <h3 class="text-base lg:text-lg font-bold mb-4 text-orange-400 flex items-center">
                <i class="fas fa-shield-alt mr-2"></i>
                Kelly Criterion Risk Yönetimi
            </h3>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-4">
                <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                    <p class="text-gray-400 text-xs lg:text-sm">Lot Sayısı</p>
                    <p class="text-base lg:text-xl font-bold" id="kelly-lots">-</p>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                    <p class="text-gray-400 text-xs lg:text-sm">Risk %</p>
                    <p class="text-base lg:text-xl font-bold" id="kelly-risk">-</p>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                    <p class="text-gray-400 text-xs lg:text-sm">Ayarlı Güven</p>
                    <p class="text-base lg:text-xl font-bold" id="adjusted-confidence">-</p>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                    <p class="text-gray-400 text-xs lg:text-sm">Volatilite %</p>
                    <p class="text-base lg:text-xl font-bold" id="market-volatility">-</p>
                </div>
            </div>
        </div>

        <!-- Market Regime Detection -->
        <div class="market-regime-widget mb-6">
            <div class="regime-header">
                <h2 class="regime-title">
                    <i class="fas fa-brain text-purple-400"></i>
                    Market Rejim Analizi
                </h2>
                <div class="regime-status active" id="analysis-regime-status">Yükleniyor...</div>
            </div>
            
            <!-- Transition Alert -->
            <div id="analysis-transition-alert" class="transition-alert" style="display: none;"></div>
            
            <!-- Detailed Regime Analysis -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
                <!-- Volatilite Detay -->
                <div class="regime-indicator">
                    <div class="regime-indicator-icon">
                        <i class="fas fa-wave-square text-cyan-400"></i>
                    </div>
                    <div class="regime-indicator-label">Volatilite Rejimi</div>
                    <div class="regime-indicator-value" id="analysis-volatility-level">-</div>
                    <div class="regime-indicator-desc" id="analysis-volatility-desc">Yükleniyor...</div>
                    <svg class="regime-gauge" id="analysis-volatility-gauge" width="120" height="120">
                    </svg>
                </div>
                
                <!-- Trend Detay -->
                <div class="regime-indicator">
                    <div class="regime-indicator-icon">
                        <i class="fas fa-chart-line text-green-400"></i>
                    </div>
                    <div class="regime-indicator-label">Trend Rejimi</div>
                    <div class="regime-indicator-value" id="analysis-trend-type">-</div>
                    <div class="regime-indicator-desc" id="analysis-trend-desc">Yükleniyor...</div>
                    <svg class="regime-gauge" id="analysis-trend-gauge" width="120" height="120">
                    </svg>
                </div>
                
                <!-- Momentum Detay -->
                <div class="regime-indicator">
                    <div class="regime-indicator-icon">
                        <i class="fas fa-tachometer-alt text-orange-400"></i>
                    </div>
                    <div class="regime-indicator-label">Momentum Rejimi</div>
                    <div class="regime-indicator-value" id="analysis-momentum-state">-</div>
                    <div class="regime-indicator-desc" id="analysis-momentum-desc">Yükleniyor...</div>
                    <svg class="regime-gauge" id="analysis-momentum-gauge" width="120" height="120">
                    </svg>
                </div>
            </div>
            
            <!-- Regime Alerts -->
            <div id="analysis-regime-alerts" class="regime-alerts" style="display: none;"></div>
            
            <!-- Regime History Chart -->
            <div class="regime-history-container">
                <div class="regime-history-header">
                    <h4 class="text-sm font-semibold text-yellow-400 mb-2">
                        <i class="fas fa-history mr-2"></i>
                        Rejim Geçmişi
                    </h4>
                    <div class="regime-history-controls">
                        <button class="regime-history-btn active" data-period="6">6 Saat</button>
                        <button class="regime-history-btn" data-period="12">12 Saat</button>
                        <button class="regime-history-btn" data-period="24">24 Saat</button>
                        <button class="regime-history-btn" data-period="48">48 Saat</button>
                    </div>
                </div>
                <div style="position: relative; height: 200px;">
                    <canvas id="analysis-regime-history-chart"></canvas>
                </div>
            </div>
            
            <!-- Detailed Adaptive Parameters -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
                <div class="adaptive-params">
                    <h4>
                        <i class="fas fa-cogs mr-2"></i>
                        RSI Adaptive Parametreler
                    </h4>
                    <div id="analysis-rsi-params" class="params-grid">
                        <div class="param-item">
                            <span class="param-label">Aşırı Alım</span>
                            <span class="param-value" id="analysis-rsi-overbought">-</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">Aşırı Satım</span>
                            <span class="param-value" id="analysis-rsi-oversold">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="adaptive-params">
                    <h4>
                        <i class="fas fa-sliders-h mr-2"></i>
                        Risk Yönetimi Parametreleri
                    </h4>
                    <div id="analysis-risk-params" class="params-grid">
                        <div class="param-item">
                            <span class="param-label">Stop Loss Çarpan</span>
                            <span class="param-value" id="analysis-stop-multiplier">-</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">Take Profit Çarpan</span>
                            <span class="param-value" id="analysis-tp-multiplier">-</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">Pozisyon Ayarı</span>
                            <span class="param-value" id="analysis-position-adjustment">-</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">Sinyal Eşiği</span>
                            <span class="param-value" id="analysis-signal-threshold">-</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Regime Recommendations -->
            <div class="mt-4 pt-4 border-t border-gray-600">
                <h4 class="font-semibold mb-2 text-sm lg:text-base flex items-center">
                    <i class="fas fa-lightbulb mr-2 text-yellow-400"></i>
                    Rejim Bazlı Öneriler
                </h4>
                <div id="analysis-regime-recommendations" class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                    <div class="bg-slate-800/50 rounded-lg p-3">
                        <div class="text-xs text-gray-400 mb-1">Strateji</div>
                        <div class="text-sm font-semibold" id="analysis-strategy-recommendation">Yükleniyor...</div>
                    </div>
                    <div class="bg-slate-800/50 rounded-lg p-3">
                        <div class="text-xs text-gray-400 mb-1">Pozisyon Boyutu</div>
                        <div class="text-sm font-semibold" id="analysis-position-recommendation">Yükleniyor...</div>
                    </div>
                    <div class="bg-slate-800/50 rounded-lg p-3">
                        <div class="text-xs text-gray-400 mb-1">Zaman Ufku</div>
                        <div class="text-sm font-semibold" id="analysis-timeframe-recommendation">Yükleniyor...</div>
                    </div>
                    <div class="bg-slate-800/50 rounded-lg p-3">
                        <div class="text-xs text-gray-400 mb-1">Piyasa Fazı</div>
                        <div class="text-sm font-semibold" id="analysis-phase-recommendation">Yükleniyor...</div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="text-xs text-gray-400 mb-1">Uyarılar ve Fırsatlar</div>
                    <div id="analysis-warnings-opportunities" class="text-xs text-gray-300 bg-slate-800/30 rounded p-2">
                        Yükleniyor...
                    </div>
                </div>
            </div>
        </div>

        <!-- Fibonacci Retracement Analysis -->
        <div id="fibonacci" class="fibonacci-widget mb-8">
            <div class="fibonacci-widget-header">
                <h2 class="text-xl font-bold">
                    <i class="fas fa-chart-line text-yellow-400"></i>
                    Fibonacci Retracement Analizi
                </h2>
                <button id="refresh-detailed-fibonacci" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                    <i class="fas fa-sync-alt mr-1"></i>
                    Yenile
                </button>
            </div>
            
            <!-- Fibonacci Overview -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
                <div class="text-center p-4 bg-slate-800/50 rounded-lg">
                    <div class="text-2xl font-bold text-yellow-400 mb-2" id="analysis-fibonacci-bounce">0%</div>
                    <div class="text-sm text-gray-400">Bounce Potansiyeli</div>
                </div>
                <div class="text-center p-4 bg-slate-800/50 rounded-lg">
                    <div class="text-xl font-bold mb-2" id="analysis-fibonacci-trend">-</div>
                    <div class="text-sm text-gray-400">Trend Yönü</div>
                </div>
                <div class="text-center p-4 bg-slate-800/50 rounded-lg">
                    <div class="text-xl font-bold text-green-400 mb-2" id="analysis-swing-range">-</div>
                    <div class="text-sm text-gray-400">Swing Range</div>
                </div>
            </div>
            
            <!-- Current Position -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3 text-yellow-400">
                    <i class="fas fa-crosshairs mr-2"></i>
                    Mevcut Pozisyon
                </h3>
                <div id="current-fibonacci-position" class="bg-slate-800/30 rounded-lg p-4">
                    <div class="text-gray-400 text-sm text-center py-4">Yükleniyor...</div>
                </div>
            </div>
            
            <!-- Fibonacci Levels Table -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3 text-blue-400">
                    <i class="fas fa-layer-group mr-2"></i>
                    Fibonacci Seviyeleri
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-600">
                                <th class="text-left py-2">Seviye</th>
                                <th class="text-left py-2">Fiyat</th>
                                <th class="text-left py-2">Mesafe</th>
                                <th class="text-left py-2">Güç</th>
                                <th class="text-left py-2">Açıklama</th>
                                <th class="text-left py-2">Durum</th>
                            </tr>
                        </thead>
                        <tbody id="fibonacci-levels-table">
                            <tr>
                                <td colspan="6" class="text-center py-8 text-gray-400">
                                    <div class="fib-smc-loading">
                                        <div class="fib-smc-spinner"></div>
                                        Yükleniyor...
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Fibonacci Chart -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3 text-purple-400">
                    <i class="fas fa-chart-area mr-2"></i>
                    Fibonacci Grafik Overlay
                </h3>
                <div class="fib-smc-chart-overlay bg-slate-800/30 rounded-lg" style="height: 300px;">
                    <canvas id="fibonacci-overlay-chart"></canvas>
                </div>
            </div>
            
            <!-- Trading Signals -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3 text-green-400">
                    <i class="fas fa-signal mr-2"></i>
                    Trading Sinyalleri
                </h3>
                <div id="fibonacci-signals" class="space-y-3">
                    <div class="text-gray-400 text-sm text-center py-4">Yükleniyor...</div>
                </div>
            </div>
        </div>

        <!-- Smart Money Concepts Analysis -->
        <div id="smc" class="smc-widget mb-8">
            <div class="smc-widget-header">
                <h2 class="text-xl font-bold">
                    <i class="fas fa-brain text-purple-400"></i>
                    Smart Money Concepts Analizi
                </h2>
                <button id="refresh-detailed-smc" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                    <i class="fas fa-sync-alt mr-1"></i>
                    Yenile
                </button>
            </div>
            
            <!-- SMC Overview -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
                <div class="text-center p-4 bg-slate-800/50 rounded-lg">
                    <div class="text-2xl font-bold text-purple-400 mb-2" id="analysis-smc-order-blocks">0</div>
                    <div class="text-sm text-gray-400">Order Blocks</div>
                </div>
                <div class="text-center p-4 bg-slate-800/50 rounded-lg">
                    <div class="text-2xl font-bold text-green-400 mb-2" id="analysis-smc-fvgs">0</div>
                    <div class="text-sm text-gray-400">Fair Value Gaps</div>
                </div>
                <div class="text-center p-4 bg-slate-800/50 rounded-lg">
                    <div class="text-xl font-bold mb-2" id="analysis-smc-structure">-</div>
                    <div class="text-sm text-gray-400">Market Structure</div>
                </div>
                <div class="text-center p-4 bg-slate-800/50 rounded-lg">
                    <div class="text-2xl font-bold text-orange-400 mb-2" id="analysis-smc-liquidity">0</div>
                    <div class="text-sm text-gray-400">Liquidity Zones</div>
                </div>
            </div>
            
            <!-- Market Structure Detail -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="market-structure">
                    <h3 class="text-lg font-semibold mb-3 text-indigo-400">
                        <i class="fas fa-sitemap mr-2"></i>
                        Market Structure
                    </h3>
                    <div class="structure-trend mb-4">
                        <div class="structure-trend-label">Mevcut Trend</div>
                        <div class="structure-trend-value" id="analysis-market-structure-trend">-</div>
                    </div>
                    <div class="structure-metrics">
                        <div class="structure-metric">
                            <div class="structure-metric-label">Higher Highs</div>
                            <div class="structure-metric-value" id="analysis-higher-highs">-</div>
                        </div>
                        <div class="structure-metric">
                            <div class="structure-metric-label">Higher Lows</div>
                            <div class="structure-metric-value" id="analysis-higher-lows">-</div>
                        </div>
                        <div class="structure-metric">
                            <div class="structure-metric-label">Lower Highs</div>
                            <div class="structure-metric-value" id="analysis-lower-highs">-</div>
                        </div>
                        <div class="structure-metric">
                            <div class="structure-metric-label">Lower Lows</div>
                            <div class="structure-metric-value" id="analysis-lower-lows">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- BOS & CHoCH Levels -->
                <div class="bg-slate-800/30 rounded-lg p-4">
                    <h3 class="text-lg font-semibold mb-3 text-red-400">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Kritik Seviyeler
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center py-2 border-b border-gray-700">
                            <span class="text-sm text-gray-400">BOS Level</span>
                            <span class="font-semibold" id="analysis-bos-level">-</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-700">
                            <span class="text-sm text-gray-400">BOS Status</span>
                            <span class="font-semibold" id="analysis-bos-status">-</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-700">
                            <span class="text-sm text-gray-400">CHoCH Level</span>
                            <span class="font-semibold" id="analysis-choch-level">-</span>
                        </div>
                        <div class="flex justify-between items-center py-2">
                            <span class="text-sm text-gray-400">CHoCH Status</span>
                            <span class="font-semibold" id="analysis-choch-status">-</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Order Blocks -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3 text-cyan-400">
                    <i class="fas fa-cube mr-2"></i>
                    Order Blocks
                </h3>
                <div id="analysis-order-blocks" class="order-blocks">
                    <div class="fib-smc-loading">
                        <div class="fib-smc-spinner"></div>
                        Yükleniyor...
                    </div>
                </div>
            </div>
            
            <!-- Fair Value Gaps -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3 text-emerald-400">
                    <i class="fas fa-gap mr-2"></i>
                    Fair Value Gaps
                </h3>
                <div id="analysis-fair-value-gaps" class="fvg-list">
                    <div class="fib-smc-loading">
                        <div class="fib-smc-spinner"></div>
                        Yükleniyor...
                    </div>
                </div>
            </div>
            
            <!-- Liquidity Zones -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3 text-amber-400">
                    <i class="fas fa-water mr-2"></i>
                    Liquidity Zones
                </h3>
                <div id="analysis-liquidity-zones" class="liquidity-zones">
                    <div class="fib-smc-loading">
                        <div class="fib-smc-spinner"></div>
                        Yükleniyor...
                    </div>
                </div>
            </div>
            
            <!-- SMC Signals -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3 text-green-400">
                    <i class="fas fa-brain mr-2"></i>
                    Smart Money Sinyalleri
                </h3>
                <div id="smc-signals" class="bg-slate-800/30 rounded-lg p-4">
                    <div class="text-gray-400 text-sm text-center py-4">Yükleniyor...</div>
                </div>
            </div>
        </div>

        <!-- Detaylı Göstergeler -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6 mb-6">
            <!-- Teknik Göstergeler -->
            <div class="glass-card rounded-lg p-4 lg:p-6">
                <h3 class="text-base lg:text-lg font-bold mb-4 text-blue-400 flex items-center">
                    <i class="fas fa-chart-line mr-2"></i>
                    Teknik Göstergeler
                </h3>
                <div class="grid grid-cols-2 gap-3" id="technical-indicators">
                    <div class="bg-slate-800/50 rounded-lg p-3">
                        <p class="text-xs text-gray-400">RSI</p>
                        <p class="text-lg font-bold" id="rsi-value">-</p>
                        <p class="text-xs" id="rsi-signal">-</p>
                    </div>
                    <div class="bg-slate-800/50 rounded-lg p-3">
                        <p class="text-xs text-gray-400">MACD</p>
                        <p class="text-lg font-bold" id="macd-value">-</p>
                        <p class="text-xs" id="macd-trend">-</p>
                    </div>
                    <div class="bg-slate-800/50 rounded-lg p-3">
                        <p class="text-xs text-gray-400">Stochastic</p>
                        <p class="text-lg font-bold" id="stoch-value">-</p>
                        <p class="text-xs" id="stoch-zone">-</p>
                    </div>
                    <div class="bg-slate-800/50 rounded-lg p-3">
                        <p class="text-xs text-gray-400">ATR</p>
                        <p class="text-lg font-bold" id="atr-value">-</p>
                        <p class="text-xs" id="atr-volatility">-</p>
                    </div>
                </div>
            </div>

            <!-- Bollinger & Pattern -->
            <div class="glass-card rounded-lg p-4 lg:p-6">
                <h3 class="text-base lg:text-lg font-bold mb-4 text-purple-400 flex items-center">
                    <i class="fas fa-layer-group mr-2"></i>
                    Bollinger & Pattern
                </h3>
                <div class="space-y-3">
                    <div class="bg-slate-800/50 rounded-lg p-3">
                        <p class="text-xs text-gray-400">Bollinger Position</p>
                        <p class="text-lg font-bold" id="bb-position">-</p>
                        <p class="text-xs" id="bb-signal">-</p>
                    </div>
                    <div class="bg-slate-800/50 rounded-lg p-3">
                        <p class="text-xs text-gray-400">Pattern</p>
                        <p class="text-sm font-bold" id="pattern-name">-</p>
                        <p class="text-xs" id="pattern-confidence">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Support/Resistance Levels -->
        <div class="glass-card rounded-lg p-4 lg:p-6 mb-6">
            <h3 class="text-base lg:text-lg font-bold mb-4 text-orange-400 flex items-center">
                <i class="fas fa-layer-group mr-2"></i>
                Destek/Direnç Seviyeleri
            </h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div>
                    <h4 class="text-sm font-semibold text-green-400 mb-2">Destek Seviyeleri</h4>
                    <div id="support-levels" class="space-y-2">
                        <!-- Dinamik olarak doldurulacak -->
                    </div>
                </div>
                <div>
                    <h4 class="text-sm font-semibold text-red-400 mb-2">Direnç Seviyeleri</h4>
                    <div id="resistance-levels" class="space-y-2">
                        <!-- Dinamik olarak doldurulacak -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Hibrit Analiz Geçmişi -->
        <div class="glass-card rounded-lg p-4 lg:p-6">
            <div class="flex flex-wrap items-center justify-between mb-4">
                <h3 class="text-lg lg:text-xl font-bold flex items-center">
                    <i class="fas fa-history mr-2 text-purple-400"></i>
                    Hibrit Analiz Geçmişi
                </h3>
                <div class="flex items-center gap-2 text-xs mt-2 lg:mt-0">
                    <span class="text-gray-400">Renk kodları:</span>
                    <span class="px-2 py-1 rounded tf-badge-15m font-semibold">15D</span>
                    <span class="px-2 py-1 rounded tf-badge-1h font-semibold">1S</span>
                    <span class="px-2 py-1 rounded tf-badge-4h font-semibold">4S</span>
                    <span class="px-2 py-1 rounded tf-badge-1d font-semibold">1G</span>
                </div>
            </div>
            
            <!-- Filtreleme Alanı -->
            <div class="mb-4 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-3">
                <!-- Tarih Aralığı -->
                <div>
                    <label class="text-xs text-gray-400 mb-1 block">Başlangıç</label>
                    <input type="datetime-local" id="start-date" class="w-full bg-slate-700 text-white px-3 py-2 rounded text-sm">
                </div>
                <div>
                    <label class="text-xs text-gray-400 mb-1 block">Bitiş</label>
                    <input type="datetime-local" id="end-date" class="w-full bg-slate-700 text-white px-3 py-2 rounded text-sm">
                </div>
                
                <!-- Sinyal Tipi Filtresi -->
                <div>
                    <label class="text-xs text-gray-400 mb-1 block">Sinyal Tipi</label>
                    <select id="signal-filter" class="w-full bg-slate-700 text-white px-3 py-2 rounded text-sm">
                        <option value="">Tümü</option>
                        <option value="BUY">Alış</option>
                        <option value="SELL">Satış</option>
                        <option value="HOLD">Bekle</option>
                    </select>
                </div>
                
                <!-- Filtre Butonları -->
                <div class="flex items-end gap-2">
                    <button onclick="applyFilters()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm transition">
                        <i class="fas fa-filter mr-1"></i> Filtrele
                    </button>
                    <button onclick="resetFilters()" class="bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded text-sm transition">
                        <i class="fas fa-undo mr-1"></i> Sıfırla
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-xs lg:text-sm">
                    <thead>
                        <tr class="border-b border-gray-700">
                            <th class="text-left py-1 lg:py-2 hidden lg:table-cell">Zaman</th>
                            <th class="text-left py-1 lg:py-2">TF</th>
                            <th class="text-left py-1 lg:py-2">Fiyat</th>
                            <th class="text-left py-1 lg:py-2">Sinyal</th>
                            <th class="text-left py-1 lg:py-2 hidden sm:table-cell">Güç</th>
                            <th class="text-left py-1 lg:py-2">Güven</th>
                            <th class="text-left py-1 lg:py-2 hidden md:table-cell">RSI</th>
                            <th class="text-left py-1 lg:py-2 hidden md:table-cell">Trend</th>
                            <th class="text-left py-1 lg:py-2 hidden md:table-cell">Global</th>
                            <th class="text-left py-1 lg:py-2 hidden md:table-cell">Risk</th>
                            <th class="text-left py-1 lg:py-2 hidden lg:table-cell">R/R</th>
                        </tr>
                    </thead>
                    <tbody id="hybrid-analysis-history">
                        <tr>
                            <td colspan="11" class="text-center py-4 text-gray-400 text-sm">
                                Yükleniyor...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Sayfalama -->
            <div class="mt-4 flex flex-col sm:flex-row items-center justify-between gap-4">
                <div class="text-sm text-gray-400">
                    <span id="showing-info">1-20 arası gösteriliyor</span>
                    <span id="total-count" class="ml-2"></span>
                </div>
                <div class="flex items-center gap-2">
                    <button id="prev-page" onclick="changePage(-1)" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded text-sm transition disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="page-info" class="text-sm">Sayfa 1</span>
                    <button id="next-page" onclick="changePage(1)" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded text-sm transition disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-xs text-gray-400">Sayfa başına:</label>
                    <select id="per-page" onchange="changePerPage()" class="bg-slate-700 text-white px-2 py-1 rounded text-sm">
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // Sayfalama değişkenleri
        let currentPage = 1;
        let perPage = 20;
        let totalAnalyses = 0;
        let allAnalysisData = [];
        
        // Tarih formatı düzeltme (local datetime-local input için)
        function formatDateForInput(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const hours = String(d.getHours()).padStart(2, '0');
            const minutes = String(d.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        // Sayfa yüklendiğinde varsayılan tarih aralığını ayarla
        window.addEventListener('DOMContentLoaded', function() {
            // Son 24 saat
            const now = new Date();
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            
            document.getElementById('start-date').value = formatDateForInput(yesterday);
            document.getElementById('end-date').value = formatDateForInput(now);
        });
        
        // RSI renk fonksiyonu
        function getRSIColor(rsi) {
            if (!rsi) return '';
            if (rsi > 70) return 'text-red-400';  // Aşırı alım
            if (rsi < 30) return 'text-green-400'; // Aşırı satım
            if (rsi > 60) return 'text-orange-400'; // Yüksek
            if (rsi < 40) return 'text-blue-400';   // Düşük
            return 'text-gray-400'; // Normal
        }
        
        // Hibrit analiz verilerini yükle
        async function loadHybridAnalysisData() {
            try {
                // URL parametrelerini oluştur
                const params = new URLSearchParams();
                
                // Temel parametreler
                params.append('page', currentPage);
                params.append('per_page', perPage);
                
                // Filtreler
                const timeframe = document.getElementById('timeframe-selector').value;
                if (timeframe) params.append('timeframe', timeframe);
                
                const startDate = document.getElementById('start-date').value;
                if (startDate) params.append('start_date', new Date(startDate).toISOString());
                
                const endDate = document.getElementById('end-date').value;
                if (endDate) params.append('end_date', new Date(endDate).toISOString());
                
                const signalType = document.getElementById('signal-filter').value;
                if (signalType) params.append('signal_type', signalType);
                
                // API çağrıları
                const historyUrl = `/api/analysis/history?${params.toString()}`;
                const detailsUrl = timeframe ? `/api/analysis/details?timeframe=${timeframe}` : '/api/analysis/details';
                
                const [historyResponse, detailsResponse] = await Promise.all([
                    fetch(historyUrl),
                    fetch(detailsUrl)
                ]);
                
                if (!historyResponse.ok || !detailsResponse.ok) {
                    throw new Error('API hatası');
                }
                
                const historyData = await historyResponse.json();
                const detailsData = await detailsResponse.json();
                
                // Veriyi göster
                displayHistoryData(historyData.analyses || []);
                
                // Sayfalama bilgilerini güncelle
                if (historyData.pagination) {
                    totalAnalyses = historyData.pagination.total;
                    updatePaginationInfo();
                }
                
                // En son analizi göster
                if (historyData.analyses && historyData.analyses.length > 0 && currentPage === 1) {
                    updateCurrentAnalysis(historyData.analyses[0]);
                }
                
                // Detaylı göstergeleri yükle
                if (detailsData.analyses && detailsData.analyses.length > 0) {
                    updateDetailedIndicators(detailsData.analyses[0]);
                }
                
                // Aktif pattern'leri yükle
                loadActivePatterns();
                
                // Timeframe bazlı göstergeleri yükle
                if (timeframe) {
                    loadTimeframeIndicators(timeframe);
                }
                
            } catch (error) {
                console.error('Veri yükleme hatası:', error);
            }
        }
        
        // Aktif pattern'leri yükle
        async function loadActivePatterns() {
            try {
                const response = await fetch('/api/analysis/patterns/active');
                const data = await response.json();
                
                if (data.patterns && data.patterns.length > 0) {
                    // Pattern listesini güncelle
                    const patternList = data.patterns.map(pattern => {
                        const confidenceClass = pattern.confidence > 0.8 ? 'text-green-400' :
                                              pattern.confidence > 0.6 ? 'text-yellow-400' : 'text-gray-400';
                        return `
                            <div class="bg-slate-800/50 rounded p-2 mb-2">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold">${pattern.name}</span>
                                    <span class="text-xs bg-slate-700 px-2 py-1 rounded">${pattern.timeframe}</span>
                                </div>
                                <div class="flex justify-between text-xs text-gray-400 mt-1">
                                    <span>Tip: ${pattern.type}</span>
                                    <span class="${confidenceClass}">Güven: %${(pattern.confidence * 100).toFixed(0)}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // Pattern bölümüne ekle (ileride eklenecek)
                }
            } catch (error) {
                console.error('Pattern yükleme hatası:', error);
            }
        }
        
        // Timeframe bazlı göstergeleri yükle
        async function loadTimeframeIndicators(timeframe) {
            try {
                const response = await fetch(`/api/analysis/indicators/${timeframe}`);
                const data = await response.json();
                
                if (!data.error) {
                    // Göstergeleri güncelle
                    console.log('Timeframe göstergeleri:', data);
                }
            } catch (error) {
                console.error('Gösterge yükleme hatası:', error);
            }
        }
        
        // Filtreleri uygula
        function applyFilters() {
            currentPage = 1; // Filtre uygulandığında ilk sayfaya dön
            loadHybridAnalysisData();
        }
        
        // Filtreleri sıfırla
        function resetFilters() {
            const now = new Date();
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            
            document.getElementById('start-date').value = formatDateForInput(yesterday);
            document.getElementById('end-date').value = formatDateForInput(now);
            document.getElementById('signal-filter').value = '';
            document.getElementById('timeframe-selector').value = '';
            
            currentPage = 1;
            loadHybridAnalysisData();
        }
        
        // Sayfa değiştir
        function changePage(direction) {
            const newPage = currentPage + direction;
            const maxPage = Math.ceil(totalAnalyses / perPage);
            
            if (newPage >= 1 && newPage <= maxPage) {
                currentPage = newPage;
                loadHybridAnalysisData();
            }
        }
        
        // Sayfa başına gösterim sayısını değiştir
        function changePerPage() {
            perPage = parseInt(document.getElementById('per-page').value);
            currentPage = 1; // İlk sayfaya dön
            loadHybridAnalysisData();
        }
        
        // Geçmiş verilerini göster
        function displayHistoryData(analyses) {
            try {
                
                if (analyses && analyses.length > 0) {
                    
                    // Analiz geçmişini göster
                    const historyHtml = analyses.map(analysis => {
                        const date = new Date(analysis.timestamp);
                        // Timestamp zaten Türkiye saatinde geliyor, ekleme yapma
                        
                        const timeframeClass = `timeframe-${analysis.timeframe}`;
                        return `
                            <tr class="border-b border-gray-700 ${timeframeClass} transition-colors">
                                <td class="py-1 lg:py-2 text-xs lg:text-sm hidden lg:table-cell">${date.toLocaleTimeString('tr-TR')}</td>
                                <td class="py-1 lg:py-2 text-xs lg:text-sm font-semibold">${analysis.timeframe}</td>
                                <td class="py-1 lg:py-2 text-xs lg:text-sm">₺${analysis.price.toFixed(2)}</td>
                                <td class="py-1 lg:py-2">
                                    <span class="${analysis.signal === 'BUY' ? 'signal-buy' : 
                                                  analysis.signal === 'SELL' ? 'signal-sell' : 
                                                  'signal-hold'} font-bold text-xs lg:text-sm">
                                        ${analysis.signal === 'BUY' ? '🟢' : 
                                          analysis.signal === 'SELL' ? '🔴' : 
                                          '⚪'}
                                        <span class="hidden sm:inline">
                                            ${analysis.signal === 'BUY' ? 'AL' : 
                                              analysis.signal === 'SELL' ? 'SAT' : 
                                              'BEKLE'}
                                        </span>
                                    </span>
                                </td>
                                <td class="py-1 lg:py-2 hidden sm:table-cell">
                                    <span class="${analysis.signal_strength === 'STRONG' ? 'strength-strong' : 
                                                  analysis.signal_strength === 'MODERATE' ? 'strength-moderate' : 
                                                  'strength-weak'} text-xs lg:text-sm">
                                        ${analysis.signal_strength.charAt(0)}
                                    </span>
                                </td>
                                <td class="py-1 lg:py-2 text-xs lg:text-sm">%${(analysis.confidence * 100).toFixed(0)}</td>
                                <td class="py-1 lg:py-2 hidden md:table-cell">
                                    <span class="${getRSIColor(analysis.details?.gram?.rsi || analysis.rsi_value)} text-xs lg:text-sm">
                                        ${analysis.details?.gram?.rsi?.toFixed(0) || analysis.rsi_value?.toFixed(0) || '-'}
                                    </span>
                                </td>
                                <td class="py-1 lg:py-2 hidden md:table-cell">
                                    <span class="${analysis.trend === 'UPTREND' ? 'text-green-400' : 
                                                  analysis.trend === 'DOWNTREND' ? 'text-red-400' : 
                                                  'text-yellow-400'} text-xs lg:text-sm">
                                        ${analysis.trend === 'UPTREND' ? '↑' : 
                                          analysis.trend === 'DOWNTREND' ? '↓' : 
                                          '→'}
                                    </span>
                                </td>
                                <td class="py-1 lg:py-2 hidden md:table-cell">
                                    <span class="${analysis.global_trend === 'BULLISH' ? 'text-green-400' : 
                                                  analysis.global_trend === 'BEARISH' ? 'text-red-400' : 
                                                  'text-yellow-400'} text-xs lg:text-sm">
                                        ${analysis.global_trend === 'BULLISH' ? '📈' : 
                                          analysis.global_trend === 'BEARISH' ? '📉' : 
                                          '➡️'}
                                    </span>
                                </td>
                                <td class="py-1 lg:py-2 hidden md:table-cell">
                                    <span class="${analysis.currency_risk === 'LOW' ? 'text-green-400' : 
                                                  analysis.currency_risk === 'MEDIUM' ? 'text-yellow-400' : 
                                                  analysis.currency_risk === 'HIGH' ? 'text-red-400' : 
                                                  'text-red-600'} text-xs lg:text-sm">
                                        ${analysis.currency_risk === 'LOW' ? 'L' : 
                                          analysis.currency_risk === 'MEDIUM' ? 'M' : 
                                          analysis.currency_risk === 'HIGH' ? 'H' : 'X'}
                                    </span>
                                </td>
                                <td class="py-1 lg:py-2 text-xs lg:text-sm hidden lg:table-cell">${analysis.risk_reward_ratio ? analysis.risk_reward_ratio.toFixed(1) : '-'}</td>
                            </tr>
                        `;
                    }).join('');
                    
                    document.getElementById('hybrid-analysis-history').innerHTML = historyHtml;
                } else {
                    document.getElementById('hybrid-analysis-history').innerHTML = 
                        '<tr><td colspan="11" class="text-center py-4 text-gray-400">Henüz hibrit analiz yok</td></tr>';
                }
                
                // Son analiz zamanı
                document.getElementById('last-analysis-time').textContent = 
                    new Date().toLocaleTimeString('tr-TR');
                    
            } catch (error) {
                console.error('Hibrit analiz verileri yüklenemedi:', error);
                document.getElementById('hybrid-analysis-history').innerHTML = 
                    '<tr><td colspan="11" class="text-center py-4 text-red-400">Yüklenemedi</td></tr>';
            }
        }

        // Mevcut analizi güncelle
        function updateCurrentAnalysis(analysis) {
            // Ana metrikler
            const signalClass = analysis.signal === 'BUY' ? 'signal-buy' : 
                               analysis.signal === 'SELL' ? 'signal-sell' : 'signal-hold';
            const signalText = analysis.signal === 'BUY' ? '🟢 ALIŞ' : 
                              analysis.signal === 'SELL' ? '🔴 SATIŞ' : '⚪ BEKLE';
            
            document.getElementById('current-signal').className = `text-xl lg:text-3xl font-bold ${signalClass}`;
            document.getElementById('current-signal').textContent = signalText;
            document.getElementById('current-confidence').textContent = `%${(analysis.confidence * 100).toFixed(0)}`;
            document.getElementById('current-position').textContent = `%${(analysis.position_size * 100).toFixed(0)}`;
            
            // Global trend
            const globalTrendClass = analysis.global_trend === 'BULLISH' ? 'text-green-400' : 
                                   analysis.global_trend === 'BEARISH' ? 'text-red-400' : 'text-yellow-400';
            document.getElementById('current-global-trend').className = `text-base lg:text-xl font-bold ${globalTrendClass}`;
            document.getElementById('current-global-trend').textContent = 
                `${analysis.global_trend} (${analysis.global_trend_strength})`;
            
            // Kur riski
            const currencyRiskClass = analysis.currency_risk === 'LOW' ? 'text-green-400' : 
                                    analysis.currency_risk === 'MEDIUM' ? 'text-yellow-400' : 
                                    analysis.currency_risk === 'HIGH' ? 'text-red-400' : 'text-red-600';
            document.getElementById('current-currency-risk').className = `text-base lg:text-xl font-bold ${currencyRiskClass}`;
            document.getElementById('current-currency-risk').textContent = analysis.currency_risk;
            
            // Risk/Ödül
            document.getElementById('current-risk-reward').textContent = 
                analysis.risk_reward_ratio ? `1:${analysis.risk_reward_ratio.toFixed(2)}` : '-';
            
            // Özet ve öneriler
            document.getElementById('current-summary').textContent = analysis.summary;
            
            if (analysis.recommendations && analysis.recommendations.length > 0) {
                const recommendationsHtml = analysis.recommendations.map(rec => 
                    `<li class="mb-1">• ${rec}</li>`
                ).join('');
                document.getElementById('current-recommendations').innerHTML = recommendationsHtml;
            } else {
                document.getElementById('current-recommendations').innerHTML = '<li>Öneri yok</li>';
            }
            
            // Detay analizleri
            if (analysis.details) {
                updateDetailedAnalysis(analysis.details);
            }
            
            // Stop loss ve take profit
            document.getElementById('gram-stop-loss').textContent = 
                analysis.stop_loss ? `₺${analysis.stop_loss.toFixed(2)}` : '-';
            document.getElementById('gram-take-profit').textContent = 
                analysis.take_profit ? `₺${analysis.take_profit.toFixed(2)}` : '-';
            
            // Gram altın fiyatı
            document.getElementById('gram-price').textContent = `₺${analysis.price.toFixed(2)}`;
            
            // Yeni göstergeler - Advanced Indicators
            if (analysis.details && analysis.details.advanced_indicators) {
                const adv = analysis.details.advanced_indicators;
                document.getElementById('cci-value').textContent = adv.cci !== null ? adv.cci.toFixed(2) : '-';
                document.getElementById('cci-signal').textContent = adv.cci_signal || '-';
                document.getElementById('mfi-value').textContent = adv.mfi !== null ? adv.mfi.toFixed(2) : '-';
                document.getElementById('mfi-signal').textContent = adv.mfi_signal || '-';
                document.getElementById('advanced-signal').textContent = adv.combined_signal || '-';
                document.getElementById('divergence').textContent = adv.divergence ? 'Var' : 'Yok';
            }
            
            // Pattern tanıma
            if (analysis.details && analysis.details.pattern) {
                const pattern = analysis.details.pattern;
                document.getElementById('pattern-found').textContent = pattern.found ? 'Evet' : 'Hayır';
                document.getElementById('pattern-name').textContent = pattern.name || '-';
                document.getElementById('pattern-signal').textContent = pattern.signal || '-';
                document.getElementById('pattern-confidence').textContent = 
                    pattern.confidence ? `%${(pattern.confidence * 100).toFixed(0)}` : '-';
            }
            
            // Kelly Criterion Risk Yönetimi
            if (analysis.position_details) {
                const pos = analysis.position_details;
                document.getElementById('kelly-lots').textContent = pos.lots || '-';
                document.getElementById('kelly-risk').textContent = 
                    pos.risk_percentage ? `%${pos.risk_percentage.toFixed(1)}` : '-';
                document.getElementById('adjusted-confidence').textContent = 
                    pos.adjusted_confidence ? `%${(pos.adjusted_confidence * 100).toFixed(0)}` : '-';
                document.getElementById('market-volatility').textContent = 
                    pos.market_volatility ? `%${pos.market_volatility.toFixed(1)}` : '-';
            }
        }

        // Detaylı göstergeleri güncelle
        function updateDetailedIndicators(analysis) {
            try {
                const gramAnalysis = analysis.gram_analysis || {};
                const indicators = gramAnalysis.indicators || {};
                const patterns = gramAnalysis.patterns || [];
                const supportLevels = gramAnalysis.support_levels || [];
                const resistanceLevels = gramAnalysis.resistance_levels || [];
                
                // RSI
                if (indicators.rsi !== undefined) {
                    document.getElementById('rsi-value').textContent = indicators.rsi.toFixed(1);
                    document.getElementById('rsi-signal').textContent = indicators.rsi_signal || 'neutral';
                } else {
                    document.getElementById('rsi-value').textContent = '-';
                    document.getElementById('rsi-signal').textContent = '-';
                }
                
                // MACD
                if (indicators.macd) {
                    const macd = indicators.macd;
                    document.getElementById('macd-value').textContent = 
                        macd.macd_line !== null ? macd.macd_line.toFixed(2) : '-';
                    document.getElementById('macd-trend').textContent = macd.trend || '-';
                } else {
                    document.getElementById('macd-value').textContent = '-';
                    document.getElementById('macd-trend').textContent = '-';
                }
                
                // Stochastic
                if (indicators.stochastic) {
                    const stoch = indicators.stochastic;
                    document.getElementById('stoch-value').textContent = 
                        `K:${stoch.k ? stoch.k.toFixed(1) : '-'}`;
                    document.getElementById('stoch-zone').textContent = stoch.zone || '-';
                } else {
                    document.getElementById('stoch-value').textContent = '-';
                    document.getElementById('stoch-zone').textContent = '-';
                }
                
                // ATR
                if (indicators.atr) {
                    const atr = indicators.atr;
                    document.getElementById('atr-value').textContent = 
                        atr.atr ? atr.atr.toFixed(2) : '-';
                    document.getElementById('atr-volatility').textContent = 
                        atr.volatility_level || '-';
                } else {
                    document.getElementById('atr-value').textContent = '-';
                    document.getElementById('atr-volatility').textContent = '-';
                }
                
                // Bollinger Bands
                if (indicators.bollinger) {
                    const bb = indicators.bollinger;
                    document.getElementById('bb-position').textContent = bb.position || '-';
                    document.getElementById('bb-signal').textContent = bb.signal || '-';
                } else {
                    document.getElementById('bb-position').textContent = '-';
                    document.getElementById('bb-signal').textContent = '-';
                }
                
                // Pattern
                if (patterns.length > 0) {
                    const pattern = patterns[0]; // En güvenilir pattern
                    document.getElementById('pattern-name').textContent = pattern.name || '-';
                    document.getElementById('pattern-confidence').textContent = 
                        pattern.confidence ? `%${(pattern.confidence * 100).toFixed(0)}` : '-';
                } else {
                    document.getElementById('pattern-name').textContent = 'Yok';
                    document.getElementById('pattern-confidence').textContent = '-';
                }
                
                // Support Levels
                const supportHtml = supportLevels.slice(0, 5).map(level => 
                    `<div class="bg-slate-800/50 rounded p-2">
                        <span class="text-green-400">₺${level.level.toFixed(2)}</span>
                        <span class="text-xs text-gray-400 ml-2">${level.strength}</span>
                    </div>`
                ).join('');
                document.getElementById('support-levels').innerHTML = 
                    supportHtml || '<div class="text-gray-400 text-sm">Veri yok</div>';
                
                // Resistance Levels
                const resistanceHtml = resistanceLevels.slice(0, 5).map(level => 
                    `<div class="bg-slate-800/50 rounded p-2">
                        <span class="text-red-400">₺${level.level.toFixed(2)}</span>
                        <span class="text-xs text-gray-400 ml-2">${level.strength}</span>
                    </div>`
                ).join('');
                document.getElementById('resistance-levels').innerHTML = 
                    resistanceHtml || '<div class="text-gray-400 text-sm">Veri yok</div>';
                
            } catch (error) {
                console.error('Detaylı gösterge güncellemesi hatası:', error);
            }
        }

        // Detaylı analiz bileşenlerini güncelle
        function updateDetailedAnalysis(details) {
            // Gram altın detayları
            if (details.gram) {
                const gram = details.gram;
                document.getElementById('gram-trend').textContent = gram.trend || '-';
                document.getElementById('gram-rsi').textContent = gram.rsi ? gram.rsi.toFixed(1) : '-';
                document.getElementById('gram-signal').textContent = gram.signal || '-';
            }
            
            // Global trend detayları
            if (details.global) {
                const global = details.global;
                document.getElementById('global-direction').textContent = global.trend_direction || '-';
                document.getElementById('global-strength').textContent = global.trend_strength || '-';
                document.getElementById('global-momentum').textContent = global.momentum?.signal || '-';
                document.getElementById('global-volatility').textContent = global.volatility?.level || '-';
                document.getElementById('global-supportive').textContent = global.supportive ? 'Evet' : 'Hayır';
            }
            
            // Kur riski detayları
            if (details.currency) {
                const currency = details.currency;
                document.getElementById('currency-risk-level').textContent = currency.risk_level || '-';
                document.getElementById('currency-volatility').textContent = currency.volatility?.level || '-';
                document.getElementById('currency-multiplier').textContent = 
                    currency.position_size_multiplier ? `x${currency.position_size_multiplier.toFixed(2)}` : '-';
                document.getElementById('intervention-risk').textContent = 
                    currency.intervention_risk?.has_risk ? 'Var' : 'Yok';
                document.getElementById('currency-trend-align').textContent = 
                    currency.trend_alignment ? 'Uyumlu' : 'Uyumsuz';
            }
        }

        // Sayfalama bilgilerini güncelle
        function updatePaginationInfo() {
            const maxPage = Math.ceil(totalAnalyses / perPage);
            const startItem = totalAnalyses > 0 ? (currentPage - 1) * perPage + 1 : 0;
            const endItem = Math.min(currentPage * perPage, totalAnalyses);
            
            document.getElementById('showing-info').textContent = 
                totalAnalyses > 0 ? `${startItem}-${endItem} arası gösteriliyor` : 'Veri yok';
            document.getElementById('total-count').textContent = `(Toplam: ${totalAnalyses})`;
            document.getElementById('page-info').textContent = `Sayfa ${currentPage} / ${maxPage || 1}`;
            
            // Buton durumları
            document.getElementById('prev-page').disabled = currentPage <= 1;
            document.getElementById('next-page').disabled = currentPage >= maxPage;
        }
        
        // Sayfa yüklendiğinde
        loadHybridAnalysisData();
        
        // Timeframe değişimi
        document.getElementById('timeframe-selector').addEventListener('change', function() {
            currentPage = 1; // İlk sayfaya dön
            loadHybridAnalysisData();
        });
        
        // Her 30 saniyede bir güncelle
        setInterval(loadHybridAnalysisData, 30000);
    </script>
    
    <!-- Advanced Divergence Detection Section -->
    <div id="divergence" class="mt-12 px-4 sm:px-6 lg:px-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold mb-2">
                <i class="fas fa-wave-square text-purple-400 mr-3"></i>
                Advanced Divergence Detection
            </h1>
            <p class="text-gray-400">Çoklu gösterge tabanlı divergence analizi ve confluence scoring sistemi</p>
        </div>

        <!-- Divergence Overview Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Active Divergences Card -->
            <div class="divergence-widget">
                <div class="divergence-widget-header">
                    <h3 class="text-lg font-semibold">
                        <i class="fas fa-signal text-green-400"></i>
                        Aktif Divergence
                    </h3>
                    <div id="analysis-divergence-status" class="divergence-status inactive">Yükleniyor</div>
                </div>
                <div class="text-center mt-4">
                    <div class="text-4xl font-bold text-yellow-400 mb-2" id="analysis-active-count">0</div>
                    <div class="text-sm text-gray-400">Toplam Aktif</div>
                </div>
            </div>

            <!-- Class Distribution -->
            <div class="divergence-widget">
                <div class="divergence-widget-header">
                    <h3 class="text-lg font-semibold">
                        <i class="fas fa-layer-group text-blue-400"></i>
                        Sınıf Dağılımı
                    </h3>
                </div>
                <div class="flex justify-center gap-3 mt-4">
                    <div class="text-center">
                        <div class="divergence-class class-a text-lg">
                            A <span id="analysis-class-a">0</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">Güçlü</div>
                    </div>
                    <div class="text-center">
                        <div class="divergence-class class-b text-lg">
                            B <span id="analysis-class-b">0</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">Orta</div>
                    </div>
                    <div class="text-center">
                        <div class="divergence-class class-c text-lg">
                            C <span id="analysis-class-c">0</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">Zayıf</div>
                    </div>
                </div>
            </div>

            <!-- Signal Strength -->
            <div class="divergence-widget">
                <div class="divergence-widget-header">
                    <h3 class="text-lg font-semibold">
                        <i class="fas fa-tachometer-alt text-orange-400"></i>
                        Sinyal Gücü
                    </h3>
                </div>
                <div class="mt-4">
                    <div id="overall-strength-gauge" style="height: 120px;">
                        <!-- Gauge will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Confluence Score -->
            <div class="divergence-widget">
                <div class="divergence-widget-header">
                    <h3 class="text-lg font-semibold">
                        <i class="fas fa-crosshairs text-purple-400"></i>
                        Confluence Score
                    </h3>
                </div>
                <div class="mt-4">
                    <div id="confluence-strength-gauge" style="height: 120px;">
                        <!-- Gauge will be rendered here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Divergence Table -->
        <div class="divergence-widget mb-8">
            <div class="divergence-widget-header">
                <h2 class="text-xl font-bold">
                    <i class="fas fa-table text-indigo-400"></i>
                    Detaylı Divergence Tablosu
                </h2>
                <button id="refresh-detailed-divergence" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                    <i class="fas fa-sync-alt mr-1"></i>
                    Yenile
                </button>
            </div>
            
            <div class="overflow-x-auto mt-4">
                <table id="detailed-divergence-table" class="divergence-table w-full">
                    <thead>
                        <tr class="border-b border-gray-600">
                            <th class="text-left">#</th>
                            <th class="text-left">Tür</th>
                            <th class="text-left">Gösterge</th>
                            <th class="text-left">Sınıf</th>
                            <th class="text-left">Güç</th>
                            <th class="text-left">Olgunluk</th>
                            <th class="text-left">Başarı Oranı</th>
                            <th class="text-left">Açı Farkı</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="8" class="text-center py-8 text-gray-400">
                                <div class="divergence-loading">
                                    <div class="loading-spinner"></div>
                                    Yükleniyor...
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Target and Invalidation Levels -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Target Levels -->
            <div class="divergence-widget">
                <div class="divergence-widget-header">
                    <h3 class="text-lg font-semibold target-levels">
                        <i class="fas fa-bullseye text-green-400"></i>
                        Hedef Seviyeleri
                    </h3>
                </div>
                <div class="price-level-group target-levels mt-4">
                    <div id="target-levels" class="space-y-2">
                        <div class="text-gray-400 text-sm text-center py-4">Yükleniyor...</div>
                    </div>
                </div>
            </div>

            <!-- Invalidation Levels -->
            <div class="divergence-widget">
                <div class="divergence-widget-header">
                    <h3 class="text-lg font-semibold invalidation-levels">
                        <i class="fas fa-times-circle text-red-400"></i>
                        Geçersizleştirici Seviyeler
                    </h3>
                </div>
                <div class="price-level-group invalidation-levels mt-4">
                    <div id="invalidation-levels" class="space-y-2">
                        <div class="text-gray-400 text-sm text-center py-4">Yükleniyor...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Historical Success Rate Chart -->
        <div class="divergence-widget mb-8">
            <div class="divergence-widget-header">
                <h2 class="text-xl font-bold">
                    <i class="fas fa-chart-area text-cyan-400"></i>
                    Tarihsel Performans
                </h2>
                <div class="flex gap-2">
                    <select id="history-period" class="bg-gray-700 text-white px-3 py-1 rounded text-sm border border-gray-600">
                        <option value="24">24 Saat</option>
                        <option value="48">48 Saat</option>
                        <option value="168">7 Gün</option>
                    </select>
                </div>
            </div>
            
            <div class="divergence-history-chart mt-4">
                <canvas id="divergence-history-chart"></canvas>
            </div>
        </div>

        <!-- Current Divergence Alerts -->
        <div class="divergence-widget">
            <div class="divergence-widget-header">
                <h2 class="text-xl font-bold">
                    <i class="fas fa-bell text-yellow-400"></i>
                    Aktif Uyarılar
                </h2>
                <div id="alert-count-badge" class="bg-red-600 text-white px-2 py-1 rounded-full text-xs">0</div>
            </div>
            
            <div id="analysis-divergence-alerts" class="mt-4 space-y-2">
                <div class="text-gray-400 text-sm text-center py-4">Uyarı yükleniyor...</div>
            </div>
        </div>
    </div>
{% endblock %}